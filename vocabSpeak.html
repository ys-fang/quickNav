<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>英語發音練習</title>
  <!-- 添加 Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- 添加 Papa Parse 用於解析 CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root {
      --primary: #4a6cd6;
      --primary-light: #e0e6f5;
      --success: #64bd63;
      --error: #ff6b6b;
      --background: #f5f7fa;
      --text: #333;
      --text-light: #666;
      --border: #e0e6f5;
    }

    html {
      font-size: 18px !important;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
    }

    body { 
      background: var(--background); 
      line-height: 1 !important;
    }

    .app {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container { 
      width: 100%;
      max-width: 500px;
      background: white; 
      padding: 1.5rem; 
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .header {
      background-color: var(--primary);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      border-radius: 15px 15px 0 0;
      margin-bottom: 1.5rem;
    }

    .header i {
      margin-right: 10px;
    }


    #word { 
      font-size: 2.5rem; 
      text-align: center; 
      margin: 2rem 0; 
      color: var(--primary);
      font-weight: bold;
      transition: color 0.3s ease;
    }

    .progress { 
      text-align: center; 
      margin-bottom: 1rem; 
      color: var(--text-light);
      font-size: 1.2rem;
    }

    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--primary); 
      color: white; 
      padding: 12px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 1rem;
      font-weight: bold;
      margin: 0.5rem;
      transition: background-color 0.2s, transform 0.1s, opacity 0.3s;
    }

    .btn i {
      margin-right: 8px;
    }

    .btn:hover:not(:disabled) {
      background: #3a5cc6;
      transform: translateY(-1px);
    }

    .btn:active:not(:disabled) {
      transform: translateY(1px);
    }

    .btn:disabled { 
      background: var(--primary-light); 
      cursor: not-allowed; 
      opacity: 0.6;
    }

    .message { 
      text-align: center; 
      margin: 1rem 0; 
      min-height: 2rem; 
      color: var(--text);
      font-weight: 400;
      font-size: 0.8em;
      transition: all 0.3s ease;
      padding: 10px;
      border-radius: 8px;
    }

    .success {
      color: var(--success);
      background-color: rgba(100, 189, 99, 0.1);
    }

    .error {
      color: var(--error);
      background-color: rgba(255, 107, 107, 0.1);
    }

    .info {
      color: var(--primary);
      background-color: rgba(74, 108, 214, 0.1);
    }

    .visualizer-container {
      width: 100%;
      height: 80px;
      margin: 1rem 0;
      background: rgba(0,0,0,0.03);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      /* 默認顯示容器但內容透明 */
      visibility: visible;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .visualizer-container.active {
      opacity: 1;
    }

    #visualizer {
      width: 100%;
      height: 100%;
      display: block;
    }

    .volume-info {
      position: absolute;
      top: 5px;
      left: 5px;
      background: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--text);
    }

    .recording-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 12px;
      height: 12px;
      background-color: var(--error);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    .volume-threshold {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: rgba(255,255,255,0.3);
    }

    /* 語音倒數計時器 */
    .speech-timer {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: rgba(74, 108, 214, 0.2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      color: var(--primary);
      opacity: 0.8;
      transition: opacity 0.3s;
      font-weight: bold;
    }

    .timer-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: var(--primary);
      transition: width calc(var(--countdown-seconds, 5) * 1s) linear;
      width: 100%; /* 預設為滿進度 */
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .processing-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .processing-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 90%;
      width: 320px;
      border-left: 4px solid var(--primary);
    }

    .spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 4px solid rgba(74, 108, 214, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .control-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 1rem 0;
    }

    .stop-btn {
      background-color: var(--error);
    }

    .stop-btn:disabled {
      background-color: rgba(255, 107, 107, 0.4);
      opacity: 0.6;
    }

    .recording .btn-record {
      opacity: 0.4;
    }
    
    .recording .stop-btn {
      opacity: 1;
      box-shadow: 0 0 8px rgba(255, 107, 107, 0.6);
    }

    .help-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      text-align: center;
      display: none;
    }

    .help-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 1rem 0;
    }

    .help-btn {
      background: #888;
    }

    .footer-help {
      display: flex;
      justify-content: center;
      margin-top: 1.5rem;
    }
    
    .btn-help {
      background: transparent;
      color: var(--text-light);
      border: 1px solid var(--border);
      font-weight: normal;
      padding: 8px 16px;
      box-shadow: none;
    }
    
    .btn-help:hover:not(:disabled) {
      background: var(--background);
      transform: none;
    }

    #troubleshooting {
      display: none;
      margin: 1rem 0;
      border: 1px solid var(--border);
      padding: 1rem;
      border-radius: 8px;
      background: #f9f9f9;
      text-align: left;
      line-height: normal;
    }

    #troubleshooting h3 {
      margin-top: 0;
      font-size: 1rem;
      color: var(--text);
    }

    #troubleshooting ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
      text-align: left;
      font-size: 0.9rem;
      color: var(--text-light);
    }

    #troubleshooting pre {
      margin: 0.5rem 0;
      background: #f0f0f0;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      overflow-x: auto;
    }

    #fallback { 
      margin-top: 1.5rem; 
      text-align: center; 
      border-top: 1px solid var(--border);
      padding-top: 1rem;
    }

    input[type="text"] { 
      width: 100%; 
      padding: 12px; 
      font-size: 1rem; 
      box-sizing: border-box; 
      margin-bottom: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
    }

    @media (max-width: 480px) {
      .container {
        margin: 0.5rem;
        border-radius: 8px;
      }

      .header {
        font-size: 1.2rem;
        padding: 15px;
      }

      #word {
        font-size: 2rem;
      }

      .btn {
        font-size: 0.9rem;
        padding: 10px 16px;
      }

      .message {
        font-size: 0.9rem;
      }

      .help-section {
        margin-top: 1.5rem;
        padding-top: 1rem;
      }
      
      #troubleshooting {
        margin: 0.75rem 0;
        padding: 0.75rem;
      }

      .help-buttons {
        flex-direction: column;
        align-items: center;
      }
    }

    @media (max-width: 320px) {
      .header {
        font-size: 1rem;
        padding: 12px;
      }

      #word {
        font-size: 1.8rem;
      }

      .btn {
        font-size: 0.8rem;
        padding: 8px 12px;
      }

      .control-buttons {
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="container">
      <div class="header">
        <i class="fas fa-microphone"></i> vocabSpeak
      </div>
      
      <div class="main-content">
        <div class="progress" id="progress">載入中...</div>
        <div id="word">-</div>
        <div class="visualizer-container" id="visualizerContainer">
          <canvas id="visualizer"></canvas>
          <div class="recording-indicator"></div>
        </div>
        <div class="control-buttons">
          <button class="btn" id="btnRecord"><i class="fas fa-microphone"></i>開始錄音</button>
          <button class="btn stop-btn" id="btnStopRecord"><i class="fas fa-stop"></i>停止錄音</button>
        </div>
        <div class="message" id="message"></div>
        <div id="fallback" style="display:none;">
          <p><i class="fas fa-keyboard"></i> 語音辨識不支援，請輸入或使用鍵盤語音輸入：</p>
          <input type="text" id="txtInput" placeholder="輸入單字後按送出">
          <button class="btn" id="btnSubmit"><i class="fas fa-paper-plane"></i>送出</button>
        </div>
      </div>

      <div id="troubleshooting" style="display:none;">
        <h3><i class="fas fa-question-circle"></i> 語音辨識問題解決指南</h3>
        <ul>
          <li>確保允許瀏覽器使用麥克風 (點擊地址欄的鎖頭圖示)</li>
          <li>確認您的網絡連接正常</li>
          <li>檢查麥克風是否正常工作 (可在系統設定中測試)</li>
          <li>嘗試使用 Chrome 或 Edge 瀏覽器</li>
          <li>如所有方法都無效，請使用下方文字輸入功能</li>
        </ul>
        <div style="margin-top:0.75rem; background:#e0f7fa; padding:0.5rem; border-radius:4px; font-size:0.85rem; text-align:left;">
          <p style="margin:0.5rem 0;"><i class="fas fa-info-circle"></i> 首次使用時瀏覽器會顯示安全警告，可點選「進階」→「繼續前往」來繼續操作。</p>
        </div>
        <div class="help-buttons">
          <button id="btnTestMic" class="btn" style="background:var(--success);"><i class="fas fa-microphone"></i>測試麥克風</button>
        </div>
      </div>

      <div class="footer-help">
        <button class="btn btn-help" id="btnHelp"><i class="fas fa-question-circle"></i>疑難排解</button>
      </div>
    </div>
  </div>

  <!-- 處理中覆蓋層 -->
  <div class="processing-overlay" id="processingOverlay">
    <div class="processing-content">
      <div class="spinner"></div>
      <h3 style="margin-bottom: 10px; color: var(--primary);">語音辨識中</h3>
      <p style="margin-bottom: 8px;">正在分析結果，請稍後...</p>
    </div>
  </div>

  <script>
    (() => {
    // ====== 設定 ======
      const CONFIG = {
        SPREADSHEET_ID: '1wSHAL3piJGEJ8EnoyK_W9kkvL42GQYId35UEhMzHTZY',  // 使用預設試算表ID
        GID: '0',  // 工作表ID
        CONFIDENCE_THRESHOLD: 0.6,   // 語音辨識信心值門檻
        SIMILARITY_THRESHOLD: 0.9,   // 字串相似度門檻
        DEFAULT_WORDS: ['apple','banana','orange'], // 預設單字
        COUNTDOWN_SECONDS: 3,         // 倒數計時秒數
        COUNTDOWN_INTERVAL: 100       // 倒數計時更新間隔 (毫秒)
      };

      // 設置CSS變數
      document.documentElement.style.setProperty('--countdown-seconds', CONFIG.COUNTDOWN_SECONDS);

      // ====== DOM 元素 ======
      const DOM = {
        progress: document.getElementById('progress'),
        word: document.getElementById('word'),
        btnRecord: document.getElementById('btnRecord'),
        btnStopRecord: document.getElementById('btnStopRecord'),
        message: document.getElementById('message'),
        fallback: document.getElementById('fallback'),
        txtInput: document.getElementById('txtInput'),
        btnSubmit: document.getElementById('btnSubmit'),
        troubleshooting: document.getElementById('troubleshooting'),
        btnHelp: document.getElementById('btnHelp'),
        btnTestMic: document.getElementById('btnTestMic'),
        visualizer: document.getElementById('visualizer'),
        visualizerContainer: document.getElementById('visualizerContainer'),
        processingOverlay: document.getElementById('processingOverlay'),
        speechTimer: null, // 將在語音識別開始時創建
        timerBar: null, // 將在語音識別開始時創建
        controlButtons: document.querySelector('.control-buttons') // 按鈕容器
      };

    // ====== 全域變數 ======
      const STATE = {
        words: [],
        currentIndex: 0,
        recognition: null,
        audioContext: null,
        analyser: null,
        microphone: null,
        audioStream: null,
        visualizerRunning: false,
        isSpeechEnded: false,  // 新增標記變數，追蹤使用者是否已說完話
        noSpeechTimer: null,
        lastTranscript: '',
        lastConfidence: 0,
        additionalBackupTranscript: '', // 額外的備用識別結果
        countdownInterval: null
      };

      // ====== API 和資料載入 ======
      const API = {
        // 獲取 URL 參數函數
        getQueryParam(name) {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(name);
        },
        
        async loadWords() {
          try {
            // 從URL獲取label參數，用於過濾資料
            const label = this.getQueryParam("label") || "";
            
            // 如果沒有指定label參數，則直接使用預設單字集
            if (!label) {
              STATE.words = CONFIG.DEFAULT_WORDS;
              console.log("未指定標籤，使用預設單字集");
              return true;
            }
            
            // 使用CSV匯出格式獲取Google Sheet資料
            const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}/export?format=csv&gid=${CONFIG.GID}`;
            
            const res = await fetch(spreadsheetUrl);
            if (!res.ok) throw new Error('Network response was not ok');
            const csvText = await res.text();
            if (!csvText.trim()) throw new Error('試算表內容為空');
            
            // 解析CSV
            const result = Papa.parse(csvText, { header: false });
            if (!result.data || result.data.length === 0) throw new Error('解析後的資料為空');
            
            // 取表頭
            const header = result.data.shift();
            if (!header) throw new Error('無法提取表頭，資料格式可能有誤');
            
            // 過濾資料：只保留第一欄(Label)符合的行
            let filteredData = result.data.filter(row => row[0].toLowerCase() === label.toLowerCase());
            
            // 提取單字 (假設單字在第二欄，即index=1)
            STATE.words = filteredData.map(row => (row[1] || "").trim())
                                     .filter(word => word); // 過濾空值
            
            if (STATE.words.length === 0) {
              showMessage('提示：未找到相符的單字，請檢查標籤名稱', 'info');
              // 載入失敗時使用預設列表
              STATE.words = CONFIG.DEFAULT_WORDS;
              return false;
            }
          } catch (err) {
            console.error('載入單字失敗:', err);
            // 載入失敗時使用預設列表
            STATE.words = CONFIG.DEFAULT_WORDS;
            showMessage('無法載入試算表資料，已使用預設單字列表', 'error');
            return false;
          }
          
          if (STATE.words.length === 0) {
            showMessage('單字列表為空！', 'error');
            return false;
          }
          return true;
        }
      };

      // ====== 文字相似度計算 ======
      const TextUtils = {
        // 優化的 Levenshtein 距離計算
        levenshtein(a, b) {
          // 如果兩個字串相同，直接返回 0
          if (a === b) return 0;
          // 如果其中一個字串為空，距離就是另一個字串的長度
          if (a.length === 0) return b.length;
          if (b.length === 0) return a.length;
          
          // 只保留兩行的動態規劃矩陣，節省空間
          let prev = Array(b.length + 1).fill(0);
          let curr = Array(b.length + 1).fill(0);
          
          // 初始化第一行
          for (let j = 0; j <= b.length; j++) prev[j] = j;
          
          // 填充矩陣
          for (let i = 1; i <= a.length; i++) {
            curr[0] = i;
            for (let j = 1; j <= b.length; j++) {
              const cost = a[i-1] === b[j-1] ? 0 : 1;
              curr[j] = Math.min(
                prev[j] + 1,        // 刪除
                curr[j-1] + 1,      // 插入
                prev[j-1] + cost    // 替換
              );
            }
            [prev, curr] = [curr, prev]; // 交換兩行
          }
          
          return prev[b.length];
        },
        
        similarity(a, b) {
          if (!a && !b) return 1;
          if (!a || !b) return 0;
          const dist = this.levenshtein(a, b);
          const maxLen = Math.max(a.length, b.length);
          return maxLen === 0 ? 1 : (maxLen - dist) / maxLen;
        }
      };

      // ====== UI 處理 ======
      const UI = {
        updateProgress() {
          DOM.progress.textContent = `單字 ${STATE.currentIndex+1}/${STATE.words.length}`;
        },
        
        updateWord() {
          DOM.word.textContent = STATE.words[STATE.currentIndex];
        },
        
        reset() {
          showMessage('');
          // 隱藏處理中覆蓋層
          DOM.processingOverlay.style.display = 'none';
        },
        
        enableRecordButton() {
          // 移除錄音狀態類別
          if(DOM.controlButtons) {
            DOM.controlButtons.classList.remove('recording');
          }
          
          // 啟用「開始錄音」按鈕
          DOM.btnRecord.disabled = false;
          DOM.btnRecord.innerHTML = '<i class="fas fa-microphone"></i>開始錄音';
          DOM.btnRecord.style.display = 'inline-flex';
          
          // 禁用「停止錄音」按鈕
          DOM.btnStopRecord.disabled = true;
          DOM.btnStopRecord.style.display = 'inline-flex';
          
          // 確保處理中覆蓋層被隱藏
          DOM.processingOverlay.style.display = 'none';
        },
        
        disableRecordButton() {
          // 添加錄音狀態類別
          if(DOM.controlButtons) {
            DOM.controlButtons.classList.add('recording');
          }
          
          // 禁用「開始錄音」按鈕
          DOM.btnRecord.disabled = true;
          DOM.btnRecord.style.display = 'inline-flex';
          
          // 啟用「停止錄音」按鈕
          DOM.btnStopRecord.disabled = false;
          DOM.btnStopRecord.style.display = 'inline-flex';
        },
        
        completeExercise() {
          DOM.progress.textContent = '完成練習！';
          DOM.word.textContent = 'Good Job 🎉';
          DOM.btnRecord.disabled = true;
          DOM.btnStopRecord.disabled = true;
          // 確保處理中覆蓋層被隱藏
          DOM.processingOverlay.style.display = 'none';
          showMessage('你已正確唸出所有單字！', 'success');
          
          // 1. 停止錄音並釋放麥克風資源
          if (Speech && typeof Speech.stop === 'function') {
            Speech.stop();
          }
          
          // 確保音頻可視化停止並釋放資源
          if (AudioVisualizer && typeof AudioVisualizer.stop === 'function') {
            AudioVisualizer.stop();
          }
          
          // 2. 隱藏控制按鈕
          if (DOM.controlButtons) {
            DOM.controlButtons.style.display = 'none';
          }
          
          // 3. 隱藏視覺化容器
          if (DOM.visualizerContainer) {
            DOM.visualizerContainer.style.display = 'none';
          }
          
          // 4. 創建並顯示「重新練習」按鈕
          this.showRestartButton();
        },
        
        // 新增：顯示重新練習按鈕
        showRestartButton() {
          // 移除可能已存在的按鈕
          const existingRestartBtn = document.getElementById('btnRestart');
          if (existingRestartBtn) {
            existingRestartBtn.remove();
          }
          
          // 創建重新練習按鈕
          const restartBtn = document.createElement('button');
          restartBtn.id = 'btnRestart';
          restartBtn.className = 'btn';
          restartBtn.style.backgroundColor = '#4a6cd6';
          restartBtn.style.marginTop = '20px';
          restartBtn.innerHTML = '<i class="fas fa-redo"></i>重新練習';
          
          // 添加點擊事件（重新載入頁面）
          restartBtn.addEventListener('click', () => {
            restartExercise();
          });
          
          // 將按鈕添加到主容器
          DOM.word.after(restartBtn);
        }
      };

      // ====== 語音辨識處理 ======
      const Speech = {
        init() {
          // 不再在這裡初始化 SpeechRecognition
          // 只設置事件監聽器
          this.setupListeners = this.setupListeners.bind(this);
          return true;
        },
        
        setupListeners() {
          // 注意：這個方法現在將在 start() 中被調用，STATE.recognition 已經初始化
          // 為解決不同瀏覽器語音識別行為不一致的問題，統一使用計時器機制
          let speechTimer = null;
          let noSpeechTimer = null;
          
          // 記錄最後一次語音活動時間
          let lastSpeechActivity = 0;
          
          // 在檢測到語音開始時
          STATE.recognition.onspeechstart = () => {
            console.log('檢測到語音開始');
            lastSpeechActivity = Date.now();
            
            // 清除任何現有的無語音計時器
            if (noSpeechTimer) {
              clearTimeout(noSpeechTimer);
              noSpeechTimer = null;
            }
          };
          
          // 在檢測到語音結束時 - 由於Safari可能不會觸發此事件，我們主要依賴計時器機制，
          // 但仍保留此處理以支持Chrome的原生行為
          STATE.recognition.onspeechend = () => {
            console.log('檢測到語音結束 (Chrome原生事件)');
            lastSpeechActivity = 0; // 重置語音活動時間
          };
          
          STATE.recognition.onresult = (e) => {
            const { transcript, confidence } = e.results[0][0];
            
            // 更新最後語音活動時間
            lastSpeechActivity = Date.now();
            
            // 保存最新的識別結果，以便計時結束時使用
            STATE.lastTranscript = transcript;
            STATE.lastConfidence = confidence;
            
            // 同時保存到備用變量
            if (transcript && transcript.trim() !== '') {
              STATE.additionalBackupTranscript = transcript;
              console.log(`已保存備用識別結果: ${transcript}`);
            }
            
            console.log(`實時識別結果: ${transcript}, 信心值: ${confidence}`);
          };
          
          // 添加onend事件處理器，確保捕獲最終識別結果
          STATE.recognition.onend = () => {
            console.log('語音辨識自然結束');
            // 如果是由倒計時觸發的結束，不需要額外處理
            // 如果在倒計時結束前辨識完成，記錄一下日誌
            if (STATE.countdownInterval) {
              console.log('語音辨識在倒計時結束前自然完成');
            }
          };
          
          STATE.recognition.onerror = (e) => {
            console.error('語音辨識錯誤:', e);

            // 如果是使用者手動停止造成的 'aborted' 錯誤，則不顯示錯誤訊息也不重置UI
            // 因為 Speech.stop() 會處理相關的 UI 更新
            if (e.error === 'aborted') {
                console.log("語音辨識被手動停止 (aborted event)，由 Speech.stop() 處理。");
                // 確保相關資源已釋放，即使 stop() 呼叫中可能有異常
                if (STATE.countdownInterval) {
                  clearInterval(STATE.countdownInterval);
                  STATE.countdownInterval = null;
                }
                AudioVisualizer.stop(); // 確保視覺化停止
                DOM.processingOverlay.style.display = 'none'; // 確保覆蓋層隱藏
                UI.enableRecordButton(); // 確保按鈕啟用
                return; // 不執行後續的錯誤處理
            }
            
            // 清除所有計時器 (如果不是aborted錯誤才需要)
            if (speechTimer) {
              clearInterval(speechTimer);
              speechTimer = null;
            }
            
            if (noSpeechTimer) {
              clearTimeout(noSpeechTimer);
              noSpeechTimer = null;
            }
            
            // 隱藏處理中覆蓋層
            DOM.processingOverlay.style.display = 'none';
            
            // 根據不同錯誤類型提供更具體的訊息和解決方案
            let errorMsg = `辨識錯誤：${e.error}`;
            
            if (e.error === 'network') {
              errorMsg = '網絡連接問題，語音辨識服務無法連接。請確認您的網絡連接正常。';
              
              // 檢查是否在 localhost
              const isLocalhost = window.location.hostname === 'localhost' || 
                                 window.location.hostname === '127.0.0.1';
              
              if (isLocalhost) {
                errorMsg += ' 本地環境(localhost)需要使用 HTTPS 連接才能使用語音辨識功能。';
                // 自動顯示疑難排解指南
                DOM.troubleshooting.style.display = 'block';
                
                // 檢查是否使用了 HTTPS
                if (window.location.protocol !== 'https:') {
                  errorMsg += ' 目前使用的是 HTTP 協議，請嘗試使用 HTTPS。';
                }
              }
              
              // 嘗試在一段時間後自動重試
              setTimeout(() => {
                showMessage('正在嘗試重新連接語音服務...', 'info');
                setTimeout(() => {
                  try {
                    this.start();
                  } catch (err) {
                    UI.enableRecordButton();
                  }
                }, 1000);
              }, 2000);
            } else if (e.error === 'not-allowed' || e.error === 'permission-denied') {
              errorMsg = '無法獲取麥克風權限。請確保您已允許網站使用麥克風，並重新載入頁面。';
              // 轉換到 fallback 模式
              enableFallbackMode();
            } else if (e.error === 'no-speech') {
              errorMsg = '未檢測到語音。請靠近麥克風並清晰地說出單字。';
            } else if (e.error === 'audio-capture') {
              errorMsg = '無法捕獲音頻。請確保您的設備有可用的麥克風。';
              // 轉換到 fallback 模式
              enableFallbackMode();
            } else if (e.error === 'service-not-allowed') {
              errorMsg = '語音服務不可用。請嘗試使用下方輸入框代替。';
              // 啟用 fallback 模式
              enableFallbackMode();
            }
            
            showMessage(errorMsg, 'error');
            UI.enableRecordButton();
          };
        },
        
        start() {
          try {
            // 每次開始錄音時初始化語音識別
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) {
              showMessage('您的瀏覽器不支援語音識別功能，請嘗試使用Chrome或Edge瀏覽器。', 'error');
              enableFallbackMode();
              return false;
            }
            
            // 初始化語音識別
            STATE.recognition = new SR();
            STATE.recognition.lang = 'en-US';
            STATE.recognition.continuous = false;
            STATE.recognition.interimResults = false;
            STATE.recognition.maxAlternatives = 1;
            
            // 設置事件監聽器
            this.setupListeners();
            
            // 重置語音結束標記
            STATE.isSpeechEnded = false;
            
            // 重置上次識別結果
            STATE.lastTranscript = '';
            STATE.lastConfidence = 0;
            STATE.additionalBackupTranscript = ''; // 同時重置備用識別結果
            
            // 在嘗試啟動前顯示說明
            showMessage('清晰念出英文單字...', '');
            
            // 檢查是否在 localhost 環境
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            // 如果是 localhost 環境，給出特別提示
            if (isLocalhost) {
              console.warn('在 localhost 環境中使用語音辨識可能存在兼容性問題');
            }
            
            // 啟動音頻可視化
            AudioVisualizer.start().then(() => {
              // 確保音頻可視化已成功啟動後再創建計時器
              // 創建語音計時器元素
              if (DOM.speechTimer) {
                DOM.speechTimer.remove();
              }
              DOM.speechTimer = document.createElement('div');
              DOM.speechTimer.className = 'speech-timer';
              DOM.speechTimer.textContent = `${CONFIG.COUNTDOWN_SECONDS.toFixed(1)}秒`;
              DOM.visualizerContainer.appendChild(DOM.speechTimer);
              
              // 創建計時條
              if (DOM.timerBar) {
                DOM.timerBar.remove();
              }
              DOM.timerBar = document.createElement('div');
              DOM.timerBar.className = 'timer-bar';
              DOM.timerBar.style.width = '100%';
              DOM.visualizerContainer.appendChild(DOM.timerBar);
              
              // 強制重繪DOM以確保元素顯示
              DOM.visualizerContainer.offsetHeight;
              
              // 設置計時器顯示並開始動畫
              requestAnimationFrame(() => {
                if (DOM.timerBar) {
                  DOM.timerBar.style.width = '0%'; // 從100%減少到0%
                }
                
                // 更新倒數計時
                // 計算總共需要更新幾次 (秒數 * 1000 / 更新間隔)
                const totalSteps = CONFIG.COUNTDOWN_SECONDS * 1000 / CONFIG.COUNTDOWN_INTERVAL;
                let countdown = totalSteps;
                const countdownInterval = setInterval(() => {
                  countdown--;
                  if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    // 時間到，強制結束錄音並進行評估
                    this.processSpeechResult();
                    return;
                  }
                  if (DOM.speechTimer) {
                    // 計算並顯示當前剩餘秒數 (當前步數 * 更新間隔 / 1000)
                    const secondsLeft = (countdown * CONFIG.COUNTDOWN_INTERVAL / 1000).toFixed(1);
                    DOM.speechTimer.textContent = `${secondsLeft}秒`;
                  }
                }, CONFIG.COUNTDOWN_INTERVAL);
                
                // 保存計時器引用以便後續清除
                STATE.countdownInterval = countdownInterval;
              });
            });
            
            // 顯示停止按鈕
            DOM.btnStopRecord.style.display = 'inline-flex';
            
            // 不在錄音開始時顯示處理中覆蓋層，而是等待語音結束後再顯示
            DOM.processingOverlay.style.display = 'none';
            
            // 開始語音辨識
            STATE.recognition.start();
            console.log('語音辨識已啟動');
            
            return true;
          } catch (e) {
            console.error('語音辨識啟動失敗:', e);
            showMessage('語音辨識啟動失敗。請嘗試重新整理頁面，或使用文字輸入方式。', 'error');
            // 顯示備選輸入
            DOM.fallback.style.display = 'block';
            // 停止音頻可視化
            AudioVisualizer.stop();
            // 隱藏停止按鈕
            DOM.btnStopRecord.style.display = 'none';
            UI.enableRecordButton();
            
            // 清除任何計時器
            if (STATE.countdownInterval) {
              clearInterval(STATE.countdownInterval);
              STATE.countdownInterval = null;
            }
            
            // 移除語音計時器
            if (DOM.speechTimer) {
              DOM.speechTimer.remove();
              DOM.speechTimer = null;
            }
            if (DOM.timerBar) {
              DOM.timerBar.remove();
              DOM.timerBar = null;
            }
            
            return false;
          }
        },
        
        // 處理語音結果方法 - 重構為兩階段處理
        processSpeechResult() {
          console.log(`倒數計時完成，開始處理語音結果`);
          
          // 顯示處理中覆蓋層
          DOM.processingOverlay.style.display = 'flex';
            
          // 隱藏語音計時器元素
          if (DOM.speechTimer) {
            DOM.speechTimer.style.opacity = '0';
            setTimeout(() => {
              if (DOM.speechTimer) {
                DOM.speechTimer.remove();
                DOM.speechTimer = null;
              }
              if (DOM.timerBar) {
                DOM.timerBar.remove();
                DOM.timerBar = null;
              }
            }, 300);
          }
          
          // 清除倒數計時器
          if (STATE.countdownInterval) {
            clearInterval(STATE.countdownInterval);
            STATE.countdownInterval = null;
          }
          
          // 第一階段：停止語音辨識
          try {
            STATE.recognition.stop();
            console.log('語音辨識已停止');
          } catch (e) {
            console.error('語音辨識停止失敗:', e);
          }
          
          // 第二階段：延遲處理結果，給瀏覽器足夠時間觸發 onresult 事件（特別是在 Safari）
          setTimeout(() => {
            // 在延遲後捕獲結果（這樣能捕獲到 Safari 中延遲觸發的 onresult 事件）
            const capturedTranscript = STATE.lastTranscript;
            const capturedConfidence = STATE.lastConfidence;
            const capturedBackup = STATE.additionalBackupTranscript;
            
            console.log(`延遲後捕獲的識別內容: ${capturedTranscript || '(無)'}, 信心值: ${capturedConfidence || 0}, 備用: ${capturedBackup || '(無)'}`);
          
            // 使用捕獲的結果進行評估
            let mainTranscript = capturedTranscript;
            let mainConfidence = capturedConfidence;
            
            // 如果捕獲的主識別結果為空但有捕獲的備用結果，則使用備用結果
            if ((!mainTranscript || mainTranscript.trim() === '') && capturedBackup) {
              mainTranscript = capturedBackup;
              mainConfidence = 0.7; // 設定一個合理的默認信心值
              console.log(`主識別結果為空，使用捕獲的備用識別結果: ${mainTranscript}`);
            }
        
            // 處理最終結果
            if (mainTranscript) {
              console.log(`使用捕獲結果進行評估: "${mainTranscript}"`);
              const result = this.checkPronunciation(mainTranscript, mainConfidence);
              console.log(`發音評估結果: ${result.correct ? '正確' : '不正確'}, 相似度: ${result.similarity}, 信心值: ${result.confidence}`);
              
              if (result.correct) {
                // 保持處理中覆蓋層顯示，並在延遲後隱藏
                setTimeout(() => {
                  DOM.processingOverlay.style.display = 'none';
                  showMessage('✅ 發音正確！', 'success');
                }, 800);

                setTimeout(() => {
                  nextWord();
                }, 3000);

              } else {
                // 延遲隱藏處理中覆蓋層，使其可見時間更長
                setTimeout(() => {
                  DOM.processingOverlay.style.display = 'none';
                  showMessage(`辨識：${mainTranscript} (信心 ${mainConfidence.toFixed(2)}) ❌ 再試一次`, 'error');
                  UI.enableRecordButton();
                }, 800);
              }
            } else {
              // 無識別結果 (基於捕獲的值)
              console.log('最終評估：捕獲結果無效，顯示錯誤訊息');
              setTimeout(() => {
                DOM.processingOverlay.style.display = 'none';
                showMessage('未能識別您的發音。請再試一次，確保清晰發音並靠近麥克風。', 'error');
                UI.enableRecordButton();
              }, 800);
            }
          }, 800); // 增加較長的延遲時間，給 Safari 足夠的時間處理結果
        },
        
        stop() {
          try {
            // 停止語音辨識
            if (STATE.recognition && STATE.recognition.readyState !== 'inactive') { // 避免重複停止
              STATE.recognition.stop();
              console.log("呼叫 STATE.recognition.stop()");
            }
          } catch (e) {
            console.error('語音辨識停止失敗:', e);
          }
          
          // 重置語音結束標記
          STATE.isSpeechEnded = false;
          
          // 清除倒數計時器
          if (STATE.countdownInterval) {
            clearInterval(STATE.countdownInterval);
            STATE.countdownInterval = null;
          }
          
          // 隱藏處理中覆蓋層
          DOM.processingOverlay.style.display = 'none';
          
          // 停止音頻可視化
          AudioVisualizer.stop();
          
          // 隱藏停止按鈕
          DOM.btnStopRecord.style.display = 'none';
          
          // 移除語音計時器
          if (DOM.speechTimer) {
            DOM.speechTimer.remove();
            DOM.speechTimer = null;
          }
          if (DOM.timerBar) {
            DOM.timerBar.remove();
            DOM.timerBar = null;
          }
          
          // 啟用錄音按鈕
          UI.enableRecordButton();
          
          // 只顯示此訊息
          showMessage('錄音已停止', ''); // 統一訊息，移除句號以符合範例
        },
        
        checkPronunciation(transcript, confidence) {
          const target = STATE.words[STATE.currentIndex].toLowerCase();
      const spoken = transcript.trim().toLowerCase();
          const sim = TextUtils.similarity(spoken, target);
          
      console.log(`目標: ${target}, 辨識: ${spoken}, 相似度: ${sim.toFixed(2)}, 信心值: ${confidence}`);
          
          const isExactMatch = spoken === target && confidence >= CONFIG.CONFIDENCE_THRESHOLD;
          const isSimilarEnough = sim >= CONFIG.SIMILARITY_THRESHOLD && confidence >= CONFIG.CONFIDENCE_THRESHOLD;
          
          return {
            correct: isExactMatch || isSimilarEnough,
            similarity: sim,
            confidence
          };
        }
      };

      // ====== 音頻可視化 ======
      const AudioVisualizer = {
        init() {
          // 設置 canvas
          const canvas = DOM.visualizer;
          const canvasCtx = canvas.getContext('2d');
          
          // 設置 canvas 尺寸以匹配顯示尺寸
          const resizeCanvas = () => {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
          };
          
          resizeCanvas();
          window.addEventListener('resize', resizeCanvas);
          
          // 確保容器內沒有殘留的元素
          while (DOM.visualizerContainer.querySelector('.volume-info')) {
            DOM.visualizerContainer.querySelector('.volume-info').remove();
          }
          
          while (DOM.visualizerContainer.querySelector('.volume-threshold')) {
            DOM.visualizerContainer.querySelector('.volume-threshold').remove();
          }
          
          // 創建音量資訊元素
          const volumeInfo = document.createElement('div');
          volumeInfo.className = 'volume-info';
          volumeInfo.textContent = '音量: 0 dB';
          DOM.visualizerContainer.appendChild(volumeInfo);
          
          // 創建音量閾值線
          const thresholdLine = document.createElement('div');
          thresholdLine.className = 'volume-threshold';
          DOM.visualizerContainer.appendChild(thresholdLine);
          
          return canvasCtx;
        },
        
        async start() {
          if (STATE.visualizerRunning) return;
          
          try {
            // 獲取麥克風
            STATE.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            console.log('成功獲取麥克風權限');
            
            // 創建音頻上下文與分析器
            STATE.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            STATE.analyser = STATE.audioContext.createAnalyser();
            STATE.microphone = STATE.audioContext.createMediaStreamSource(STATE.audioStream);
            STATE.microphone.connect(STATE.analyser);
            
            // 設置分析器參數
            STATE.analyser.fftSize = 256;
            const bufferLength = STATE.analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            // 獲取 canvas 上下文
            const canvasCtx = this.init();
            
            // 激活容器而非顯示容器
            DOM.visualizerContainer.classList.add('active');
            
            // 計算分貝值
            const calculateDecibels = (data) => {
              let sum = 0;
              for (let i = 0; i < data.length; i++) {
                sum += data[i];
              }
              const average = sum / data.length;
              // 將 0-255 的值轉換為分貝值（約 -100 到 0 dB）
              return Math.round(20 * Math.log10(average / 255 * 100));
            };
            
            // 更新音量資訊
            const updateVolumeInfo = (decibels) => {
              const volumeInfo = DOM.visualizerContainer.querySelector('.volume-info');
              if (volumeInfo) {
                volumeInfo.textContent = `音量: ${decibels} dB`;
                
                // 根據音量改變顏色
                if (decibels < -60) {
                  volumeInfo.style.color = '#666';
                } else if (decibels < -40) {
                  volumeInfo.style.color = '#4a6cd6';
                } else if (decibels < -20) {
                  volumeInfo.style.color = '#64bd63';
                } else {
                  volumeInfo.style.color = '#ff6b6b';
                }
              }
            };
            
            // 繪製音頻波形
            const draw = () => {
              if (!STATE.visualizerRunning) return;
              
              requestAnimationFrame(draw);
              
              STATE.analyser.getByteFrequencyData(dataArray);
              
              const canvas = DOM.visualizer;
              const width = canvas.width;
              const height = canvas.height;
              const barWidth = (width / bufferLength) * 2.5;
              
              canvasCtx.clearRect(0, 0, width, height);
              
              // 計算分貝值
              const decibels = calculateDecibels(dataArray);
              updateVolumeInfo(decibels);
              
              let x = 0;
              for(let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 255 * height;
                
                // 根據音量動態調整顏色
                const intensity = dataArray[i] / 255;
                const r = Math.round(74 + (181 * intensity));
                const g = Math.round(108 + (147 * intensity));
                const b = Math.round(214 - (214 * intensity));
                
                canvasCtx.fillStyle = `rgb(${r},${g},${b})`;
                canvasCtx.fillRect(x, height - barHeight, barWidth, barHeight);
                
                // 添加漸變效果
                const gradient = canvasCtx.createLinearGradient(x, height - barHeight, x, height);
                gradient.addColorStop(0, `rgba(${r},${g},${b},0.8)`);
                gradient.addColorStop(1, `rgba(${r},${g},${b},0.2)`);
                canvasCtx.fillStyle = gradient;
                canvasCtx.fillRect(x, height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
              }
            };
            
            STATE.visualizerRunning = true;
            draw();
            
            return true;
          } catch (err) {
            console.error('音頻可視化初始化失敗:', err);
            
            // 添加更詳細的錯誤處理
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
              showMessage('無法獲取麥克風權限。請在瀏覽器設定中允許使用麥克風，或使用文字輸入方式。', 'error');
              enableFallbackMode();
            } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
              showMessage('未找到麥克風設備。請確保您的設備有可用的麥克風。', 'error');
              enableFallbackMode();
            } else {
              showMessage('無法啟動音頻可視化，但錄音仍在進行。', 'info');
            }
            
            return false;
          }
        },
        
        stop() {
          STATE.visualizerRunning = false;
          
          // 釋放音頻資源
          if (STATE.audioStream) {
            STATE.audioStream.getTracks().forEach(track => track.stop());
            STATE.audioStream = null;
          }
          
          if (STATE.audioContext) {
            if (STATE.microphone) {
              STATE.microphone.disconnect();
              STATE.microphone = null;
            }
            
            if (STATE.analyser) {
              STATE.analyser = null;
            }
            
            STATE.audioContext = null;
          }
          
          // 取消激活容器而非隱藏容器
          DOM.visualizerContainer.classList.remove('active');
          
          // 清理畫布
          const canvas = DOM.visualizer;
          const canvasCtx = canvas.getContext('2d');
          canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        }
      };

      // ====== 輔助函數 ======
      function showMessage(text, type = '') {
        DOM.message.textContent = text;
        DOM.message.className = 'message';
        if (type) DOM.message.classList.add(type);
      }
      
      function nextWord() {
        STATE.currentIndex++;
        if (STATE.currentIndex < STATE.words.length) {
          UI.updateProgress();
          UI.updateWord();
          UI.reset();
          UI.enableRecordButton();
        } else {
          UI.completeExercise();
        }
      }

      // 新增：重新開始練習函數
      function restartExercise() {
        // 重置單字索引
        STATE.currentIndex = 0;
        
        // 更新進度顯示
        UI.updateProgress();
        UI.updateWord();
        
        // 清除訊息
        showMessage('');
        
        // 恢復控制按鈕顯示
        if (DOM.controlButtons) {
          DOM.controlButtons.style.display = 'flex';
        }
        
        // 恢復視覺化容器顯示
        if (DOM.visualizerContainer) {
          DOM.visualizerContainer.style.display = 'block';
        }
        
        // 移除重新練習按鈕
        const restartBtn = document.getElementById('btnRestart');
        if (restartBtn) {
          restartBtn.remove();
        }
        
        // 啟用錄音按鈕
        UI.enableRecordButton();
        
        // 顯示指引訊息
        showMessage('點擊「開始錄音」，說出顯示的英文單字。', '');
      }

      // 新增：啟用 fallback 模式
      function enableFallbackMode() {
        // 顯示 fallback 區塊
        DOM.fallback.style.display = 'block';
        // 隱藏控制按鈕
        DOM.controlButtons.style.display = 'none';
        // 隱藏視覺化容器
        DOM.visualizerContainer.style.display = 'none';
      }

      // 新增：恢復正常模式
      function disableFallbackMode() {
        // 隱藏 fallback 區塊
        DOM.fallback.style.display = 'none';
        // 顯示控制按鈕
        DOM.controlButtons.style.display = 'flex';
        // 顯示視覺化容器
        DOM.visualizerContainer.style.display = 'block';
      }

      // ====== 事件處理 ======
      function setupEventListeners() {
        // 在啟動時初始化「停止錄音」按鈕為禁用狀態
        DOM.btnStopRecord.disabled = true;
        DOM.btnStopRecord.style.display = 'inline-flex';
        
        // 為按鈕添加類別以便樣式定位
        DOM.btnRecord.classList.add('btn-record');

        // 錄音按鈕事件
        DOM.btnRecord.addEventListener('click', () => {
          UI.disableRecordButton();
          UI.reset();
          Speech.start();
        });

        // 停止錄音按鈕事件
        DOM.btnStopRecord.addEventListener('click', () => {
          Speech.stop();
        });

        // 文字輸入備援事件
        DOM.btnSubmit.addEventListener('click', () => {
          const input = DOM.txtInput.value;
          const result = Speech.checkPronunciation(input, 1.0);
          
          if (result.correct) {
            showMessage('✅ 正確！', 'success');
            DOM.txtInput.value = '';
            setTimeout(nextWord, 1500);
          } else {
            showMessage('❌ 錯誤，請再試一次', 'error');
            DOM.txtInput.focus();
          }
        });
        
        // 支援按 Enter 提交
        DOM.txtInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            DOM.btnSubmit.click();
          }
        });
        
        // 疑難排解按鈕
        DOM.btnHelp.addEventListener('click', () => {
          const isVisible = DOM.troubleshooting.style.display === 'block';
          DOM.troubleshooting.style.display = isVisible ? 'none' : 'block';
          
          // 更新按鈕文字和圖示
          if (isVisible) {
            DOM.btnHelp.innerHTML = '<i class="fas fa-question-circle"></i>疑難排解';
            // 隱藏測試麥克風按鈕
            DOM.btnTestMic.style.display = 'none';
          } else {
            DOM.btnHelp.innerHTML = '<i class="fas fa-times"></i>關閉指南';
            // 顯示測試麥克風按鈕
            DOM.btnTestMic.style.display = 'inline-flex';
          }
        });
        
        // 麥克風測試按鈕
        DOM.btnTestMic.addEventListener('click', async () => {
          try {
            DOM.btnTestMic.innerHTML = '<i class="fas fa-spinner fa-spin"></i>測試中...';
            DOM.btnTestMic.disabled = true;
            
            // 檢查麥克風
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // 創建音頻上下文與分析器
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            
            // 設置分析參數
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            // 監測音量
            let silenceCounter = 0;
            const checkAudio = () => {
              analyser.getByteFrequencyData(dataArray);
              
              // 計算平均音量
              let sum = 0;
              for(let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
              }
              const average = sum / bufferLength;
              
              if (average > 10) {
                // 檢測到聲音
                showMessage('✅ 麥克風運作正常！已檢測到聲音。', 'success');
                clearInterval(interval);
                stream.getTracks().forEach(track => track.stop());
                DOM.btnTestMic.innerHTML = '<i class="fas fa-microphone"></i>測試麥克風';
                DOM.btnTestMic.disabled = false;
                return;
              }
              
              silenceCounter++;
              if (silenceCounter > 30) { // 約 3 秒
                showMessage('❌ 未檢測到聲音。請確認麥克風已正確連接並發出聲音。', 'error');
                clearInterval(interval);
                stream.getTracks().forEach(track => track.stop());
                DOM.btnTestMic.innerHTML = '<i class="fas fa-microphone"></i>測試麥克風';
                DOM.btnTestMic.disabled = false;
              }
            };
            
            showMessage('請對著麥克風說話或發出聲音...', 'info');
            const interval = setInterval(checkAudio, 100);
            
            // 設置測試超時
            setTimeout(() => {
              if (!DOM.btnTestMic.disabled) return; // 已經完成測試
              clearInterval(interval);
              stream.getTracks().forEach(track => track.stop());
              showMessage('測試逾時。請再次嘗試測試麥克風。', 'error');
              DOM.btnTestMic.innerHTML = '<i class="fas fa-microphone"></i>測試麥克風';
              DOM.btnTestMic.disabled = false;
            }, 10000);
            
          } catch (error) {
            console.error('麥克風測試失敗:', error);
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
              showMessage('❌ 麥克風權限被拒絕。請在瀏覽器設定中允許使用麥克風。', 'error');
            } else {
              showMessage(`❌ 麥克風測試失敗: ${error.message}`, 'error');
            }
            DOM.btnTestMic.innerHTML = '<i class="fas fa-microphone"></i>測試麥克風';
            DOM.btnTestMic.disabled = false;
          }
        });
        
        // 本地環境下自動顯示網絡狀態
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          // 在網頁載入時顯示網絡狀態
          window.addEventListener('load', () => {
            setTimeout(() => {
              console.info('檢查網絡連接狀態...');
              // 嘗試 ping Google 服務器來檢查網絡連接
              fetch('https://www.google.com/generate_204', { mode: 'no-cors', cache: 'no-store' })
                .then(() => {
                  console.info('網絡連接正常');
                })
                .catch(err => {
                  console.warn('網絡連接測試失敗:', err);
                  showMessage('警告：網絡連接可能不穩定。語音辨識功能可能受影響。', 'info');
                });
            }, 1000);
          });
        }
      }

      // ====== 主程式 ======
      async function init() {
        // 載入單字
        const loadSuccess = await API.loadWords();
        if (!loadSuccess) return;
        
        // 不在初始化時就設置語音辨識
        
        // 設置事件監聽
        setupEventListeners();
        
        // 更新 UI
        UI.updateProgress();
        UI.updateWord();
        
        // 顯示初始提示信息
        showMessage('點擊「開始錄音」後，清晰念出顯示的英文單字', '');
        
        // 初始化時隱藏測試麥克風按鈕
        DOM.btnTestMic.style.display = 'none';
        
        // 初始化視覺化容器，但不啟動
        DOM.visualizerContainer.style.display = 'block';
        
        // 添加離線檢測
        window.addEventListener('online', () => {
          showMessage('網絡連接已恢復，語音辨識功能應該可以正常使用了。', 'success');
          // 檢查是否有 fallback 模式，如果有則關閉
          if (DOM.fallback.style.display === 'block') {
            disableFallbackMode();
          }
        });
        
        window.addEventListener('offline', () => {
          showMessage('網絡連接已斷開，語音辨識可能無法正常工作。請使用文字輸入方式。', 'error');
          enableFallbackMode();
        });
      }

      // 啟動應用
      window.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>