<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單字迴憶｜VocabLoop</title>
    <!-- 添加 Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- 添加 Papa Parse 用於解析 CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://ys-fang.github.io/quickNav/quicknav.css">
    <style>
        /* CSS變數定義 */
        :root {
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 15px;
            --border-radius-xl: 20px;
            --primary-color: #4a6cd6;
            --bg-color: #f5f7fa;
            --text-primary: #333;
            --text-secondary: #666;
            --text-tertiary: #888;
            --shadow-sm: 0 5px 15px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        html {
            font-size: 18px !important;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        body {
            top:0;
            left:0;
            background-color: var(--bg-color);
            line-height: 1 !important;
        }
        
        .app{
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;            
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            position: relative;
        }

        .header {
            background-color: #4a6cd6;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* 計時器樣式 */
        .timer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: #f2f5fc;
            border-bottom: 1px solid #e0e6f5;
        }

        .timer {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            color: #4a6cd6;
            font-weight: bold;
        }

        .timer i {
            margin-right: 10px;
            color: #4a6cd6;
        }

        /* 倒數計時樣式 */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .countdown-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 150px;
            height: 150px;
            background-color: #4a6cd6;
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(74, 108, 214, 0.5);
        }

        .countdown-number {
            font-size: 5rem;
            font-weight: bold;
            color: white;
        }

        /* 完成時間樣式 */
        .completion-time {
            margin-top: 10px;
            font-size: 1.2rem;
            color: #64bd63;
            font-weight: bold;
        }

        .progress-bar {
            height: 8px;
            background-color: #e0e6f5;
            width: 100%;
        }

        .progress {
            height: 100%;
            background-color: #4a6cd6;
            transition: width 0.3s ease;
        }

        .card {
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 400px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .word {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .phonetic {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 15px;
        }

        .meaning {
            text-align: center;
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #555;
        }

        .example {
            text-align: left;
            font-style: italic;
            margin-bottom: 5px;
            color: #666;
            padding: 0 20px;
        }

        .translation {
            text-align: left;
            color: #888;
            margin-bottom: 25px;
            padding: 0 20px;
        }

        .pronunciation {
            background-color: #f2f5fc;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .pronunciation:hover {
            background-color: #e0e6f5;
        }

        .pronunciation i {
            font-size: 20px;
            color: #4a6cd6;
        }

        /* 新增圖標樣式 */
        .btn i {
            margin-right: 8px;
        }

        .word-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header i {
            margin-right: 10px;
        }

        .question i {
            margin-right: 10px;
            color: #4a6cd6;
        }

        .choice-btn i {
            margin-right: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .choice-btn:hover i {
            opacity: 1;
        }

        .score i {
            color: #4a6cd6;
            margin-right: 10px;
        }

        .completion i {
            color: #64bd63;
            margin-right: 10px;
        }

        .buttons {
            display: flex;
            gap: 15px;
            width: 100%;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .keep-btn {
            background-color: #f2f5fc;
            color: #4a6cd6;
            border: 2px solid #4a6cd6;
        }

        .keep-btn:hover {
            background-color: #e0e6f5;
        }

        .got-btn {
            background-color: #4a6cd6;
            color: white;
        }

        .got-btn:hover {
            background-color: #3a5cc6;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 30px;
            min-height: 400px;
            justify-content: center;
            align-items: center;
        }

        .options h2 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .options .btn {
            width: 100%;
            max-width: 250px;
        }

        .quiz-card {
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 400px;
        }

        .question {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .choice-btn {
            padding: 15px;
            border: 2px solid #e0e6f5;
            border-radius: 8px;
            background-color: white;
            color: #000;
            font-size: 1rem;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .choice-btn:hover {
            background-color: #f2f5fc;
        }

        .choice-btn:active {
            transform: scale(0.98);
        }

        .results {
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            text-align: center;
        }

        .results h2 {
            margin-bottom: 15px;
            color: #333;
        }

        .score {
            font-size: 3rem;
            font-weight: bold;
            color: #4a6cd6;
            margin: 15px 0;
        }

        .completion {
            font-size: 2rem;
            font-weight: bold;
            color: #64bd63;
            margin: 20px 0;
        }

        .hidden {
            display: none;
        }

        /* 彈出式視窗樣式 */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 460px;
            padding: 25px;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .popup-overlay.active .popup {
            transform: translateY(0);
        }

        .popup h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .popup .input-group {
            margin-bottom: 20px;
        }

        .popup input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6f5;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .popup input:focus {
            outline: none;
            border-color: #4a6cd6;
        }

        .popup .buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .popup .message {
            text-align: center;
            color: #64bd63;
            margin-top: 10px;
            font-weight: bold;
            display: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* 小型裝置的響應式設計 */
        @media (max-width: 480px) {
            .header {
                font-size: 1.2rem;
                padding: 15px;
            }

            .timer {
                font-size: 1rem;
            }

            .word {
                font-size: 2rem;
            }

            .phonetic {
                font-size: 1rem;
            }

            .meaning {
                font-size: 1.1rem;
            }

            .example, .translation {
                font-size: 0.9rem;
            }

            .btn {
                font-size: 0.9rem;
                padding: 10px;
            }

            .question {
                font-size: 1.2rem;
            }

            .choice-btn {
                font-size: 0.9rem;
                padding: 12px;
            }

            .score {
                font-size: 2.5rem;
            }

            .completion {
                font-size: 1.7rem;
            }

            .completion-time {
                font-size: 1rem;
            }

            .popup h3 {
                font-size: 1.2rem;
            }

            .popup input {
                font-size: 0.9rem;
                padding: 10px;
            }
        }

        /* 超小型裝置的額外調整 */
        @media (max-width: 320px) {
            .header {
                font-size: 1rem;
                padding: 12px;
            }

            .word {
                font-size: 1.8rem;
            }

            .btn {
                font-size: 0.8rem;
                padding: 8px;
            }

            .buttons {
                gap: 8px;
            }

            .card, .quiz-card {
                padding: 20px;
                min-height: 350px;
            }
        }

        #download-message {
            color: #4a6cd6;
        }

        .highlight { 
            position: relative;
            display: inline-block;
            text-decoration: underline;
            z-index: 1;
        }

        .highlight::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            height: 100%;
            width: 100%;
            background-color: rgba(255, 255, 0, 0.5);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: -1;
        }

        .highlight:hover::after {
            transform: scaleX(1);
        }

        .stats-container {
            max-height: 60vh;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 6px;
        }

        .stats-total, .stats-time {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #495057;
        }

        .stats-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-word {
            font-weight: bold;
            color: #4a6cd6;
        }

        .stat-meaning {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .stat-count {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #dc3545;
            font-weight: bold;
        }

        @media (max-width: 480px) {
            .stats-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .stat-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .stat-count {
                align-self: flex-end;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="container">
            <div class="header"><i class="fas fa-infinity"></i>單字迴憶</div>
            <div class="timer-container">
                <div class="timer">
                    <i class="fas fa-stopwatch"></i>
                    <span id="timer-display">00 分鐘 : 00 秒</span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
    
            <!-- 學習卡片 -->
            <div id="learning-section" class="fade-in">
                <div class="card" id="word-card">
                    <div class="word-section">
                        <div class="word">loading...</div>
                        <i class="fas fa-star" style="color: #ffd700; font-size: 0.5em; display: none;" id="learned-star"></i>
                    </div>
                    <div class="phonetic"><i class="fas fa-mouth" style="margin-right: 5px; color: #888;"></i></div>
                    <div class="meaning"><i class="fas fa-language" style="margin-right: 5px; color: #4a6cd6;"></i></div>
                    <div class="example"><i class="fas fa-quote-left" style="margin-right: 5px; color: #888;"></i></div>
                    <div class="translation"><i class="fas fa-globe-asia" style="margin-right: 5px; color: #888;"></i></div>
                    <button class="pronunciation hidden">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <div class="buttons">
                        <button class="btn keep-btn" id="keep-btn"><i class="fas fa-redo"></i>還不熟 (Yet)</button>
                        <button class="btn got-btn" id="got-btn"><i class="fas fa-check"></i>已學會 (Know)</button>
                    </div>
                </div>
            </div>
    
            <!-- 選項畫面 -->
            <div id="options-section" class="options hidden">
                <h2><i class="fas fa-graduation-cap"></i> Ready to Test?</h2>
                <div class="buttons">
                    <button class="btn keep-btn" id="relearn-btn"><i class="fas fa-sync"></i>全新一局</button>
                    <button class="btn got-btn" id="quiz-btn"><i class="fas fa-tasks"></i>測驗複習</button>
                </div>
            </div>
    
            <!-- 測驗畫面 -->
            <div id="quiz-section" class="hidden">
                <div class="quiz-card" id="quiz-card">
                    <div class="question" id="question"><i class="fas fa-question-circle"></i>請選出「蘋果」的英文：</div>
                    <div class="choices" id="choices">
                        <button class="choice-btn"><i class="fas fa-check-circle"></i>apple</button>
                        <button class="choice-btn"><i class="fas fa-check-circle"></i>banana</button>
                        <button class="choice-btn"><i class="fas fa-check-circle"></i>orange</button>
                        <button class="choice-btn"><i class="fas fa-check-circle"></i>grape</button>
                    </div>
                </div>
            </div>
    
            <!-- 結果畫面 -->
            <div id="results-section" class="results hidden">
                <h2><i class="fas fa-chart-bar"></i>答對率</h2>
                <div class="score" id="score"><i class="fas fa-star"></i>8/10</div>
                <div id="partial-complete-msg">
                    <i class="fas fa-info-circle"></i> 有些單字還需要加強，讓我們再複習一次吧！
                </div>
                <div id="complete-msg" class="hidden">
                    <div class="completion"><i class="fas fa-trophy"></i>學習完成</div>
                    <div><i class="fas fa-medal"></i> 恭喜你掌握所有單字！</div>
                    <div id="completion-time" class="completion-time hidden"><i class="fas fa-stopwatch"></i>完成時間: 0 分鐘 0 秒</div>
                </div>
                <div class="buttons">
                    <button class="btn keep-btn" id="restart-btn"><i class="fas fa-redo"></i>全新一局</button>
                    <button class="btn got-btn" id="continue-btn"><i class="fas fa-forward"></i>複習錯題</button>
                    <button class="btn got-btn" id="save-btn"><i class="fas fa-calendar-plus"></i>保存紀錄</button>
                    <button class="btn got-btn" id="show-stats-btn"><i class="fas fa-chart-pie"></i>顯示紀錄</button>
                </div>
            </div>
        </div>
    
        <!-- 彈出式視窗 -->
        <div class="popup-overlay" id="email-popup">
            <div class="popup">
                <h3><i class="fas fa-calendar-alt"></i> 保存紀錄</h3>
                <div class="input-group">
                    <input type="text" id="email-input" placeholder="請輸入事件標題 (選填)" />
                </div>
                <div class="buttons">
                    <button class="btn keep-btn" id="cancel-btn"><i class="fas fa-times"></i>取消</button>
                    <button class="btn got-btn" id="send-btn"><i class="fas fa-calendar-plus"></i>加入日曆</button>
                    <button class="btn got-btn" id="download-md-btn"><i class="fas fa-download"></i>下載筆記</button>
                </div>
                <div class="message" id="send-message"><i class="fas fa-check-circle"></i>已建立日曆事件</div>
                <div class="message" id="download-message"><i class="fas fa-check-circle"></i>已下載筆記</div>
            </div>
        </div>

        <div class="popup-overlay" id="stats-popup">
            <div class="popup">
                <h3><i class="fas fa-chart-pie"></i> 單字學習統計</h3>
                <div class="stats-container">
                    <div class="stats-header">
                        <div class="stats-total">
                            <i class="fas fa-book"></i>
                            <span>總單字數：<span id="total-words">0</span></span>
                        </div>
                        <div class="stats-time">
                            <i class="fas fa-clock"></i>
                            <span>學習時間：<span id="stats-time">0 分鐘 0 秒</span></span>
                        </div>
                    </div>
                    <div class="stats-list" id="stats-list">
                        <!-- 單字統計列表將在這裡動態生成 -->
                    </div>
                </div>
                <div class="buttons">
                    <button class="btn keep-btn" id="close-stats-btn"><i class="fas fa-times"></i>關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入必要的腳本 -->
    <script src="https://ys-fang.github.io/quickNav/quicknav.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化 QuickNav
            QuickNav.init({
                position: 'top-left',
                theme: 'light'
            });
        });
    </script>

    <script>
        // 獲取 URL 參數函數
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 從 Google Sheet 載入資料
        async function loadSheetData() {
            const loadingElement = document.getElementById("loadingPlacholder") || document.createElement("div");
            if (!document.body.contains(loadingElement)) {
                loadingElement.id = "loadingPlacholder";
                loadingElement.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> 載入中...';
                loadingElement.style.textAlign = 'center';
                loadingElement.style.margin = '20px 0';
                document.body.insertBefore(loadingElement, document.querySelector('.app'));
            }
            loadingElement.style.display = "block";

            const label = getQueryParam("label") || "";
            const spreadsheetId = "1wSHAL3piJGEJ8EnoyK_W9kkvL42GQYId35UEhMzHTZY"; 
            const gid = "0"; 
            const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;

            try {
                const response = await fetch(spreadsheetUrl);
                if (!response.ok) throw new Error("無法載入試算表資料");
                const csvText = await response.text();
                if (!csvText.trim()) throw new Error("試算表內容為空");

                // 解析 CSV
                const { data } = Papa.parse(csvText, { header: false });
                if (!data || data.length === 0) throw new Error("解析後的資料為空");

                // 取表頭
                const header = data.shift();
                if (!header) throw new Error("無法提取表頭，資料格式可能有誤");

                // 過濾資料：只保留第一欄 (Label) 符合的
                const filteredData = data.filter(row => row[0].toLowerCase() === label.toLowerCase());
                // 去除每行的第一欄 (Label)
                const processedData = filteredData.map(row => row.slice(1));

                // 轉換成我們的詞彙格式
                const vocabularyData = processedData.map(row => {
                    return {
                        word: (row[0] || "").trim(),
                        phonetic: (row[1] || "").trim(),
                        meaning: (row[2] || "").trim(),
                        example: (row[3] || "").trim(),
                        translation: (row[4] || "").trim(),
                        videoRelated: (row[5] || "").trim(),
                        markStart: (row[6] || "").trim(),
                        markEnd: (row[7] || "").trim()
                    };
                });

                // 過濾掉空白的資料
                const validVocabularyData = vocabularyData.filter(word => 
                    word.word && word.meaning // 至少要有單字和意思
                );

                // 排序詞彙（依照單字字母順序）
                validVocabularyData.sort((a, b) => a.word.toLowerCase().localeCompare(b.word.toLowerCase()));
                
                // 添加除錯用的資料輸出
                if (DEBUG_MODE) {
                    console.log('已載入的單字資料（經過清理）：');
                    console.log(JSON.stringify(validVocabularyData, null, 2));
                }
                
                return validVocabularyData;
            } catch (error) {
                console.error("載入資料失敗:", error);
                loadingElement.textContent = `載入資料失敗：${error.message}`;
                return [];
            } finally {
                loadingElement.style.display = "none";
            }
        }

        // 假設的10個單字資料（當無法載入 Google Sheet 時使用）
        let vocabularyData = [
            {
                word: "umbrella",
                phonetic: "/ʌmˈbrel.ə/",
                meaning: "n. 雨傘",
                example: "Don't forget to take your umbrella, it might rain today.",
                translation: "別忘了帶雨傘，今天可能會下雨。"
            },
            {
                word: "delicious",
                phonetic: "/dɪˈlɪʃ.əs/",
                meaning: "adj. 美味的、可口的",
                example: "The homemade cookies were absolutely delicious.",
                translation: "這些自製餅乾真是太美味了。"
            },
            {
                word: "journey",
                phonetic: "/ˈdʒɜː.ni/",
                meaning: "n. 旅程、旅行",
                example: "The journey from London to Paris takes about two hours by train.",
                translation: "從倫敦到巴黎乘火車大約需要兩小時。"
            },
            {
                word: "furniture",
                phonetic: "/ˈfɜː.nɪ.tʃər/",
                meaning: "n. 傢俱",
                example: "They bought new furniture for their living room.",
                translation: "他們為客廳買了新傢俱。"
            },
            {
                word: "appointment",
                phonetic: "/əˈpɔɪnt.mənt/",
                meaning: "n. 預約、約會",
                example: "I have a dentist appointment next Tuesday.",
                translation: "我下週二有牙醫預約。"
            },
            {
                word: "ambitious",
                phonetic: "/æmˈbɪʃ.əs/",
                meaning: "adj. 有雄心的、野心勃勃的",
                example: "She is an ambitious young lawyer who wants to become a judge.",
                translation: "她是一位雄心勃勃的年輕律師，想要成為法官。"
            },
            {
                word: "controversial",
                phonetic: "/ˌkɒn.trəˈvɜː.ʃəl/",
                meaning: "adj. 有爭議的、引起爭論的",
                example: "The new policy has become a controversial issue among citizens.",
                translation: "這項新政策在市民中間成為了一個有爭議的議題。"
            },
            {
                word: "sustainable",
                phonetic: "/səˈsteɪ.nə.bəl/",
                meaning: "adj. 可持續的、永續的",
                example: "The company is committed to sustainable development and green energy.",
                translation: "該公司致力於可持續發展和綠色能源。"
            },
            {
                word: "ephemeral",
                phonetic: "/ɪˈfem.ər.əl/",
                meaning: "adj. 短暫的、瞬息即逝的",
                example: "Fame can be ephemeral, especially in the age of social media.",
                translation: "名聲可能是短暫的，尤其是在社交媒體時代。"
            },
            {
                word: "quintessential",
                phonetic: "/ˌkwɪn.tɪˈsen.ʃəl/",
                meaning: "adj. 典型的、最典範的、精髓的",
                example: "The Victorian house is the quintessential example of 19th-century architecture.",
                translation: "這座維多利亞式房屋是19世紀建築的典範。"
            }
        ];

        // 創建讀取指示器
        const loadingElement = document.createElement("div");
        loadingElement.id = "loadingPlacholder";
        loadingElement.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> 載入中...';
        loadingElement.style.textAlign = 'center';
        loadingElement.style.margin = '20px 0';
        loadingElement.style.display = 'none';

        // 計時器變數
        let timerInterval;
        let startTime;
        let elapsedTime = 0;
        let isTimerRunning = false;
        let countdownTimer;

        // 程式狀態變數
        let currentWords = [];
        let learnedWords = []; // 已學會的單字
        let keepWords = []; // 保留的單字
        let currentIndex = 0; // 目前顯示單字的索引
        let quizQuestions = []; // 測驗題目
        let quizAnswers = []; // 測驗答案
        let currentQuizIndex = 0; // 目前測驗題目索引
        let correctAnswers = 0; // 答對題數
        let incorrectWordCount = 0; // 測驗答錯的單字數，初始化時設置
        let wordErrorCounts = {}; // 記錄每個單字答錯的累計次數
        const DEBUG_MODE = false; // 除錯模式開關

        // DOM 元素
        const learningSection = document.getElementById('learning-section');
        const optionsSection = document.getElementById('options-section');
        const quizSection = document.getElementById('quiz-section');
        const resultsSection = document.getElementById('results-section');
        const wordCard = document.getElementById('word-card');
        const progressBar = document.getElementById('progress');
        const keepBtn = document.getElementById('keep-btn');
        const gotBtn = document.getElementById('got-btn');
        const relearnBtn = document.getElementById('relearn-btn');
        const quizBtn = document.getElementById('quiz-btn');
        const quizCard = document.getElementById('quiz-card');
        const questionEl = document.getElementById('question');
        const choicesEl = document.getElementById('choices');
        const scoreEl = document.getElementById('score');
        const partialCompleteMsg = document.getElementById('partial-complete-msg');
        const completeMsg = document.getElementById('complete-msg');
        const continueBtn = document.getElementById('continue-btn');
        const restartBtn = document.getElementById('restart-btn');

        // 初始化應用
        async function initializeApp() {
            // 顯示讀取指示器
            loadingElement.style.display = "block";
            
            try {
                // 嘗試從 Google Sheet 載入資料
                const data = await loadSheetData();
                if (data && data.length > 0) {
                    vocabularyData = data;
                }
            } catch (error) {
                console.error("載入 Google Sheet 資料失敗:", error);
                // 使用預設資料
            } finally {
                loadingElement.style.display = "none";
            }
            
            currentWords = [...vocabularyData];
            learnedWords = [];
            keepWords = [];
            currentIndex = 0;
            incorrectWordCount = vocabularyData.length; // 設置初始錯誤單字數為總單字數
            
            // 初始化每個單字的錯誤計數為 0
            wordErrorCounts = {};
            vocabularyData.forEach(word => {
                wordErrorCounts[word.word] = 0;
            });
            
            shuffleArray(currentWords);
            updateProgressBar();
            
            // 確保進度條顯示
            document.querySelector('.progress-bar').style.display = 'block';
            
            // 開始倒數計時
            startCountdown();
        }

        // 倒數計時功能
        function startCountdown() {
            // 創建倒數計時元素
            const countdownOverlay = document.createElement('div');
            countdownOverlay.className = 'countdown-overlay';
            countdownOverlay.innerHTML = `
                <div class="countdown-container">
                    <div class="countdown-number">3</div>
                </div>
            `;
            document.body.appendChild(countdownOverlay);

            let count = 3;
            const countdownEl = countdownOverlay.querySelector('.countdown-number');
            
            // 倒數計時
            countdownTimer = setInterval(() => {
                count--;
                countdownEl.textContent = count;
                
                if (count <= 0) {
                    clearInterval(countdownTimer);
                    countdownOverlay.remove();
                    displayWordCard();
                    startTimer();
                }
            }, 1000);
        }

        // 開始計時器
        function startTimer() {
            if (!isTimerRunning) {
                startTime = Date.now() - elapsedTime;
                timerInterval = setInterval(updateTimer, 1000);
                isTimerRunning = true;
            }
        }

        // 暫停計時器
        function pauseTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                elapsedTime = Date.now() - startTime;
                isTimerRunning = false;
            }
        }

        // 停止計時器
        function stopTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            elapsedTime = 0;
            updateTimerDisplay();
        }

        // 更新計時器
        function updateTimer() {
            elapsedTime = Date.now() - startTime;
            updateTimerDisplay();
        }

        // 更新計時器顯示
        function updateTimerDisplay() {
            const seconds = Math.floor(elapsedTime / 1000) % 60;
            const minutes = Math.floor(elapsedTime / 1000 / 60);
            
            const formattedTime = `${minutes.toString().padStart(2, '0')} 分鐘 : ${seconds.toString().padStart(2, '0')} 秒`;
            document.getElementById('timer-display').textContent = formattedTime;
        }

        // 更新進度條
        function updateProgressBar() {
            let progress;
            if (quizSection.classList.contains('hidden')) {
                // 學習模式：顯示已學會單字/總單字數
                const learnedCount = learnedWords.length;
                progress = (learnedCount / incorrectWordCount) * 100;
            } else {
                // 測驗模式：顯示已作答題數/總題數
                progress = (currentQuizIndex / quizQuestions.length) * 100;
            }
            progressBar.style.width = `${progress}%`;
        }

        // 顯示單字卡片
        function displayWordCard() {
            if (currentIndex >= currentWords.length) {
                // 如果已顯示完所有卡片
                if (keepWords.length === 0) {
                    // 如果沒有保留的卡片，顯示選項畫面
                    showOptionsSection();
                } else {
                    // 否則再次顯示保留的卡片
                    currentWords = [...keepWords];
                    keepWords = [];
                    currentIndex = 0;
                    shuffleArray(currentWords);
                    displayWordCard();
                }
                return;
            }

            const currentWord = currentWords[currentIndex];
            
            // 處理例句標記
            let markedExample = currentWord.example;
            if (currentWord.example && currentWord.markStart && currentWord.markEnd) {
                const words = currentWord.example.split(' ');
                const start = parseInt(currentWord.markStart) - 1; // 轉換為 0-based 索引
                const end = parseInt(currentWord.markEnd) - 1;
                
                if (!isNaN(start) && !isNaN(end) && start >= 0 && end < words.length) {
                    words[start] = `<span class="highlight">${words[start]}`;
                    words[end] = `${words[end]}</span>`;
                    markedExample = words.join(' ');
                }
            }

            wordCard.querySelector('.word').textContent = currentWord.word;
            wordCard.querySelector('.phonetic').textContent = currentWord.phonetic;
            wordCard.querySelector('.meaning').textContent = currentWord.meaning;
            wordCard.querySelector('.example').innerHTML = markedExample;
            wordCard.querySelector('.translation').textContent = currentWord.translation;

            // 檢查單字是否已學會並顯示星星圖標
            const learnedStar = document.getElementById('learned-star');
            if (learnedWords.some(w => w.word === currentWord.word)) {
                learnedStar.style.display = 'inline-block';
            } else {
                learnedStar.style.display = 'none';
            }

            // 重設動畫
            wordCard.classList.remove('fade-in');
            void wordCard.offsetWidth; // 觸發 reflow
            wordCard.classList.add('fade-in');
        }

        // 顯示選項畫面
        function showOptionsSection() {
            learningSection.classList.add('hidden');
            optionsSection.classList.remove('hidden');
            quizSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
        }

        // 再次學習
        function relearn() {
            currentWords = [...vocabularyData];
            learnedWords = []; // 重置已學會單字，進度條會歸零
            keepWords = [];
            currentIndex = 0;
            incorrectWordCount = vocabularyData.length; // 重置為總單字數
            
            // 重置每個單字的錯誤計數為 0
            wordErrorCounts = {};
            vocabularyData.forEach(word => {
                wordErrorCounts[word.word] = 0;
            });
            
            shuffleArray(currentWords);
            
            // 確保進度條顯示
            document.querySelector('.progress-bar').style.display = 'block';
            updateProgressBar();

            // 重置計時器
            stopTimer();
            startTimer();

            learningSection.classList.remove('hidden');
            optionsSection.classList.add('hidden');
            quizSection.classList.add('hidden');
            resultsSection.classList.add('hidden');

            displayWordCard();
        }

        // 開始測驗
        function startQuiz() {
            // 生成測驗題目
            generateQuizQuestions();
            currentQuizIndex = 0;
            correctAnswers = 0;
            
            // 顯示進度條並歸零
            document.querySelector('.progress-bar').style.display = 'block';
            progressBar.style.width = '0%'; // 將進度條歸零

            learningSection.classList.add('hidden');
            optionsSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');

            displayQuizQuestion();
        }

        // 生成測驗題目
        function generateQuizQuestions() {
            quizQuestions = [];
            quizAnswers = [];

            // 建立單字映射表，用於檢查重複
            const wordMeaningMap = new Map(); // 英文 -> 中文意思陣列
            const meaningWordMap = new Map(); // 中文意思 -> 英文單字陣列

            // 第一步：建立映射關係
            vocabularyData.forEach(word => {
                // 處理英文到中文的映射（多義詞）
                if (!wordMeaningMap.has(word.word)) {
                    wordMeaningMap.set(word.word, []);
                }
                wordMeaningMap.get(word.word).push(word.meaning);

                // 處理中文到英文的映射（同義詞）
                if (!meaningWordMap.has(word.meaning)) {
                    meaningWordMap.set(word.meaning, []);
                }
                meaningWordMap.get(word.meaning).push(word.word);
            });

            // DEBUG: 輸出映射關係
            if (DEBUG_MODE) {
                console.log('===== 詞彙映射關係（用於除錯） =====');
                console.log('1. 英文單字 -> 中文意思（多義詞映射）：');
                const wordMeaningObj = Object.fromEntries(wordMeaningMap);
                console.log(JSON.stringify(wordMeaningObj, null, 2));
                
                console.log('\n2. 中文意思 -> 英文單字（同義詞映射）：');
                const meaningWordObj = Object.fromEntries(meaningWordMap);
                console.log(JSON.stringify(meaningWordObj, null, 2));
                
                // 輸出多義詞和同義詞的統計
                const multiMeaningWords = Array.from(wordMeaningMap.entries())
                    .filter(([_, meanings]) => meanings.length > 1)
                    .map(([word, meanings]) => ({
                        word,
                        meanings
                    }));
                
                const multiWordMeanings = Array.from(meaningWordMap.entries())
                    .filter(([_, words]) => words.length > 1)
                    .map(([meaning, words]) => ({
                        meaning,
                        words
                    }));
                
                console.log('\n3. 多義詞統計（具有多個中文意思的英文單字）：');
                console.log(JSON.stringify(multiMeaningWords, null, 2));
                
                console.log('\n4. 同義詞統計（具有多個英文單字的中文意思）：');
                console.log(JSON.stringify(multiWordMeanings, null, 2));
                console.log('===== 映射關係輸出結束 =====\n');
            }

            vocabularyData.forEach(word => {
                // 隨機決定是中選英還是英選中
                const isEnglishToChineseQuestion = Math.random() > 0.5;

                let question, correctAnswer, choices;

                if (isEnglishToChineseQuestion) {
                    // 英選中
                    question = `請選出「${word.word}」的中文意思：`;
                    correctAnswer = word.meaning;
                    
                    // 取得所有可能的錯誤選項（排除所有與該英文單字相關的中文意思）
                    const allMeaningsForWord = wordMeaningMap.get(word.word);
                    const possibleWrongChoices = Array.from(meaningWordMap.keys())
                        .filter(meaning => !allMeaningsForWord.includes(meaning));
                    
                    // 從可能的錯誤選項中隨機選擇3個
                    choices = shuffleArray([...possibleWrongChoices])
                        .slice(0, 3);
                } else {
                    // 中選英
                    question = `請選出「${word.meaning}」的英文：`;
                    correctAnswer = word.word;
                    
                    // 取得所有可能的錯誤選項（排除所有與該中文意思相關的英文單字）
                    const allWordsForMeaning = meaningWordMap.get(word.meaning);
                    const possibleWrongChoices = Array.from(wordMeaningMap.keys())
                        .filter(w => !allWordsForMeaning.includes(w));
                    
                    // 從可能的錯誤選項中隨機選擇3個
                    choices = shuffleArray([...possibleWrongChoices])
                        .slice(0, 3);
                }

                // 如果無法生成足夠的錯誤選項，跳過這個題目
                if (choices.length < 3) {
                    return;
                }

                // 將正確答案加入選項並洗牌
                choices.push(correctAnswer);
                shuffleArray(choices);

                quizQuestions.push({
                    question,
                    choices,
                    correctAnswer,
                    allCorrectAnswers: isEnglishToChineseQuestion 
                        ? wordMeaningMap.get(word.word)
                        : meaningWordMap.get(word.meaning)
                });

                quizAnswers.push(false);
            });

            // 過濾掉無法生成的題目
            quizQuestions = quizQuestions.filter(q => q !== undefined);
            
            // 洗牌題目順序
            shuffleArray(quizQuestions);
        }

        // 顯示測驗題目
        function displayQuizQuestion() {
            if (currentQuizIndex >= quizQuestions.length) {
                // 測驗完成，顯示結果
                showResults();
                return;
            }

            const currentQuestion = quizQuestions[currentQuizIndex];
            questionEl.innerHTML = `<i class="fas fa-question-circle"></i>${currentQuestion.question}`;

            // 清空並重新填充選項
            choicesEl.innerHTML = '';
            currentQuestion.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.innerHTML = `<i class="fas fa-check-circle"></i>${choice}`;
                button.addEventListener('click', handleAnswer);
                choicesEl.appendChild(button);
            });

            // 重設動畫
            quizCard.classList.remove('fade-in');
            void quizCard.offsetWidth; // 觸發 reflow
            quizCard.classList.add('fade-in');
        }

        // 處理選擇題答案
        function handleAnswer(event) {
            const button = event.currentTarget;
            const answer = button.textContent.trim();
            const currentQuestion = quizQuestions[currentQuizIndex];
            // 檢查答案是否在所有正確答案中
            const isCorrect = currentQuestion.allCorrectAnswers.includes(answer);

            // 更新按鈕樣式
            const buttons = choicesEl.querySelectorAll('.choice-btn');
            buttons.forEach(btn => {
                btn.style.pointerEvents = 'none';
                const btnAnswer = btn.textContent.trim();
                const icon = btn.querySelector('i');
                
                // 如果這個選項是任何一個正確答案
                if (currentQuestion.allCorrectAnswers.includes(btnAnswer)) {
                    btn.style.backgroundColor = '#e6ffe6';
                    btn.style.borderColor = '#64bd63';
                    icon.className = 'fas fa-check';
                    icon.style.color = '#64bd63';
                    icon.style.opacity = '1';
                } else if (btn === button && !isCorrect) {
                    btn.style.backgroundColor = '#ffe6e6';
                    btn.style.borderColor = '#ff6b6b';
                    icon.className = 'fas fa-times';
                    icon.style.color = '#ff6b6b';
                    icon.style.opacity = '1';
                }
            });

            // 記錄答案
            quizAnswers[currentQuizIndex] = isCorrect;
            if (isCorrect) {
                correctAnswers++;
            } else {
                // 更新答錯的單字的錯誤計數
                // 獲取當前題目對應的單字
                let wordToUpdate;
                if (currentQuestion.question.includes('英文：')) {
                    // 中選英的題目
                    const chineseMeaning = currentQuestion.question.match(/「(.+?)」/)[1];
                    wordToUpdate = vocabularyData.find(w => w.meaning === chineseMeaning);
                } else {
                    // 英選中的題目
                    const englishWord = currentQuestion.question.match(/「(.+?)」/)[1];
                    wordToUpdate = vocabularyData.find(w => w.word === englishWord);
                }
                
                if (wordToUpdate) {
                    wordErrorCounts[wordToUpdate.word] = (wordErrorCounts[wordToUpdate.word] || 0) + 1;
                }
            }

            // 更新進度條
            const progress = ((currentQuizIndex + 1) / quizQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;

            // 延遲後顯示下一題
            setTimeout(() => {
                buttons.forEach(btn => {
                    btn.style.backgroundColor = '';
                    btn.style.borderColor = '';
                    btn.style.pointerEvents = '';
                    const icon = btn.querySelector('i');
                    icon.className = 'fas fa-check-circle';
                    icon.style.color = '';
                    icon.style.opacity = '0';
                });
                
                currentQuizIndex++;
                if (currentQuizIndex < quizQuestions.length) {
                    displayQuizQuestion();
                } else {
                    showResults();
                }
            }, 1500);
        }

        // 顯示測驗結果
        function showResults() {
            learningSection.classList.add('hidden');
            optionsSection.classList.add('hidden');
            quizSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');

            scoreEl.textContent = `${correctAnswers}/${quizQuestions.length}`;

            if (correctAnswers === quizQuestions.length) {
                // 全部答對
                partialCompleteMsg.classList.add('hidden');
                completeMsg.classList.remove('hidden');
                continueBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                restartBtn.innerHTML = '<i class="fas fa-redo"></i> 全新一局';
                incorrectWordCount = 0; // 沒有答錯的單字
                updateProgressBar(); // 更新進度條為100%
                
                // 停止計時器
                pauseTimer();
                
                // 顯示學習完成時間
                const completionTimeEl = document.getElementById('completion-time');
                if (completionTimeEl) {
                    const seconds = Math.floor(elapsedTime / 1000) % 60;
                    const minutes = Math.floor(elapsedTime / 1000 / 60);
                    completionTimeEl.textContent = `完成時間: ${minutes} 分鐘 ${seconds} 秒`;
                    completionTimeEl.classList.remove('hidden');
                }
            } else {
                // 有答錯
                partialCompleteMsg.classList.remove('hidden');
                completeMsg.classList.add('hidden');
                saveBtn.classList.add('hidden');
                continueBtn.classList.remove('hidden');
                restartBtn.innerHTML = '<i class="fas fa-redo"></i>全新一局';
                
                // 計算答錯的單字數量
                incorrectWordCount = quizAnswers.filter(answer => !answer).length;
                updateProgressBar(); // 更新進度條
            }
        }

        // 繼續學習（複習答錯的單字）
        function continueLearn() {
            // 找出答錯的單字
            const incorrectWords = [];
            for (let i = 0; i < quizAnswers.length; i++) {
                if (!quizAnswers[i]) {
                    // 找到對應的單字資料
                    const question = quizQuestions[i];
                    let wordToReview;
                    
                    if (question.question.includes('英文：')) {
                        // 中選英的題目
                        const chineseMeaning = question.question.match(/「(.+?)」/)[1];
                        wordToReview = vocabularyData.find(w => w.meaning === chineseMeaning);
                    } else {
                        // 英選中的題目
                        const englishWord = question.question.match(/「(.+?)」/)[1];
                        wordToReview = vocabularyData.find(w => w.word === englishWord);
                    }
                    
                    if (wordToReview) {
                        incorrectWords.push(wordToReview);
                    }
                }
            }

            // 設置為當前學習單字
            currentWords = incorrectWords;
            learnedWords = []; // 重置已學會單字
            keepWords = [];
            currentIndex = 0;
            
            // 顯示進度條並歸零
            document.querySelector('.progress-bar').style.display = 'block';
            updateProgressBar();
            
            // 返回學習模式
            learningSection.classList.remove('hidden');
            optionsSection.classList.add('hidden');
            quizSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            
            displayWordCard();
        }

        // 洗牌陣列（Fisher-Yates 演算法）
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 保存紀錄功能
        function showEmailPopup() {
            const popup = document.getElementById('email-popup');
            popup.classList.add('active');
            
            // 設置默認事件標題
            const now = new Date();
            const dateTimeStr = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')}`;
            document.getElementById('email-input').value = `單字學習紀錄 [${dateTimeStr}]`;
            document.getElementById('email-input').focus();
        }

        function hideEmailPopup() {
            const popup = document.getElementById('email-popup');
            popup.classList.remove('active');
            // 清空訊息
            document.getElementById('send-message').style.display = 'none';
        }

        function createCalendarEvent() {
            const eventTitle = document.getElementById('email-input').value.trim() || "單字學習紀錄";
            
            // 生成事件內容
            const eventDetails = generateCalendarEventDetails() + "\n\n" + generateMarkdownAttachment();
            
            // 計算開始和結束時間
            const endTime = new Date(); // 結束時間為當前時間
            const startTime = new Date(endTime - elapsedTime); // 開始時間為結束時間減去學習時間
            
            // 格式化時間為Google日曆格式
            const startTimeStr = formatDateForGoogleCalendar(startTime);
            const endTimeStr = formatDateForGoogleCalendar(endTime);
            
            // 生成Google日曆URL
            const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventTitle)}&details=${encodeURIComponent(eventDetails)}&dates=${startTimeStr}/${endTimeStr}`;
            
            // 在新窗口打開日曆
            window.open(calendarUrl, '_blank');
            
            // 顯示成功訊息
            const messageElement = document.getElementById('send-message');
            messageElement.style.display = 'block';
            
            // 2秒後關閉彈出視窗
            setTimeout(() => {
                hideEmailPopup();
            }, 2000);
        }
        
        // 格式化日期為Google日曆格式（支援時區）
        function formatDateForGoogleCalendar(date) {
            const pad = (num) => (num < 10 ? '0' : '') + num;
            
            // 獲取當地時區的年月日時分秒
            const year = date.getFullYear();
            const month = pad(date.getMonth() + 1);
            const day = pad(date.getDate());
            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());
            const seconds = pad(date.getSeconds());
            
            // 創建日期字符串（不含Z，採用當地時間）
            return year + month + day + 'T' + hours + minutes + seconds;
        }

        // 生成日曆事件詳細內容
        function generateCalendarEventDetails() {
            let details = "單字學習紀錄：\n\n";
            
            // 將單字按答錯次數降序排序
            const sortedVocabulary = [...vocabularyData].sort((a, b) => {
                return (wordErrorCounts[b.word] || 0) - (wordErrorCounts[a.word] || 0);
            });
            
            sortedVocabulary.forEach(word => {
                const errorCount = wordErrorCounts[word.word] || 0;
                details += `${word.word} - ${word.meaning} [答錯次數: ${errorCount}]\n`;
            });
            
            // 添加學習時間
            const seconds = Math.floor(elapsedTime / 1000) % 60;
            const minutes = Math.floor(elapsedTime / 1000 / 60);
            details += `\n學習時間: ${minutes} 分鐘 ${seconds} 秒`;
            
            return details;
        }

        // 生成Markdown附件內容
        function generateMarkdownAttachment() {
            let markdown = "# 單字學習紀錄\n\n";
            markdown += "| 單字 | 發音 | 意思 | 例句 | 翻譯 | 答錯次數 |\n";
            markdown += "|------|------|------|------|------|----------|\n";
            
            // 將單字按答錯次數降序排序
            const sortedVocabulary = [...vocabularyData].sort((a, b) => {
                return (wordErrorCounts[b.word] || 0) - (wordErrorCounts[a.word] || 0);
            });
            
            sortedVocabulary.forEach(word => {
                const errorCount = wordErrorCounts[word.word] || 0;
                markdown += `| ${word.word} | ${word.phonetic} | ${word.meaning} | ${word.example} | ${word.translation} | ${errorCount} |\n`;
            });
            
            return markdown;
        }

        // 事件監聽
        keepBtn.addEventListener('click', () => {
            // 保留當前單字
            keepWords.push(currentWords[currentIndex]);
            currentIndex++;
            displayWordCard();
        });

        gotBtn.addEventListener('click', () => {
            // 學會當前單字
            learnedWords.push(currentWords[currentIndex]);
            currentIndex++;
            updateProgressBar();
            displayWordCard();
        });

        relearnBtn.addEventListener('click', relearn);
        quizBtn.addEventListener('click', startQuiz);
        continueBtn.addEventListener('click', continueLearn);
        restartBtn.addEventListener('click', relearn);

        // 保存紀錄按鈕事件
        const saveBtn = document.getElementById('save-btn');
        saveBtn.addEventListener('click', showEmailPopup);

        // 彈出視窗內的按鈕事件
        const cancelBtn = document.getElementById('cancel-btn');
        const sendBtn = document.getElementById('send-btn');
        const downloadMdBtn = document.getElementById('download-md-btn');
        
        cancelBtn.addEventListener('click', hideEmailPopup);
        sendBtn.addEventListener('click', createCalendarEvent);
        downloadMdBtn.addEventListener('click', downloadMarkdown);

        // 發音按鈕（模擬功能）
        const pronunciationBtns = document.querySelectorAll('.pronunciation');
        pronunciationBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // 僅模擬效果，閃爍按鈕背景
                this.style.backgroundColor = '#4a6cd6';
                const icon = this.querySelector('i');
                icon.style.color = 'white';
                
                setTimeout(() => {
                    this.style.backgroundColor = '';
                    icon.style.color = '#4a6cd6';
                }, 300);
                
                // 可在此處添加實際發音功能
                console.log('發音: ' + wordCard.querySelector('.word').textContent);
            });
        });

        // 下載Markdown文件
        function downloadMarkdown() {
            const eventTitle = document.getElementById('email-input').value.trim() || "單字學習紀錄";
            const markdownContent = generateMarkdownAttachment();
            
            // 建立Blob物件
            const blob = new Blob([markdownContent], { type: 'text/markdown' });
            
            // 建立下載連結
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = `${eventTitle}.md`;
            
            // 模擬點擊下載
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // 釋放URL資源
            URL.revokeObjectURL(downloadLink.href);
            
            // 顯示下載成功訊息
            const messageElement = document.getElementById('download-message');
            messageElement.style.display = 'block';
            
            // 2秒後隱藏成功訊息
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 2000);
        }

        // 初始化應用 - 載入 Google Sheet 資料
        document.addEventListener('DOMContentLoaded', () => {
            // 將 loadingElement 插入到 DOM 中，使用更安全的方式
            try {
                const appElement = document.querySelector('.app');
                if (appElement && appElement.parentNode === document.body) {
                    document.body.insertBefore(loadingElement, appElement);
                } else {
                    // 如果找不到 .app 元素或它不是 body 的直接子元素，則附加到 body 末尾
                    document.body.appendChild(loadingElement);
                }
            } catch (error) {
                console.error("添加載入指示器時出錯:", error);
                // 錯誤處理：確保即使加載指示器失敗，應用也能繼續運行
            }
            
            // 初始化應用
            initializeApp();
        });

        function showStatsPopup() {
            const popup = document.getElementById('stats-popup');
            const statsList = document.getElementById('stats-list');
            const totalWordsEl = document.getElementById('total-words');
            const statsTimeEl = document.getElementById('stats-time');
            
            // 更新總單字數
            totalWordsEl.textContent = vocabularyData.length;
            
            // 更新學習時間
            const seconds = Math.floor(elapsedTime / 1000) % 60;
            const minutes = Math.floor(elapsedTime / 1000 / 60);
            statsTimeEl.textContent = `${minutes} 分鐘 ${seconds} 秒`;
            
            // 清空並重新填充統計列表
            statsList.innerHTML = '';
            
            // 將單字按答錯次數降序排序
            const sortedVocabulary = [...vocabularyData].sort((a, b) => {
                return (wordErrorCounts[b.word] || 0) - (wordErrorCounts[a.word] || 0);
            });
            
            // 生成統計列表
            sortedVocabulary.forEach(word => {
                const errorCount = wordErrorCounts[word.word] || 0;
                const statItem = document.createElement('div');
                statItem.className = 'stat-item';
                statItem.innerHTML = `
                    <div>
                        <div class="stat-word">${word.word}</div>
                        <div class="stat-meaning">${word.meaning}</div>
                    </div>
                    <div class="stat-count">
                        <i class="fas fa-times-circle"></i>
                        <span>${errorCount}</span>
                    </div>
                `;
                statsList.appendChild(statItem);
            });
            
            // 顯示彈出視窗
            popup.classList.add('active');
        }

        function hideStatsPopup() {
            const popup = document.getElementById('stats-popup');
            popup.classList.remove('active');
        }

        // 添加事件監聽器
        document.getElementById('show-stats-btn').addEventListener('click', showStatsPopup);
        document.getElementById('close-stats-btn').addEventListener('click', hideStatsPopup);
    </script>
</body>

</html>