<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>英文單字/例句</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://ys-fang.github.io/quickNav/quicknav.css">
  <!-- CSS Styles -->
  <style>
    /* ===== CSS 變數 ===== */
    :root {
      /* 淺色模式顏色變數 */
      --primary-color: #6366f1;      /* 主色調：現代感的靛藍色 */
      --primary-dark: #4f46e5;
      --primary-light: #c7d2fe;
      --secondary-color: #ec4899;    /* 次要色：活力粉紅 */
      --secondary-dark: #db2777;
      --accent-color: #10b981;       /* 強調色：清新綠 */
      --accent-dark: #059669;
      --video-color: #ff0000;
      --video-dark: #cc0000;
      --warning-color: #ff9800;
      --warning-dark: #fb8c00;
      --highlight-color: #fff59d;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-light: #fff;
      --bg-primary: linear-gradient(135deg, #f8fafc, #f1f5f9);
      --bg-card: #ffffff;
      --bg-toggle: #f8f9fa;
      --border-color: #e0e0e0;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 2px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.3);
      --search-bg: #e3f2fd;
      --suggestion-hover: #f0f0f0;
      --suggestion-active: #e0e0e0;
      --disabled-bg: #e9ecef;
      --disabled-text: #6c757d;
      --toggle-hover-bg: #e9ecef;
      --toggle-hover-color: #495057;
      --toggle-border: #dee2e6;
      --header-bg: rgba(255, 255, 255, 0.9);
      
      /* 尺寸變數 */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 20px;
      --border-radius-sm: 4px;
      --border-radius-md: 6px;
      --border-radius-lg: 8px;
      --border-radius-xl: 20px;
      --font-size-sm: 0.9em;
      --font-size-md: 1em;
      --font-size-lg: 1.1em;
      --font-size-xl: 1.4em;
      --btn-height-sm: 36px;
      --btn-height-md: 48px;
    }

    /* 深色模式顏色變數 */
    [data-theme="dark"] {
      --primary-color: #818cf8;      /* 柔和的靛藍 */
      --primary-dark: #6366f1;
      --primary-light: #a5b4fc;
      --secondary-color: #f472b6;    /* 柔和的粉紅 */
      --secondary-dark: #ec4899;
      --accent-color: #34d399;       /* 明亮的綠 */
      --accent-dark: #10b981;
      --video-color: #f44336;
      --video-dark: #e53935;
      --warning-color: #ffa726;
      --warning-dark: #fb8c00;
      --highlight-color: #827717;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-light: #f5f5f5;
      --bg-primary: linear-gradient(135deg, #0f172a, #1e293b);
      --bg-card: #1e293b;
      --bg-toggle: #616161;
      --border-color: #757575;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
      --shadow-md: 0 2px 6px rgba(0,0,0,0.4);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.5);
      --search-bg: #455a64;
      --suggestion-hover: #546e7a;
      --suggestion-active: #607d8b;
      --disabled-bg: #616161;
      --disabled-text: #9e9e9e;
      --toggle-hover-bg: #757575;
      --toggle-hover-color: #bdbdbd;
      --toggle-border: #9e9e9e;
      --header-bg: rgba(66, 66, 66, 0.9);
    }

    /* ===== 基礎樣式 ===== */
    body { 
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      color: var(--text-primary);
    }
    
    #app-container {
      top: 0;
      left: 0;
      right: 0;
      position: fixed;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: auto;
      background: var(--bg-primary);
    }
    
    h1 { 
      text-align: center; 
      font-size: var(--font-size-md); 
      color: var(--primary-color); 
      margin: 0px 0 20px; 
      position: fixed;
      top: 0; 
      left: 50%; 
      transform: translateX(-50%);
      width: 100%; 
      background: var(--header-bg);
      z-index: 900;
      padding: var(--spacing-sm) 0;
    }

    /* ===== 按鈕樣式 ===== */
    button { 
      padding: var(--spacing-sm) var(--spacing-md); 
      border: none; 
      border-radius: var(--border-radius-sm); 
      cursor: pointer; 
      transition: background 0.3s, transform 0.2s; 
      font-size: var(--font-size-sm);
      width: 100%;
    }
    
    #download-all-btn { 
      display: none; 
      background: var(--primary-color); 
      color: var(--text-light); 
      margin: 0 auto; 
    }
    
    #download-all-btn:hover { 
      background: var(--primary-dark); 
    }

    /* 通用按鈕樣式 */
    .btn-common,
    a.btn-common {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-sm);
      text-decoration: none !important;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      height: var(--btn-height-sm);
      min-width: 100px;
      color: var(--text-light) !important;
      font-weight: 600;
      letter-spacing: 0.025em;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .btn-common i,
    a.btn-common i {
      font-size: var(--font-size-lg);
    }
    
    .btn-common:not([disabled]):hover,
    a.btn-common:not([disabled]):hover {
      transform: translateY(-1px);
      text-decoration: none !important;
      color: var(--text-light) !important;
    }
    
    .btn-common[disabled],
    a.btn-common[disabled] {
      background: var(--disabled-bg) !important;
      color: var(--disabled-text) !important;
      cursor: not-allowed;
    }

    /* 發音按鈕 */
    .pronounce-btn,
    button.pronounce-btn,
    a.pronounce-btn {
      background: var(--accent-color);
      color: white;
    }
    
    .pronounce-btn:not([disabled]):hover,
    button.pronounce-btn:not([disabled]):hover,
    a.pronounce-btn:not([disabled]):hover {
      background: var(--accent-dark);
    }

    /* 混合發音按鈕 */
    .combined-btn,
    button.combined-btn,
    a.combined-btn {
      background: var(--secondary-color);
      color: white;
    }
    
    .combined-btn:not([disabled]):hover,
    button.combined-btn:not([disabled]):hover,
    a.combined-btn:not([disabled]):hover {
      background: var(--secondary-dark);
    }

    /* 影片按鈕 */
    .video-btn,
    button.video-btn,
    a.video-btn {
      background: var(--video-color) !important;
    }
    
    .video-btn:not([disabled]):hover,
    button.video-btn:not([disabled]):hover,
    a.video-btn:not([disabled]):hover {
      background: var(--video-dark) !important;
    }

    /* ===== 表格樣式 ===== */
    .container { 
      margin: var(--spacing-xl) 0; 
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: var(--bg-card); 
      box-shadow: var(--shadow-md);
      border-radius: var(--border-radius-lg);
    }
    
    #table-container {
      overflow-x: auto;
      width: 100%;
      margin-bottom: 7em;
      margin-top: 7em;
      padding: var(--spacing-xl);
    }
    
    th, td { 
      padding: var(--spacing-sm); 
      border: 1px solid var(--border-color); 
      text-align: center; 
      white-space: nowrap;
      word-break: keep-all; 
      overflow-x: auto; 
    }
    
    th { 
      background: var(--primary-light); 
      font-weight: 600; 
    }
    
    .col-download, .col-combined-download { 
      display: none; 
    }
    
    /* ===== 卡片樣式 ===== */
    #card-container {
      margin-bottom: 10em;
      margin-top: 5em;
      padding: var(--spacing-xl);
    }
    
    .vocab-card { 
      background: var(--bg-card); 
      border-radius: var(--border-radius-lg); 
      padding: var(--spacing-lg); 
      margin: var(--spacing-xl) 0; 
      box-shadow: var(--shadow-md); 
      transition: all 0.3s ease; 
    }
    
    .vocab-card.expanded {
      background-color: var(--bg-card);
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }
    
    .vocab-card:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .vocab-card h3 { 
      margin: 0 0 10px; 
      font-size: var(--font-size-xl); 
      color: var(--primary-color); 
      white-space: nowrap;
      word-break: keep-all; 
      overflow-x: auto; 
    }
    
    .vocab-info p { 
      margin: 5px 0; 
      font-size: 0.95em; 
      white-space: nowrap;
      word-break: keep-all; 
      overflow-x: auto; 
    }

    /* 卡片內容切換 */
    .vocab-card .toggle-content {
      display: none;
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--border-color);
      opacity: 0;
      height: 0;
      overflow: hidden;
      transition: opacity 0.3s ease, height 0s ease 0.3s;
    }
    
    .vocab-card .toggle-content.show {
      display: block;
      opacity: 1;
      height: auto;
      background-color: var(--bg-toggle);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-md);
      margin-top: var(--spacing-md);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      transition: opacity 0.3s ease;
    }
    
    .vocab-card .toggle-btn {
      background: var(--bg-toggle);
      color: var(--text-secondary);
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-lg);
      border: 1px solid var(--toggle-border);
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .vocab-card .toggle-btn:hover {
      background: var(--toggle-hover-bg);
      color: var(--toggle-hover-color);
      border-color: var(--toggle-border);
    }
    
    .vocab-card .toggle-btn i {
      transition: transform 0.3s ease;
    }
    
    .vocab-card .toggle-btn.active i {
      transform: rotate(180deg);
    }

    /* 卡片按鈕組 */
    .vocab-card .button-group {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
      align-items: center;
      flex-wrap: wrap;
    }
    
    .vocab-card .button-group button:not(.toggle-btn),
    .vocab-card .button-group a {
      flex: 1;
      min-width: 120px;
    }
    
    .vocab-card .button-container {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }
    
    .vocab-card .button-row {
      display: flex;
      gap: var(--spacing-sm);
      width: 100%;
    }

    /* ===== 功能區域樣式 ===== */
    /* 搜尋區域 */
    #search-container { 
      position: fixed;
      top: 60px; 
      left: 50%; 
      transform: translateX(-50%);
      background: var(--search-bg); 
      border: 2px solid var(--primary-color); 
      padding: var(--spacing-sm); 
      border-radius: var(--border-radius-md); 
      box-shadow: var(--shadow-sm); 
      gap: var(--spacing-sm); 
      margin: 0 auto; 
      max-width: 90%; 
      width: 320px;
      z-index: 1000;
      display: none;
    }
    
    #search-input { 
      flex: 1; 
      padding: 6px; 
      border: 1px solid var(--border-color); 
      border-radius: var(--border-radius-sm); 
      font-size: var(--font-size-sm); 
      width: 200px;
    }
    
    #search-btn { 
      background: var(--primary-color); 
      color: var(--text-light); 
    }
    
    #search-btn:hover { 
      background: var(--primary-dark); 
    }

    /* 建議列表 */
    #suggestion-list {
      position: absolute;
      top: calc(100% + 2px);
      left: 0;
      right: 0;
      background-color: var(--bg-card);
      border: 1px solid var(--border-color);
      margin-top: 2px;
      max-height: 200px; 
      overflow-y: auto;
      z-index: 1001;
      display: none;
      border-radius: var(--border-radius-sm);
    }
    
    #suggestion-list div {
      padding: var(--spacing-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    
    #suggestion-list div::before {
      content: '\f054';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-right: 5px;
      font-size: 0.8em;
      color: var(--primary-color);
    }
    
    #suggestion-list div:hover {
      background-color: var(--suggestion-hover);
    }
    
    #suggestion-list div.active {
      background-color: var(--suggestion-active);
    }

    /* 語音控制區 */
    #voice-toggle-container {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--search-bg);
      border: 2px solid var(--primary-color);
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-sm);
      z-index: 10;
      text-align: center; 
      max-width: 90%; 
      width: 320px;
      display: none;
    }
    
    #voice-toggle-container label { 
      font-size: var(--font-size-sm); 
      color: var(--text-secondary); 
    }
    
    #speed-control {
      display: flex;
      justify-content: center; 
      gap: 5px;
      margin-top: 5px;
    }

    /* 全部展開按鈕 */
    #toggle-all-btn {
      position: fixed;
      bottom: 0px;
      right: 0px;
      z-index: 1000;
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: var(--border-radius-sm);
      background: var(--primary-color);
      color: var(--text-light);
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: var(--font-size-sm);
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
    }
    
    #toggle-all-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    #toggle-all-btn i {
      transition: transform 0.3s ease;
    }
    
    #toggle-all-btn.active i {
      transform: rotate(180deg);
    }

    /* ===== 狀態指示器 ===== */
    #loadingPlacholder, #userIsNotLogin, #audio-loading { 
      text-align: center; 
      font-size: var(--font-size-lg); 
      color: var(--text-secondary); 
    }
    
    #loadingPlacholder {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-card);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      z-index: 1000;
    }
    
    #userIsNotLogin a { 
      color: var(--primary-color); 
      text-decoration: underline; 
    }
    
    #userIsNotLogin, #userIsLogin { 
      display: none; 
    }
    
    #audio-loading { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: rgba(0,0,0,0.8); 
      color: var(--text-light); 
      padding: 10px 20px; 
      border-radius: var(--border-radius-md); 
      display: none; 
      z-index: 20; 
    }
    
    .highlight { 
      position: relative;
      display: inline-block; /* 使得 ::after 可以正確定位 */
      text-decoration: underline;
      color: var(--text-primary);
    }

    .highlight::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0; /* 在文字底部 */
      height: 100%; /* 與文字高度相同 */
      width: 100%; /* 初始寬度 */
      background-color: rgba(255, 255, 0, 0.5); /* 黃色螢光筆顏色 */
      transform: scaleX(0); /* 初始狀態為隱藏 */
      transform-origin: left; /* 從左側開始動畫 */
      transition: transform 0.3s ease; /* 動畫過渡效果 */
    }

    .highlight:hover::after {
      transform: scaleX(1); /* 懸停時顯示 */
    }

    /* ===== 響應式設計 ===== */
    @media (max-width: 767px) { 
      /* 移動裝置顯示卡片，隱藏表格 */
      #table-container { display: none; }
      #card-container { display: block; }
      #toggle-all-btn { display: flex; }
      
      /* 按鈕尺寸調整 */
      button { 
        padding: var(--spacing-md); 
        font-size: var(--font-size-md); 
      }
      
      /* 卡片按鈕調整 */
      .vocab-card .toggle-btn {
        width: var(--btn-height-md);
        height: var(--btn-height-md);
        font-size: 1.2em;
      }
      
      .vocab-card .btn-common,
      .vocab-card a.btn-common {
        height: var(--btn-height-md);
        font-size: var(--font-size-md);
        padding: var(--spacing-sm) var(--spacing-lg);
      }
      
      .vocab-card .btn-common i,
      .vocab-card a.btn-common i {
        font-size: 1.2em;
      }
      
      /* 功能區域調整 */
      #search-container { 
        padding: var(--spacing-md); 
        max-width: 85%;
      }
      
      #voice-toggle-container {
        max-width: 85%; 
        padding: var(--spacing-md);
        flex-direction: column;
        align-items: center;
        bottom: 45px;
      }
            
      /* 文字換行處理 */
      th, td, .vocab-card h3, .vocab-info p { 
        white-space: normal;
        word-break: keep-all; 
        overflow-x: hidden; 
      }
      
      /* 卡片模式下的文字大小調整 */
      .vocab-card h3 { 
        font-size: calc(var(--font-size-xl) * 0.75); 
      }
      
      .vocab-card .vocab-info p,
      .vocab-card .toggle-content p { 
        font-size: calc(0.95em * 0.75); 
      }
      
      .vocab-card .btn-common,
      .vocab-card a.btn-common {
        font-size: calc(var(--font-size-md) * 0.75);
      }
      
      .vocab-card .btn-common i,
      .vocab-card a.btn-common i {
        font-size: calc(1.2em * 0.75);
      }
      
      .vocab-card .toggle-btn {
        font-size: calc(1.2em * 0.75);
      }

      .vocab-card {
        padding: 1rem;
        margin: 0.75rem 0;
      }
      
      .vocab-card h3 {
        font-size: 1.5rem;
      }

    }
    
    @media (min-width: 768px) { 
      /* 桌面顯示表格，隱藏卡片 */
      #table-container { display: block; }
      #card-container { display: none; }
      #toggle-all-btn { display: none; }
    }

    /* ===== 主題切換按鈕 ===== */
    #theme-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1001;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-color);
      color: var(--text-light);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
    }
    
    @media (max-width: 767px) {
      #theme-toggle {
        top: 5px;
        right: 5px;
        width: 36px;
        height: 36px;
      }
    }
    
    #theme-toggle:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    #theme-toggle i {
      font-size: 1.2em;
    }
    
    /* 深色模式下的特殊樣式調整 */
    [data-theme="dark"] .vocab-card .toggle-content.show {
      background-color: var(--bg-toggle);
      box-shadow: inset 0 1px 3px rgba(255,255,255,0.05);
    }
    
    [data-theme="dark"] #audio-loading {
      background: rgba(0,0,0,0.7);
    }
    
    /* 深色模式下的表格樣式調整 */
    [data-theme="dark"] th {
      color: var(--text-light);
    }
    
    /* 按鈕點擊效果 */
    .btn-common:active {
      transform: scale(0.98);
    }

    /* 展開內容過渡效果 */
    .toggle-content {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #userIsNotLogin {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }
    
    /* 單字牆按鈕樣式 */
    .btn-word-wall {
      background: linear-gradient(45deg, #6366f1, #4f46e5);
      color: var(--text-light);
      border: none;
      border-radius: var(--border-radius-md);
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: var(--font-size-sm);
      display: block;
      gap: var(--spacing-sm);
      cursor: pointer;
      transition: all 0.3s ease;
      height: var(--btn-height-sm);
      width: 150px;
      font-weight: 600;
      letter-spacing: 0.025em;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: var(--spacing-md);
    }
    
    .btn-word-wall:hover:not(:disabled) {
      transform: translateY(-2px);
      background: linear-gradient(45deg, #4f46e5, #4338ca);
    }
    
    .btn-word-wall:disabled {
      background: linear-gradient(45deg, #64748b, #475569);
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
  </style>
  <!-- External Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.0/lame.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://ys-fang.github.io/quickNav/quicknav.js"></script>
</head>
<body>
  <div id="app-container"> <!-- 新增的 div -->
    <h1><i class="fas fa-language"></i> 英文單字/例句聽讀</h1>
    <button id="download-all-btn"><i class="fas fa-download"></i> 下載全部混合音檔</button>
    <div id="loadingPlacholder"><i class="fas fa-spinner fa-pulse"></i> 載入中...</div>
    <!-- Audio loading indicator -->
    <div id="audio-loading"><i class="fas fa-cog fa-spin"></i> 語音合成中...</div>
    <div id="userIsNotLogin">
      請先<a id="loginLink" href="#"><i class="fas fa-sign-in-alt"></i> 註冊/登入均一帳號</a>，來使用 AI 語音合成功能。
    </div>
    <div id="userIsLogin">
      <div id="table-container" class="container"></div>
      <div id="card-container" class="container"></div>
      <button id="toggle-all-btn" class="btn-common">
        <i class="fas fa-chevron-down"></i>
        <span>完整模式</span>
      </button>
      <audio id="audio_output" controls style="display: none;"></audio>
    </div>
    <!-- Search Container -->
    <div id="search-container">
      <input type="text" id="search-input" placeholder="輸入單字..." aria-label="搜尋單字">
      <button id="search-btn"><i class="fas fa-search"></i></button>
      <!-- Suggestion Container -->
      <div id="suggestion-list"></div>
    </div>
    <!-- Voice Selection Container -->
    <div id="voice-toggle-container">
      <div>
        <label><i class="fas fa-microphone-alt"></i> 語音: </label>
        <input type="radio" name="voice" value="male" id="voiceMale" checked><label for="voiceMale">男聲</label>
        <input type="radio" name="voice" value="female" id="voiceFemale"><label for="voiceFemale">女聲</label>
      </div>
      <div id="speed-control">
        <label><i class="fas fa-tachometer-alt"></i> 語速:</label>
        <input type="range" id="speed-slider" min="0.5" max="2" step="0.1" value="1">
        <span id="speed-value">1.0</span>x
      </div>
    </div>
    <!-- Theme Toggle Button -->
    <button id="theme-toggle">
      <i class="fas fa-moon"></i>
    </button>
  </div> <!-- app-container 結束 -->
  <script>
    // ======= Core Application Script =======
    
    // Constants and initial setup
    const MALE_VOICE = "en-US-ChristopherNeural", FEMALE_VOICE = "en-US-NancyNeural";
    const SILENCE_DURATION_1 = 1.0, SILENCE_DURATION_1_5 = 1.5, MP3_BITRATE = 128;
    const audio = document.getElementById("audio_output");
    
    // Global variables
    let selectedVoice = MALE_VOICE; // default
    let finalData = [];
    let ttsCache = {};
    
    // Generate login link based on current URL
    const currentUrl = encodeURIComponent(window.location.href);
    const loginLink = document.getElementById("loginLink");
    loginLink.href = `https://www.junyiacademy.org/login?continue=${currentUrl}`;

    // ======= Audio Utility Functions =======
    
    // Convert Float32 to Int16
    const convertFloat32ToInt16 = buffer => {
      const out = new Int16Array(buffer.length);
      for (let i = 0; i < buffer.length; i++) {
        let s = Math.max(-1, Math.min(1, buffer[i]));
        s = s < 0 ? s * 0x8000 : s * 0x7FFF;
        out[i] = s;
      }
      return out;
    };

    // Convert AudioBuffer to MP3 Blob
    const audioBufferToMp3 = buffer => {
      const encoder = new lamejs.Mp3Encoder(buffer.numberOfChannels, buffer.sampleRate, MP3_BITRATE);
      const data = [];
      const blockSize = 1152;
      const channelData = [
        buffer.getChannelData(0),
        buffer.numberOfChannels === 2 ? buffer.getChannelData(1) : null
      ];

      let mp3buf;
      for (let i = 0; i < channelData[0].length; i += blockSize) {
        const leftChunk = convertFloat32ToInt16(channelData[0].subarray(i, i + blockSize));
        if (channelData[1]) {
          const rightChunk = convertFloat32ToInt16(channelData[1].subarray(i, i + blockSize));
          mp3buf = encoder.encodeBuffer(leftChunk, rightChunk);
        } else {
          mp3buf = encoder.encodeBuffer(leftChunk);
        }
        if (mp3buf.length) data.push(new Int8Array(mp3buf));
      }
      mp3buf = encoder.flush();
      if (mp3buf.length) data.push(new Int8Array(mp3buf));
      return new Blob(data, { type: 'audio/mp3' });
    };

    // Loading indicators
    const showLoading = () => document.getElementById("audio-loading").style.display = "block";
    const hideLoading = () => document.getElementById("audio-loading").style.display = "none";

    // ======= TTS Functions =======
    
    // Generate TTS text from row data
    function getTtsText(rowData) {
      // 只發音單字，不包含例句
      return rowData[0] || "";
    }
    
    // Generate single audio segment
    async function generateAudio(text, play = true, selectedVoice) {
      showLoading();
      const key = `${text}_${selectedVoice}`;
      if (ttsCache[key]) {
        audio.src = ttsCache[key];
        hideLoading();
        if (play) {
          audio.playbackRate = document.getElementById("speed-slider").value;
          audio.play();
        }
        return ttsCache[key];
      }
      if (!audio.paused) {
        audio.pause();
        audio.currentTime = 0;
      }
      // 取得 xsrfToken
      let xsrfToken = /fkey=([^;]*)/.exec(document.cookie)?.[1] || null;

      try {
        const res = await fetch("/api/v2/jutor/tts", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json", 
            "X-KA-FKey": xsrfToken 
          },
          body: JSON.stringify({
            text,
            "lang": selectedVoice.slice(0, 5),
            voice_name: selectedVoice,
            format: "mp3" 
          })
        });
        const { data } = await res.json();
        if (data?.audio_data) {
          const src = `data:audio/mp3;base64,${data.audio_data}`;
          ttsCache[key] = src;
          audio.src = src;
          audio.playbackRate = document.getElementById("speed-slider").value;
          hideLoading();
          if (play) audio.play();
          return src;
        }
      } catch (e) {
        console.error("TTS Error:", e);
      }
      hideLoading();
      return null;
    }

    // Generate audio segment for combining
    async function generateAudioSegment(text, voice) {
      const key = `${text}_${voice}`;
      if (ttsCache[key]) return ttsCache[key];

      let xsrfToken = /fkey=([^;]*)/.exec(document.cookie)?.[1] || null;
      try {
        const res = await fetch("/api/v2/jutor/tts", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-KA-FKey": xsrfToken
          },
          body: JSON.stringify({
            text,
            lang: voice.slice(0, 5),
            voice_name: voice,
            format: "mp3"
          })
        });
        const { data } = await res.json();
        if (data?.audio_data) {
          const src = `data:audio/mp3;base64,${data.audio_data}`;
          ttsCache[key] = src;
          return src;
        }
      } catch (e) {
        console.error("Segment Error:", e);
      }
      return null;
    }

    // Generate combined audio: male voice + female voice + sentence male voice + female voice with silence in between
    async function generateCombinedAudio(row, selectedVoice) {
      showLoading();
      // row = [英文, KK音標, 中譯, 例句, 翻譯]
      const [vocab, , , sentence] = row.map(v => v?.trim() || "");
      const [mVocab, fVocab, mSentence, fSentence] = await Promise.all([
        generateAudioSegment(vocab, MALE_VOICE),
        generateAudioSegment(vocab, FEMALE_VOICE),
        generateAudioSegment(sentence, MALE_VOICE),
        generateAudioSegment(sentence, FEMALE_VOICE)
      ]);
      if (!mVocab || !fVocab || !mSentence || !fSentence) {
        console.error("Segment failed");
        hideLoading();
        return null;
      }
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const buffers = await Promise.all([
        mVocab, fVocab, mSentence, fSentence
      ].map(b => {
        const byteString = atob(b.split(',')[1]);
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        return audioCtx.decodeAudioData(ab);
      }));

      const silences = [
        SILENCE_DURATION_1, SILENCE_DURATION_1_5,
        SILENCE_DURATION_1, SILENCE_DURATION_1_5
      ].map(d => audioCtx.createBuffer(2, d * buffers[0].sampleRate, buffers[0].sampleRate));

      const totalLength = buffers.reduce((sum, b) => sum + b.length, 0) +
                          silences.reduce((sum, s) => sum + s.length, 0);
      const output = audioCtx.createBuffer(2, totalLength, buffers[0].sampleRate);
      let offset = 0;
      [buffers[0], silences[0], buffers[1], silences[1],
       buffers[2], silences[2], buffers[3], silences[3]
      ].forEach(b => {
        for (let ch = 0; ch < 2; ch++) {
          // 若 b 只有 1 channel，第二聲道複製第一聲道
          output.getChannelData(ch).set(b.getChannelData(Math.min(ch, b.numberOfChannels - 1)), offset);
        }
        offset += b.length;
      });

      const url = URL.createObjectURL(audioBufferToMp3(output));
      hideLoading();
      return url;
    }

    // Download all combined audio files
    async function downloadAllCombinedAudios(batchSize = 20) {
      // finalData[0] 是表頭，故從 i=1 開始
      let count = 0;
      for (let i = 1; i < finalData.length; i++) {
        // 如果該列空白就跳過
        if (!finalData[i].some(c => c.trim())) continue;
        const url = await generateCombinedAudio(finalData[i]);
        if (url) {
          const a = document.createElement("a");
          a.href = url;
          a.download = `${finalData[i][0]}_combined.mp3`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          count++;
          // 每次下載 batchSize 筆，就詢問使用者是否繼續
          if (count % batchSize === 0 && i < finalData.length - 1) {
            if (!confirm(`已下載 ${count} 筆，繼續？`)) break;
          }
        } else {
          console.error(`Failed at index ${i}`);
        }
      }
    }


    // ======= UI Rendering Functions =======
    
    // Render table view
    function renderTable(data) {
      const container = document.getElementById('table-container');
      container.innerHTML = "";
      
      // 添加單字牆按鈕
      const wordWallBtn = document.createElement('button');
      wordWallBtn.id = 'word-wall-btn';
      wordWallBtn.className = 'btn-word-wall';
      wordWallBtn.innerHTML = '<i class="fas fa-th"></i> 單字牆 <i class="fas fa-external-link-alt" style="font-size: 0.8em; margin-left: 4px;"></i>';
      
      // 立即綁定點擊事件
      wordWallBtn.addEventListener('click', function() {
        // 獲取當前頁面的 label 參數
        const urlParams = new URLSearchParams(window.location.search);
        const labelParam = urlParams.get('label');
        
        if (labelParam) {
          // 使用相對路徑，確保在平行目錄結構下正確導向
          window.location.href = `../vocabWall/?label=${encodeURIComponent(labelParam)}`;
        } else {
          alert('請提供標籤參數 (label)');
        }
      });
      
      container.appendChild(wordWallBtn);
      
      const table = document.createElement('table');

      // 定義新的表頭順序
      const newHeader = [
        "英文",
        "KK音標",
        "中譯",
        "單字發音",
        "例句",
        "翻譯",
        "混合發音",
        "講解影片"
      ];

      // 組合表頭 HTML
      const headerRow = `<tr>
        ${newHeader.map(h => `<th>${h}</th>`).join('')}
      </tr>`;

      // 組合資料列
      const bodyRows = data.slice(1).filter(r => r.some(c => c.trim())).map(row => {
        // 處理例句標記
        let markedExample = row[3];
        if (row[3] && row[6] && row[7]) { // row[6] 是 mark_start, row[7] 是 mark_end
          const words = row[3].split(' ');
          const start = parseInt(row[6]) - 1; // 轉換為 0-based 索引
          const end = parseInt(row[7]) - 1;
          
          if (!isNaN(start) && !isNaN(end) && start >= 0 && end < words.length) {
            words[start] = `<span class="highlight">${words[start]}`;
            words[end] = `${words[end]}</span>`;
            markedExample = words.join(' ');
          }
        }

        return `
          <tr>
            <td>${row[0]}</td>
            <td>${row[1]}</td>
            <td>${row[2]}</td>
            <td><button class="pronounce-btn btn-common"><i class="fas fa-volume-up"></i> 單字發音</button></td>
            <td>${markedExample}</td>
            <td>${row[4]}</td>
            <td><button class="combined-btn btn-common"><i class="fas fa-exchange-alt"></i> 混合發音</button></td>
            <td>
              ${row[5] ? 
                `<button class="video-btn btn-common" onclick="window.open('https://www.youtube.com/watch?v=${row[5]}', '_blank')">
                  <i class="fab fa-youtube"></i> 講解影片
                </button>` : 
                `<button class="video-btn btn-common" disabled>N/A</button>`
              }
            </td>
          </tr>
        `;
      }).join('');
      
      table.innerHTML = headerRow + bodyRows;
      container.appendChild(table);

      // 綁定事件：對發音、混合發音按鈕
      table.querySelectorAll('.pronounce-btn').forEach((btn, i) => {
        btn.addEventListener('click', () => {
          const rowData = data[i + 1];
          const textToSpeak = getTtsText(rowData);
          generateAudio(textToSpeak, true, selectedVoice);
        });
      });

      table.querySelectorAll('.combined-btn').forEach((btn, i) => {
        btn.addEventListener('click', async () => {
          const rowData = data[i + 1];
          const url = await generateCombinedAudio(rowData, selectedVoice);
          if (url) {
            audio.src = url;
            audio.playbackRate = document.getElementById("speed-slider").value;
            audio.play();
          }
        });
      });
    }

    // Render card view
    function renderCards(data) {
      const container = document.getElementById('card-container');
      container.innerHTML = "";
      const cards = data.slice(1).filter(r => r.some(c => c.trim())).map(row => {
        // 處理例句標記
        let markedExample = row[3];
        if (row[3] && row[6] && row[7]) { // row[6] 是 mark_start, row[7] 是 mark_end
          const words = row[3].split(' ');
          const start = parseInt(row[6]) - 1; // 轉換為 0-based 索引
          const end = parseInt(row[7]) - 1;
          
          if (!isNaN(start) && !isNaN(end) && start >= 0 && end < words.length) {
            words[start] = `<span class="highlight">${words[start]}`;
            words[end] = `${words[end]}</span>`;
            markedExample = words.join(' ');
          }
        }

        return `
        <div class="vocab-card">
          <h3>${row[0]}</h3>
          <div class="vocab-info">
            <p>${row[1]}</p>
            <p>${row[2]}</p>
          </div>
          <div class="button-group">
            <button class="pronounce-btn btn-common">
              <i class="fas fa-volume-up"></i>
              <span>單字發音</span>
            </button>
            <button class="toggle-btn" aria-label="展開更多內容">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>
          <div class="toggle-content">
            <p><strong>${markedExample}</strong></p>
            <p>${row[4]}</p>
            <div class="button-group">
              <button class="combined-btn btn-common">
                <i class="fas fa-exchange-alt"></i>
                <span>混合發音</span>
              </button>
              ${row[5] ? 
                `<button class="video-btn btn-common" onclick="window.open('https://www.youtube.com/watch?v=${row[5]}', '_blank')">
                  <i class="fab fa-youtube"></i> 講解影片
                </button>` : 
                `<button class="video-btn btn-common" disabled>N/A</button>`
              }
            </div>
          </div>
        </div>
      `;
      }).join('');
      container.innerHTML = cards;

      // Set up voice for each card
      const cardElements = container.querySelectorAll('.vocab-card');
      cardElements.forEach((card, i) => {
        const rowData = data[i + 1];
        const textToSpeak = getTtsText(rowData);

        // 發音
        card.querySelector('.pronounce-btn').addEventListener('click', () => {
          generateAudio(textToSpeak, true, selectedVoice);
        });
        // 混合發音
        card.querySelector('.combined-btn').addEventListener('click', async () => {
          const url = await generateCombinedAudio(rowData, selectedVoice);
          if (url) {
            audio.src = url;
            audio.playbackRate = document.getElementById("speed-slider").value;
            audio.play();
          }
        });
        // 切換顯示更多內容
        const toggleBtn = card.querySelector('.toggle-btn');
        const toggleContent = card.querySelector('.toggle-content');
        toggleBtn.addEventListener('click', () => {
          toggleContent.classList.toggle('show');
          toggleBtn.classList.toggle('active');
          // 為卡片添加展開狀態的視覺效果
          card.classList.toggle('expanded');
          
          // 添加平滑滾動到展開的卡片
          if (toggleContent.classList.contains('show')) {
            // 給內容區域一個淡入效果
            toggleContent.style.opacity = '0';
            setTimeout(() => {
              toggleContent.style.opacity = '1';
            }, 50);
            
            // 滾動到展開的卡片
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      });
    }

    // ======= Data Functions =======
    
    // Load data from Google Sheets
    async function loadSheetData(label, spreadsheetUrl) {
      try {
        document.getElementById("loadingPlacholder").style.display = "block";
        const response = await fetch(spreadsheetUrl);
        if (!response.ok) throw new Error("無法載入試算表資料");
        const csvText = await response.text();
        if (!csvText.trim()) throw new Error("試算表內容為空");

        // 解析 CSV
        const { data } = Papa.parse(csvText, { header: false });
        if (!data || data.length === 0) throw new Error("解析後的資料為空");

        // 取表頭
        const header = data.shift();
        if (!header) throw new Error("無法提取表頭，資料格式可能有誤");

        // 過濾資料：只保留第一欄 (Label) 符合的
        const filteredData = data.filter(row => row[0].toLowerCase() === label.toLowerCase());
        // 去除每行的第一欄 (Label)
        const processedHeader = header.slice(1);
        const processedData = filteredData.map(row => row.slice(1));

        // 組合成最終資料
        finalData = [processedHeader, ...processedData];
        
        // 渲染
        renderTable(finalData);
        renderCards(finalData);
        
        document.getElementById("loadingPlacholder").style.display = "none";
      } catch (error) {
        console.error("載入資料失敗:", error);
        document.getElementById("loadingPlacholder").textContent = `載入資料失敗：${error.message}`;
      }
    }

    // Get URL parameter
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Search function with highlighting
    function search() {
      const query = document.getElementById("search-input").value.trim().toLowerCase();
      if (!query) return;
      let found = false;

      // 針對表格模式
      if (window.getComputedStyle(document.getElementById("table-container")).display !== "none") {
        const rows = document.querySelectorAll("#table-container tr:not(:first-child)");
        rows.forEach(tr => {
          const word = tr.cells[0].textContent.trim().toLowerCase();
          if (!found && word === query) {
            tr.scrollIntoView({ behavior: "smooth", block: "center" });
            tr.classList.add("highlight");
            setTimeout(() => tr.classList.remove("highlight"), 2000);
            found = true;
          }
        });
      } else {
        // 卡片模式
        const cards = document.querySelectorAll(".vocab-card");
        cards.forEach(card => {
          const word = card.querySelector("h3").textContent.trim().toLowerCase();
          if (!found && word === query) {
            card.scrollIntoView({ behavior: "smooth", block: "center" });
            card.classList.add("highlight");
            setTimeout(() => card.classList.remove("highlight"), 2000);
            found = true;
          }
        });
      }

      if (!found) {
        document.getElementById("search-input").value = "";
        document.getElementById("search-input").placeholder = "無匹配";
      }
    }

    // ======= Main Application Entry Point =======
    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("loadingPlacholder").style.display = "none";

      // Expand/collapse all cards functionality
      const toggleAllBtn = document.getElementById('toggle-all-btn');
      let isAllExpanded = false;

      toggleAllBtn.addEventListener('click', () => {
        const allToggleContents = document.querySelectorAll('.toggle-content');
        const allToggleButtons = document.querySelectorAll('.toggle-btn');
        isAllExpanded = !isAllExpanded;

        allToggleContents.forEach(content => {
          if (isAllExpanded) {
            content.classList.add('show');
          } else {
            content.classList.remove('show');
          }
        });

        allToggleButtons.forEach(btn => {
            if (isAllExpanded) {
            btn.classList.add('active');
            } else {
            btn.classList.remove('active');
          }
        });

        // 更新按鈕文字和狀態
        toggleAllBtn.innerHTML = isAllExpanded ?
          '<i class="fas fa-chevron-up"></i><span>單字模式</span>' :
          '<i class="fas fa-chevron-down"></i><span>完整模式</span>';
        //toggleAllBtn.classList.toggle('active');
      });


      // Get XSRF Token
      let xsrfToken = null;
      jQuery.ajax({
        url: 'https://www.junyiacademy.org/',
        method: 'GET',
        async: false,
        cache: false
      }).done(() => {
        xsrfToken = /fkey=([^;]*)/.exec(document.cookie)?.[1] || null;
      });

      // Check login status
      let isLogin = false;
      jQuery.ajax({
        url: 'https://www.junyiacademy.org/api/v2/user/tracking-identity',
        method: 'GET',
        async: false,
        cache: false,
        xhrFields: { withCredentials: true },
        headers: { 'X-KA-FKey': xsrfToken }
      }).done(data => {
        isLogin = data.data.isLoggedIn;
      });

      document.getElementById("userIsLogin").style.display = isLogin ? "block" : "none";
      document.getElementById("userIsNotLogin").style.display = isLogin ? "none" : "block";
      document.getElementById("search-container").style.display = isLogin ? "flex" : "none";
      document.getElementById("voice-toggle-container").style.display = isLogin ? "block" : "none";
      if (!isLogin) return;

      // 單字牆按鈕點擊事件
      const wordWallBtn = document.getElementById('word-wall-btn');
      if (wordWallBtn) {
        wordWallBtn.addEventListener('click', function() {
          // 獲取當前頁面的 label 參數
          const urlParams = new URLSearchParams(window.location.search);
          const labelParam = urlParams.get('label');
          
          if (labelParam) {
            // 使用相對路徑，確保在平行目錄結構下正確導向
            window.location.href = `../vocabWall/?label=${encodeURIComponent(labelParam)}`;
          } else {
            alert('請提供標籤參數 (label)');
          }
        });
      }

      // Voice selection handler
      document.querySelectorAll('input[name="voice"]').forEach(elem => {
        elem.addEventListener("change", e => {
          selectedVoice = e.target.value === "male" ? MALE_VOICE : FEMALE_VOICE;
          console.log("Current voice selected:", selectedVoice);
        });
      });

      // Speech rate adjustment
      const speedSlider = document.getElementById("speed-slider");
      const speedValue = document.getElementById("speed-value");
      speedSlider.addEventListener("input", () => {
        audio.playbackRate = speedSlider.value;
        speedValue.textContent = parseFloat(speedSlider.value).toFixed(1);
      });

      // Load data from Google Sheets CSV
      const spreadsheetId = "1wSHAL3piJGEJ8EnoyK_W9kkvL42GQYId35UEhMzHTZY"; 
      const gid = "0"; 
      const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;
      const label = getQueryParam("label") || "";
      await loadSheetData(label, spreadsheetUrl);

      // Bind search button events
      document.getElementById("search-btn").addEventListener("click", search);
      // Enter 也能觸發搜尋
      document.getElementById("search-input").addEventListener("keypress", e => {
        if (e.key === "Enter") search();
      });

      // Keyboard shortcuts (Ctrl+F or /)
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey && e.key === 'f') || e.key === '/') {
          e.preventDefault();
          document.getElementById("search-input").focus();
        }
      });

      // Download all combined audio
      document.getElementById("download-all-btn").addEventListener("click", () => downloadAllCombinedAudios());

      // ======= Suggestion List Functionality =======
      const searchInput = document.getElementById("search-input");
      const suggestionList = document.getElementById("suggestion-list");
      const searchContainer = document.getElementById("search-container");

      // Track currently selected suggestion (initially none selected)
      let selectedSuggestionIndex = -1;



      // Update active state of suggestions and ensure selected item is visible
      function updateActiveSuggestion(items, index) {
  items.forEach(item => item.classList.remove("active"));
  if (index >= 0 && index < items.length) {
    items[index].classList.add("active");
    // 滾動使該項目自動進入可視區域
    items[index].scrollIntoView({ block: 'nearest', inline: 'nearest' });
  }
}  

      // Handle user input for suggestions
  searchInput.addEventListener("input", () => {
    const query = searchInput.value.trim().toLowerCase();
    if (!query) {
      suggestionList.innerHTML = "";
      suggestionList.style.display = "none";
      selectedSuggestionIndex = -1;
      return;
    }

    // 篩選：只比對 finalData 中第一欄（英文），finalData[0] 為表頭
    const matches = finalData.slice(1).filter(row => {
      return row[0].toLowerCase().includes(query);
    });

    if (matches.length === 0) {
      suggestionList.innerHTML = "";
      suggestionList.style.display = "none";
      selectedSuggestionIndex = -1;
      return;
    }

    // 產生建議列表（最多 10 筆）
    suggestionList.innerHTML = "";
    matches.slice(0, 10).forEach(match => {
      const item = document.createElement("div");
      item.textContent = match[0];
      item.addEventListener("click", () => {
        searchInput.value = match[0];
        suggestionList.innerHTML = "";
        suggestionList.style.display = "none";
        selectedSuggestionIndex = -1;
        // 可選：點擊後自動觸發搜尋
        search();
      });
      suggestionList.appendChild(item);
    });
    suggestionList.style.display = "block";
    // 每次輸入時重置選取索引
    selectedSuggestionIndex = -1;
  });

      // Keyboard navigation for suggestions (up/down arrows and Enter)
  searchInput.addEventListener("keydown", (e) => {
    const items = suggestionList.querySelectorAll("div");
    if (items.length === 0) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      selectedSuggestionIndex++;
      if (selectedSuggestionIndex >= items.length) {
        selectedSuggestionIndex = 0;
      }
      updateActiveSuggestion(items, selectedSuggestionIndex);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      selectedSuggestionIndex--;
      if (selectedSuggestionIndex < 0) {
        selectedSuggestionIndex = items.length - 1;
      }
      updateActiveSuggestion(items, selectedSuggestionIndex);
    } else if (e.key === "Enter") {
      if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < items.length) {
        e.preventDefault();
        items[selectedSuggestionIndex].click();
      }
    }
  });

      // Hide suggestions when clicking outside
  document.addEventListener("click", (e) => {
    if (!searchContainer.contains(e.target)) {
      suggestionList.style.display = "none";
    }
  });

      // End of event bindings
    });

    // Theme Toggle Functionality
    const themeToggle = document.getElementById("theme-toggle");
    const themeIcon = themeToggle.querySelector("i");
    
    // 檢查本地存儲中的主題設置
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.documentElement.setAttribute("data-theme", "dark");
      themeIcon.classList.remove("fa-moon");
      themeIcon.classList.add("fa-sun");
    } else {
      document.documentElement.setAttribute("data-theme", "light");
      themeIcon.classList.remove("fa-sun");
      themeIcon.classList.add("fa-moon");
    }
    
    // 切換主題
    themeToggle.addEventListener("click", () => {
      const currentTheme = document.documentElement.getAttribute("data-theme");
      let newTheme;
      
      if (currentTheme === "light") {
        newTheme = "dark";
        themeIcon.classList.remove("fa-moon");
        themeIcon.classList.add("fa-sun");
      } else {
        newTheme = "light";
        themeIcon.classList.remove("fa-sun");
        themeIcon.classList.add("fa-moon");
      }
      
      document.documentElement.setAttribute("data-theme", newTheme);
      localStorage.setItem("theme", newTheme);
    });

    function updateVisibility() {
      const voiceContainer = document.getElementById('voice-toggle-container');
      const searchContainer = document.getElementById('search-container');

      // 檢查是否為手機
      const isMobile = window.matchMedia("(max-width: 768px)").matches;
      // 檢查是否為橫向模式
      const isLandscape = window.matchMedia("(orientation: landscape)").matches;

      if (isMobile && isLandscape) {
        // 如果是手機且在橫向模式，隱藏容器
        voiceContainer.style.display = 'none';
        searchContainer.style.display = 'none';
      } else {
        // 否則，保持當前狀態
        voiceContainer.style.display = 'block'; // 恢復原狀態
        searchContainer.style.display = 'flex'; // 恢復原狀態
      }
    }

    // 在頁面加載時檢查
    window.addEventListener("load", updateVisibility);

    // 在視窗大小改變時檢查
    window.addEventListener("resize", updateVisibility);

    // 初始化 QuickNav
    QuickNav.init({
      position: 'top-left',
      theme: 'light'
    });
  </script>
</body>
</html>
