<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>vacabWall｜應用字彙｜均一教育平台</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-dark: #4f46e5;
      --text-light: #fff;
      --bg-primary: #f8fafc;
      --bg-card: #ffffff;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 20px;
      --border-radius-lg: 8px;
      --border-radius-xl: 20px;
      --font-size-lg: 1.1rem;
      --font-size-xl: 1.4rem;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .container {
      max-width: 1000px;
      width:100%;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .header h1 {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }

    .usage-steps {
      background: white;
      border-radius: var(--border-radius-lg);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-sm);
    }

    .usage-steps h2 {
      color: var(--primary-color);
      margin-bottom: 1rem;
      font-size: 1.4rem;
    }

    .steps {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .step {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
    }

    .step-number {
      background: var(--primary-color);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .step-content {
      color: var(--text-secondary);
    }

    .btn-word-wall {
      width: 100%;
      padding: 12px 40px;
      font-size: var(--font-size-lg);
      border-radius: 30px;
      background: linear-gradient(45deg, #6366f1, #4f46e5);
      border: none;
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    
    .btn-word-wall:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
      background: linear-gradient(45deg, #4f46e5, #4338ca);
    }
    
    .btn-word-wall:disabled {
      background: linear-gradient(45deg, #64748b, #475569);
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6); /* 半透明黑色背景 */
      backdrop-filter: blur(4px); /* 背景模糊效果 */
      -webkit-backdrop-filter: blur(4px); /* Safari 支援 */
      display: none; /* 初始隱藏 */
      justify-content: center;
      align-items: center;
      z-index: 1999; /* 確保在最上層，但低於可能出現的 modal */
    }

    /* 新增：載入內容的容器 */
    .loading-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px; /* 圖標和文字間距 */
      color: var(--text-light); /* 白色文字 */
      font-size: var(--font-size-xl); /* 稍大字體 */
      text-shadow: 0 1px 3px rgba(0,0,0,0.5); /* 文字陰影提高可讀性 */
    }

    /* 手機版應用字彙樣式 */
    .mobile-word-list {
      display: none;
      margin-top: 2rem;
    }

    .mobile-word-list h2 {
      color: var(--primary-color);
      font-size: 1.4rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .mobile-words-container {
      background-color: white;
      border-radius: var(--border-radius-lg);
      padding: 1rem;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .mobile-word-item {
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      background-color: rgba(99, 102, 241, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
      transition: transform 0.2s ease;
      flex: 0 1 auto;
    }

    .mobile-word-item:hover {
      transform: scale(1.05);
    }

    .mobile-word-en {
      font-weight: bold;
      font-size: 1.1rem;
      color: var(--primary-dark);
      display: block;
    }

    .mobile-word-cn {
      color: var(--text-secondary, #64748b);
      font-size: calc(1.1rem * 0.75);
      display: block;
      margin-top: 2px;
    }

    .mobile-theme-selector {
      overflow-x: auto;
      padding: 1rem 0;
      margin-bottom: 1rem;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      text-overflow: ellipsis;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      letter-spacing: 0.5px;
      display: flex;
      flex-direction: row;
      justify-content: left;
    }

    .mobile-theme-selector::-webkit-scrollbar {
      display: none;
    }

    .mobile-theme-option {
      flex: 0 0 auto;
      padding: 0.5rem 1rem;
      margin-right: 0.5rem;
      border-radius: 20px;
      font-size: 0.9rem;
      background-color: transparent;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      white-space: nowrap;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .mobile-theme-option.selected {
      background: var(--primary-dark);
      color: white;
      border-color: transparent;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
    }
    
    .mobile-theme-option:not(.selected):hover {
        background-color: rgba(99, 102, 241, 0.1);
    }

    /* 主題樣式 */
    .theme-nature-mobile .mobile-word-item {
      background-color: rgba(42, 187, 155, 0.1);
    }
    .theme-nature-mobile .mobile-word-en {
      color: #2abb9b;
    }

    .theme-ocean-mobile .mobile-word-item {
      background-color: rgba(52, 152, 219, 0.1);
    }
    .theme-ocean-mobile .mobile-word-en {
      color: #3498db;
    }

    .theme-candy-mobile .mobile-word-item {
      background-color: rgba(231, 76, 60, 0.1);
    }
    .theme-candy-mobile .mobile-word-en {
      color: #e74c3c;
    }

    .theme-classic-mobile .mobile-word-item {
      background-color: rgba(15, 23, 42, 0.1);
    }
    .theme-classic-mobile .mobile-word-en {
      color: #0f172a;
    }

    .desktop-only {
      display: block;
    }

    .mobile-only {
      display: none;
    }

    .word-wall-container {
      width: 1920px;
      height: 1080px;
      position: relative;
      display: grid;
      padding: 40px;
      box-sizing: border-box;
      place-items: center;
      gap: 10px;
      transition: background 0.3s ease;
    }
    
    .word-wall-word {
      background-color: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      padding: 15px 20px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      min-height: 60px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      letter-spacing: 0.5px;
    }
    
    .word-wall-title {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: #ffffff;
      font-size: 28px;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .word-wall-footer {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: 16px;
    }

    .word-wall-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: auto;
    }
    
    .word-wall-modal-content {
      max-width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .word-wall-preview {
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      border-radius: 8px;
    }
    
    .word-wall-modal-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .btn-download {
      background: linear-gradient(45deg, #6366f1, #4f46e5);
      padding: 12px 32px;
      font-size: 1.1rem;
      border-radius: 30px;
      color: white;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      font-weight: 500;
    }

    .btn-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
      background: linear-gradient(45deg, #4f46e5, #4338ca);
    }

    .btn-close {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 30px;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .btn-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .theme-selector {
      margin-top: 1rem;
      background: white;
      border-radius: var(--border-radius-lg);
      padding: 1rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .theme-selector-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 0.5rem;
    }

    .theme-selector-header h2 {
      color: var(--primary-color);
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .theme-selector-header i {
      transition: transform 0.3s ease;
    }

    .theme-selector-header.collapsed i {
      transform: rotate(-90deg);
    }

    .themes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0;
    }

    .themes.expanded {
      max-height: 500px;
      padding: 1rem 0;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) rgba(0, 0, 0, 0.1);
    }

    /* 自定義捲動條樣式 */
    .themes.expanded::-webkit-scrollbar {
      width: 6px;
    }

    .themes.expanded::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    .themes.expanded::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 3px;
    }

    /* 確保在移動裝置上也能正常顯示 */
    @media (max-width: 768px) {
      .themes {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .theme-preview {
        height: 60px;
      }

      .theme-name {
        font-size: 0.9rem;
      }
    }

    .theme-option {
      padding: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .theme-option:hover {
      transform: translateY(-2px);
    }

    .theme-option.selected {
      border-color: var(--primary-color);
    }

    .theme-preview {
      width: 100%;
      height: 80px;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }

    .theme-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    /* 主題配色 */
    .theme-nature {
      background: linear-gradient(135deg, #a8e6cf, #dcedc1);
    }

    .theme-ocean {
      background: linear-gradient(135deg, #a8d8ea, #aa96da);
    }

    .theme-candy {
      background: linear-gradient(135deg, #ffd3b6, #ffaaa5);
    }

    .theme-tech {
      background: linear-gradient(135deg, #d4e6f1, #a9cce3);
    }

    .theme-rainbow {
      background: linear-gradient(135deg, #ff9a9e, #fad0c4, #a1c4fd, #c2e9fb);
    }

    .theme-classic {
      background: linear-gradient(135deg, #0f172a, #1e293b);
    }

    /* New styles for English and Chinese text within the wall word */
    .wall-word-en {
        display: block;
        /* Font size will be set dynamically */
        font-weight: 600;
        /* Color will be set dynamically based on theme */
        width: 100%; /* Ensure it takes full width */
    }

    .wall-word-cn {
        display: block;
        /* font-size: 75%; */ /* Removed - Now set via JS */
        /* Color needs dynamic setting, perhaps slightly faded */
        opacity: 0.85; /* Example: Slightly faded */
        margin-top: 4px; /* Space between En and Cn */
        width: 100%;
        white-space: normal; /* Allow Chinese to wrap */
        line-height: 1.2;
        font-weight: normal; /* Ensure non-bold for Chinese */
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-th"></i> 應用字彙</h1>
      <p>快速生成精美的應用字彙，幫助複習英文單字</p>
    </div>

    <div class="usage-steps desktop-only">
      <h2>使用說明</h2>
      <div class="steps">
        <div class="step">
          <div class="step-number">1</div>
          <div class="step-content">點擊下方按鈕生成應用字彙</div>
        </div>
        <div class="step">
          <div class="step-number">2</div>
          <div class="step-content">下載生成的應用字彙圖片</div>
        </div>
      </div>
    </div>

    <button id="generate-btn" class="btn btn-word-wall desktop-only">
      <i class="fas fa-th"></i> 生成應用字彙
    </button>

    <div class="theme-selector desktop-only">
      <div class="theme-selector-header">
        <h2>
          <i class="fas fa-palette"></i>
          選擇應用字彙主題
        </h2>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="themes">
        <div class="theme-option" data-theme="rainbow">
          <div class="theme-preview theme-rainbow"></div>
          <div class="theme-name">預設主題</div>
        </div>
        <div class="theme-option" data-theme="nature">
          <div class="theme-preview theme-nature"></div>
          <div class="theme-name">自然主題</div>
        </div>
        <div class="theme-option" data-theme="ocean">
          <div class="theme-preview theme-ocean"></div>
          <div class="theme-name">海洋主題</div>
        </div>
        <div class="theme-option" data-theme="candy">
          <div class="theme-preview theme-candy"></div>
          <div class="theme-name">甜點主題</div>
        </div>
        <div class="theme-option" data-theme="classic">
          <div class="theme-preview theme-classic"></div>
          <div class="theme-name">深空主題</div>
        </div>
      </div>
    </div>

  </div>

  <div id="loading" style="display: none;">
    <div class="loading-content">
      <i class="fas fa-spinner fa-pulse fa-2x"></i> <!-- 加大圖標 -->
      <span>載入中...</span>
    </div>
  </div>
  <div id="preview-container"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    // 常數定義
    const CONSTANTS = {
      SPREADSHEET_ID: "1wSHAL3piJGEJ8EnoyK_W9kkvL42GQYId35UEhMzHTZY",
      GID: "0",
      MAX_WORDS: 50
    };

    // 檢測是否為移動裝置
    const isMobileDevice = () => {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    };

    // 工具函數
    const Utils = {
      showLoading: (isLoading) => {
        // 更新：使用 'flex' 來顯示，利用 flexbox 居中
        document.getElementById('loading').style.display = isLoading ? 'flex' : 'none';
      },

      getUrlParam: (param) => {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      },

      calculateGrid: (itemCount) => {
        const aspectRatio = 16 / 9;
        let cols = Math.ceil(Math.sqrt(itemCount * aspectRatio));
        let rows = Math.ceil(itemCount / cols);
        
        while (cols * rows < itemCount) cols++;
        if ((cols - 1) * rows >= itemCount && cols > 1) cols--;
        
        return { cols, rows };
      },

      calculateFontSize: (wordLength, baseSize) => {
        if (wordLength <= 4) return baseSize;
        if (wordLength <= 7) return baseSize * 0.9;
        if (wordLength <= 10) return baseSize * 0.8;
        return baseSize * 0.7;
      },

      // 防抖函數
      debounce: (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },

      // 觸控反饋效果
      addTouchFeedback: (element) => {
        if (!element) return;
        element.addEventListener('touchstart', () => {
          element.style.transform = 'scale(0.95)';
          element.style.transition = 'transform 0.1s ease';
        }, { passive: true });

        element.addEventListener('touchend', () => {
          element.style.transform = 'scale(1)';
        }, { passive: true });
      },
      
      // 準備UI，根據設備類型顯示適當的界面
      prepareUI: (isMobile) => {
        if (isMobile) {
          // 手機模式：隱藏所有桌面元素
          document.querySelectorAll('.desktop-only').forEach(el => {
            el.style.display = 'none';
          });
          
          // 顯示所有手機元素
          document.querySelectorAll('.mobile-only').forEach(el => {
            el.style.display = 'block';
          });
          
          // 調整頁面標題樣式
          const header = document.querySelector('.header');
          header.style.marginBottom = '1rem';
          
          const desc = document.querySelector('.header p');
          desc.textContent = '快速瀏覽英文單字';
          
          // 如果不需要html2canvas庫，可以移除腳本
          if (document.getElementById('html2canvas-script')) {
            document.getElementById('html2canvas-script').remove();
          }
        } else {
          // 桌面模式：顯示所有桌面元素
          document.querySelectorAll('.desktop-only').forEach(el => {
            el.style.display = 'block';
          });
          
          // 隱藏所有手機元素
          document.querySelectorAll('.mobile-only').forEach(el => {
            el.style.display = 'none';
          });
        }
      }
    };

    // 主要功能類
    class WordWall {
      constructor() {
        this.vocabularyData = [];
        this.selectedTheme = 'rainbow';
        this.cachedWallImages = {};
        this.touchStartX = 0;
        this.touchEndX = 0;
        this.isMobile = isMobileDevice();
        
        // 根據裝置類型準備UI
        Utils.prepareUI(this.isMobile);
        
        if (!this.isMobile) {
          // 桌面版功能
          this.setupEventListeners();
          this.setupThemeSelector();
          this.setupResizeHandler();
        } else {
          // 手機版功能
          this.setupMobileUI();
        }
        
        this.checkUrlAndLoad();
      }

      setupMobileUI() {
        // Check if the mobile list already exists to prevent duplication
        if (document.querySelector('.mobile-word-list')) {
          // If it exists, ensure it's visible in case prepareUI hasn't run yet or was reversed
          const existingList = document.querySelector('.mobile-word-list');
          existingList.style.display = 'block'; 
          return; 
        }

        const container = document.querySelector('.container');
        if (!container) {
          console.error("Error: '.container' not found. Cannot setup mobile UI.");
          return;
        }
        
        // 創建手機版應用字彙容器
        const mobileWordList = document.createElement('div');
        mobileWordList.className = 'mobile-word-list mobile-only';
        mobileWordList.innerHTML = `
          <h2><i class="fas fa-list"></i> 應用字彙</h2>
          <div class="mobile-theme-selector">
            <div class="mobile-theme-option selected" data-theme="rainbow">預設主題</div>
            <div class="mobile-theme-option" data-theme="nature">自然主題</div>
            <div class="mobile-theme-option" data-theme="ocean">海洋主題</div>
            <div class="mobile-theme-option" data-theme="candy">甜點主題</div>
            <div class="mobile-theme-option" data-theme="classic">深空主題</div>
          </div>
          <div class="mobile-words-container"></div>
        `;
        
        container.appendChild(mobileWordList);
        
        // 設置手機版主題選擇器事件
        const themeOptions = mobileWordList.querySelectorAll('.mobile-theme-option'); // Query within the newly created element
        themeOptions.forEach(option => {
          Utils.addTouchFeedback(option);
          
          option.addEventListener('click', () => {
            themeOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            this.selectedTheme = option.dataset.theme;
            
            // 更新樣式
            const wordsContainer = document.querySelector('.mobile-words-container'); // Find it again
             if (wordsContainer) {
                wordsContainer.className = 'mobile-words-container'; // Reset classes first
                wordsContainer.classList.add(`theme-${this.selectedTheme}-mobile`);
            }
          });
        });
        
        // Ensure it's visible after creation
        mobileWordList.style.display = 'block';
      }

      setupResizeHandler() {
        // !!! 新增檢查：如果主要指標是粗糙的（可能是觸控），則不設置此監聽器 !!!
        // 這可以防止在手機上請求桌面版網站時，捲動頁面觸發預覽
        if (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) {
          console.log("檢測到觸控指標 (coarse pointer)，跳過設置用於預覽的 resize 處理器。");
          return; // 不添加監聽器
        }
        
        // --- 原有邏輯 ---
        const handleResize = Utils.debounce(() => {
          // 處理視窗大小改變的邏輯
          // 這裡的檢查 !this.isMobile 仍然是必要的，以防萬一在真實桌面環境下
          // this.isMobile 被錯誤設置為 true
          if (!this.isMobile && this.cachedWallImages[this.selectedTheme]) {
            this.updatePreviewForSelectedTheme();
          }
        }, 250);

        window.addEventListener('resize', handleResize, { passive: true });
        // --- 結束原有邏輯 ---
      }

      setupThemeSelector() {
        const themeSelector = document.querySelector('.theme-selector');
        const themeHeader = document.querySelector('.theme-selector-header');
        const themesContainer = document.querySelector('.themes');
        
        // 初始狀態
        themesContainer.classList.add('expanded');
        
        // 添加觸控反饋
        Utils.addTouchFeedback(themeHeader);
        document.querySelectorAll('.theme-option').forEach(option => {
          Utils.addTouchFeedback(option);
        });

        // 使用事件委派處理主題切換
        themeSelector.addEventListener('click', Utils.debounce((event) => {
          const target = event.target;
          
          if (target.closest('.theme-selector-header')) {
            themeHeader.classList.toggle('collapsed');
            themesContainer.classList.toggle('expanded');
            return;
          }
          
          const themeOption = target.closest('.theme-option');
          if (themeOption) {
            document.querySelectorAll('.theme-option').forEach(opt => {
              opt.classList.remove('selected');
            });
            
            themeOption.classList.add('selected');
            this.selectedTheme = themeOption.dataset.theme;
            this.updatePreviewForSelectedTheme();
          }
        }, 150));

        // 添加觸控滑動切換功能
        themeSelector.addEventListener('touchstart', (e) => {
          this.touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        themeSelector.addEventListener('touchend', (e) => {
          this.touchEndX = e.changedTouches[0].screenX;
          this.handleSwipe();
        }, { passive: true });

        // 設置初始選中狀態
        document.querySelector('.theme-option').classList.add('selected');
      }

      handleSwipe() {
        const swipeThreshold = 50;
        const swipeDistance = this.touchEndX - this.touchStartX;
        
        if (Math.abs(swipeDistance) < swipeThreshold) return;
        
        const themeOptions = Array.from(document.querySelectorAll('.theme-option'));
        const currentIndex = themeOptions.findIndex(opt => opt.classList.contains('selected'));
        
        if (swipeDistance > 0 && currentIndex > 0) {
          // 向右滑動，切換到上一個主題
          this.switchTheme(themeOptions[currentIndex - 1]);
        } else if (swipeDistance < 0 && currentIndex < themeOptions.length - 1) {
          // 向左滑動，切換到下一個主題
          this.switchTheme(themeOptions[currentIndex + 1]);
        }
      }

      switchTheme(themeOption) {
        document.querySelectorAll('.theme-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        themeOption.classList.add('selected');
        this.selectedTheme = themeOption.dataset.theme;
        this.updatePreviewForSelectedTheme();
      }

      setupEventListeners() {
        const generateBtn = document.getElementById('generate-btn');
        Utils.addTouchFeedback(generateBtn);

        generateBtn.addEventListener('click', Utils.debounce(() => {
          const label = Utils.getUrlParam('label');
          if (label) {
            if (this.cachedWallImages && this.cachedWallImages[this.selectedTheme]) {
              this.updatePreviewForSelectedTheme();
            } else {
              this.loadVocabularyData(label);
            }
          } else {
            alert('請在網址中加入 label 參數，例如：?label=unit1');
          }
        }, 150));
      }

      updatePreviewForSelectedTheme() {
        if (!this.isMobile && this.cachedWallImages && this.cachedWallImages[this.selectedTheme]) {
          this.showWordWallPreview(this.cachedWallImages[this.selectedTheme]);
        }
      }

      showWordWallPreview(imageUrl) {
        if (this.isMobile) return; // 不在手機上顯示預覽
        
        // 使用 DocumentFragment 來批量處理 DOM 操作
        const fragment = document.createDocumentFragment();
        
        // 創建 modal 容器
        const modal = document.createElement('div');
        modal.className = 'word-wall-modal';
        
        // 創建 modal 內容
        const modalContent = document.createElement('div');
        modalContent.className = 'word-wall-modal-content';
        
        // 創建圖片元素
        const img = document.createElement('img');
        img.className = 'word-wall-preview';
        img.src = imageUrl;
        img.alt = '應用字彙預覽';
        
        // 創建控制按鈕容器
        const controls = document.createElement('div');
        controls.className = 'word-wall-modal-controls';
        
        // 創建下載按鈕
        const downloadBtn = document.createElement('a');
        downloadBtn.className = 'btn-download';
        downloadBtn.href = imageUrl;
        downloadBtn.download = `應用字彙-${this.selectedTheme}.png`;
        downloadBtn.innerHTML = '<i class="fas fa-download"></i> 下載圖片';
        
        // 創建關閉按鈕
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn-close';
        closeBtn.innerHTML = '<i class="fas fa-times"></i> 關閉';
        closeBtn.onclick = () => document.body.removeChild(modal);
        
        // 組裝所有元素
        controls.appendChild(downloadBtn);
        controls.appendChild(closeBtn);
        modalContent.appendChild(img);
        modalContent.appendChild(controls);
        modal.appendChild(modalContent);
        fragment.appendChild(modal);
        
        // 一次性添加到 DOM
        document.body.appendChild(fragment);
      }

      checkUrlAndLoad() {
        const label = Utils.getUrlParam('label');
        if (label) {
          this.loadVocabularyData(label);
        }
      }

      async loadVocabularyData(label) {
        Utils.showLoading(true);
        try {
          const url = `https://docs.google.com/spreadsheets/d/${CONSTANTS.SPREADSHEET_ID}/export?format=csv&gid=${CONSTANTS.GID}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error('無法載入試算表資料');

          const csvText = await response.text();
          if (!csvText.trim()) throw new Error('試算表內容為空');

          const { data } = Papa.parse(csvText, { header: false });
          if (!data?.length) throw new Error('解析後的資料為空');

          const header = data.shift();
          if (!header) throw new Error('無法提取表頭');

          const filteredData = data.filter(row => row[0]?.toLowerCase() === label.toLowerCase());
          if (!filteredData.length) throw new Error(`找不到標籤為 "${label}" 的資料`);

          this.vocabularyData = [header.slice(1), ...filteredData.map(row => row.slice(1))];
          
          const wordPairs = this.vocabularyData.slice(1).map(row => ({
              en: row[0] || '',
              cn: row[2] || ''
          })).filter(pair => pair.en);

          // Check word count using wordPairs.length
          if (!this.isMobile && wordPairs.length > CONSTANTS.MAX_WORDS) {
            console.warn(`單字數量 (${wordPairs.length}) 超過上限 (${CONSTANTS.MAX_WORDS})，將強制顯示手機版列表。`);
            this.setupMobileUI();     
            Utils.prepareUI(true);     
            this.renderMobileWordList(); 
            const themeSelectorLoad = document.querySelector('.mobile-theme-selector');
            if (themeSelectorLoad) themeSelectorLoad.style.display = 'flex';
            
          } else {
            if (this.isMobile) {
              this.renderMobileWordList(); // Uses this.vocabularyData
            } else {
              // Pass wordPairs to preloadWallImages
              this.preloadWallImages(wordPairs, label);
            }
          }
        } catch (error) {
          console.error('載入資料失敗:', error);
          alert(`載入資料失敗：${error.message}`);
        }
        Utils.showLoading(false);
      }

      renderMobileWordList() {
        // 取得單字
        const words = this.vocabularyData.slice(1);
        const container = document.querySelector('.mobile-words-container');
        container.innerHTML = '';
        container.className = 'mobile-words-container';
        container.classList.add(`theme-${this.selectedTheme}-mobile`);
        
        // 創建應用字彙
        const fragment = document.createDocumentFragment();
        
        words.forEach(wordData => { // wordData is like [en, cn, ...] 
          const english = wordData[0] || '';
          const chinese = wordData[2] || ''; // Assuming Chinese is at index 1
          
          if (!english) return; // Skip if no English word
          
          const wordItem = document.createElement('div');
          wordItem.className = 'mobile-word-item';
          
          const wordEn = document.createElement('div');
          wordEn.className = 'mobile-word-en';
          wordEn.textContent = english;
          
          wordItem.appendChild(wordEn);
          
          // Only add Chinese element if it exists
          if (chinese) {
            const wordCn = document.createElement('div');
            wordCn.className = 'mobile-word-cn';
            wordCn.textContent = chinese;
            wordItem.appendChild(wordCn);
          }
          
          fragment.appendChild(wordItem);
        });
        
        container.appendChild(fragment);
        
        // 顯示手機版應用字彙
        document.querySelector('.mobile-word-list').style.display = 'block';
      }

      // 以下方法只在桌面版使用
      async preloadWallImages(wordPairs, label) {
        if (this.isMobile) return;
        
        this.cleanupCachedImages();

        const themes = ['rainbow', 'nature', 'ocean', 'candy', 'classic'];
        
        for (const theme of themes) {
          try {
            await new Promise(resolve => setTimeout(resolve, 0)); 
            // Pass wordPairs to generate function
            const imageUrl = await this.generateWallImageForTheme(theme, wordPairs, label);
            // Only cache if imageUrl is valid (not null due to word count limit)
            if (imageUrl) { 
              this.cachedWallImages[theme] = imageUrl;
              if (theme === this.selectedTheme) {
                this.updatePreviewForSelectedTheme();
              }
            }
          } catch (e) {
            console.error(`預載 ${theme} 主題失敗:`, e);
          }
        }
      }

      async generateWallImageForTheme(theme, wordPairs, label) {
        if (this.isMobile) return null;
        
        // Check word count using wordPairs.length
        if (wordPairs.length > CONSTANTS.MAX_WORDS) {
          console.warn(`主題 "${theme}" 的單字數量 (${wordPairs.length}) 超過限制 (${CONSTANTS.MAX_WORDS})，跳過生成。`);
          return null;
        }
        
        // 創建 DocumentFragment 來批量處理 DOM 操作
        const fragment = document.createDocumentFragment();
        
        // 創建容器並一次性設置所有樣式
        const container = document.createElement('div');
        container.className = 'word-wall-container';
        Object.assign(container.style, {
          position: 'fixed',
          left: '-9999px',
          top: '0',
          width: '1920px',
          height: '1080px',
          display: 'grid',
          padding: '40px',
          boxSizing: 'border-box',
          placeItems: 'center',
          gap: '10px'
        });
        fragment.appendChild(container);

        // 創建標題和頁腳
        const title = label ? `${label.toUpperCase()} - 應用字彙` : '應用字彙';
        const headerFooterFragment = document.createDocumentFragment();
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'word-wall-title';
        titleDiv.innerHTML = `<i class="fas fa-book"></i> ${title}`;
        headerFooterFragment.appendChild(titleDiv);

        const footerDiv = document.createElement('div');
        footerDiv.className = 'word-wall-footer';
        footerDiv.textContent = 'Junyi Academy 均一教育平台';
        headerFooterFragment.appendChild(footerDiv);

        container.appendChild(headerFooterFragment);

        // 設置網格
        const grid = Utils.calculateGrid(wordPairs.length);
        Object.assign(container.style, {
          gridTemplateColumns: `repeat(${grid.cols}, 1fr)`,
          gridTemplateRows: `repeat(${grid.rows}, 1fr)`
        });

        // 設置主題顏色
        const baseSize = Math.min(900 / grid.cols, 36);
        const themeColors = this.getThemeColorsByName(theme);
        container.style.background = themeColors.background;

        // 批量創建單字元素
        const wordsFragment = document.createDocumentFragment();
        wordPairs.forEach((pair, index) => {
          const wordDiv = document.createElement('div');
          wordDiv.className = 'word-wall-word';

          const baseSize = Math.min(900 / grid.cols, 36); // Keep original base size calculation for now
          let fontSize = Utils.calculateFontSize(pair.en.length, baseSize);
          fontSize *= 1.15; // Increase calculated font size by 15%
          
          const colorIndex = index % themeColors.colors.length;
          const themeColor = themeColors.colors[colorIndex];
          const hue = this.calculateHue(themeColor); // Calculate hue based on the chosen color
          
          // Create English Element
          const wordEnDiv = document.createElement('div'); // Change to div
          wordEnDiv.className = 'wall-word-en';
          wordEnDiv.textContent = pair.en;
          wordEnDiv.style.fontSize = `${fontSize}px`;
          
          // Create Chinese Element (if exists)
          let wordCnDiv = null; // Change to div
          if (pair.cn) {
              wordCnDiv = document.createElement('div'); // Change to div
              wordCnDiv.className = 'wall-word-cn';
              wordCnDiv.textContent = pair.cn;
              // Explicitly set font size based on English size
              wordCnDiv.style.fontSize = `${fontSize * 0.75}px`;
              // CN color might need adjustment based on theme
          }

          // Apply common and theme-specific styles to the container and text elements
          let enColor = themeColors.textColor; // Default for rainbow/classic
          let cnColor = themeColors.textColor; // Default for rainbow/classic
          let cnOpacity = 0.85; // Default opacity for CN
          let bgColor = `hsla(${hue}, 85%, 65%, 0.2)`; // Default for rainbow/classic
          let borderStyle = `3px solid hsla(${hue}, 85%, 65%, 0.6)`; // Default for rainbow/classic
          let boxShadow = '';
          let textShadow = '';

          if (theme !== 'rainbow' && theme !== 'classic') {
            // Other themes use theme color for EN text, lighter background
            enColor = themeColor;
            cnColor = themeColor; // Use same color for CN, rely on opacity
            bgColor = `hsla(${hue}, 85%, 95%, 0.8)`;
            borderStyle = `3px solid ${themeColor}`; 
            if(themeColors.effects) { // Check if effects exist
              boxShadow = themeColors.effects.boxShadow || '';
              textShadow = themeColors.effects.textShadow || '';
            }
          }
          
          // Apply styles
          wordEnDiv.style.color = enColor;
          if (wordCnDiv) {
              wordCnDiv.style.color = cnColor;
              wordCnDiv.style.opacity = cnOpacity;
          }
          
          Object.assign(wordDiv.style, {
            backgroundColor: bgColor,
            borderLeft: borderStyle,
            boxShadow: boxShadow, 
            textShadow: textShadow // Apply text shadow to container if needed, or move to spans
          });
          
          // Append elements
          wordDiv.appendChild(wordEnDiv);
          if (wordCnDiv) {
            wordDiv.appendChild(wordCnDiv);
          }

          wordsFragment.appendChild(wordDiv);
        });

        container.appendChild(wordsFragment);
        document.body.appendChild(fragment);

        await new Promise(resolve => setTimeout(resolve, 0));

        const canvas = await html2canvas(container, {
          width: 1920,
          height: 1080,
          scale: 1,
          backgroundColor: null,
          logging: false,
          useCORS: true
        });
        document.body.removeChild(container);

        return new Promise((resolve) => {
          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            resolve(url);
          }, 'image/png');
        });
      }

      getThemeColorsByName(theme) {
        const themes = {
          rainbow: {
            background: 'linear-gradient(135deg, #2c3e50, #1a252f)',
            colors: ['#ff9a9e', '#fad0c4', '#a1c4fd', '#c2e9fb'],
            textColor: '#ffffff'
          },
          nature: {
            background: 'linear-gradient(135deg, #a8e6cf, #dcedc1)',
            colors: ['#3bb78f', '#0bab64', '#2ecc71', '#27ae60'],
            textColor: '#2c3e50',
            effects: {
              textShadow: '0 1px 2px rgba(0, 0, 0, 0.1)',
              boxShadow: '0 4px 8px rgba(0, 0, 0, 0.1)',
              hoverEffect: 'transform: scale(1.02)'
            }
          },
          ocean: {
            background: 'linear-gradient(135deg, #a8d8ea, #aa96da)',
            colors: ['#3498db', '#2980b9', '#6c5ce7', '#4834d4'],
            textColor: '#2c3e50',
            effects: {
              textShadow: '0 1px 2px rgba(0, 0, 0, 0.1)',
              boxShadow: '0 4px 8px rgba(0, 0, 0, 0.1)',
              hoverEffect: 'transform: scale(1.02)'
            }
          },
          candy: {
            background: 'linear-gradient(135deg, #ffd3b6, #ffaaa5)',
            colors: ['#ff7675', '#e84393', '#fd79a8', '#e84393'],
            textColor: '#2c3e50',
            effects: {
              textShadow: '0 1px 2px rgba(0, 0, 0, 0.1)',
              boxShadow: '0 4px 8px rgba(0, 0, 0, 0.1)',
              hoverEffect: 'transform: scale(1.02)'
            }
          },
          classic: {
            background: 'linear-gradient(135deg, #0f172a, #1e293b)',
            colors: ['#6366f1', '#4f46e5', '#4338ca', '#3730a3'],
            textColor: '#ffffff'
          }
        };
        return themes[theme] || themes.rainbow;
      }

      async createWordWall() {
        if (this.isMobile) return; // 如果是真手機，此函數不執行

        const wordPairs = this.vocabularyData.slice(1).map(row => ({
            en: row[0] || '',
            cn: row[1] || '' // Assuming Chinese is the second column after label
        })).filter(pair => pair.en); // Filter out rows with no English word

        if (!wordPairs.length) {
          alert('沒有找到單字！');
          return;
        }

        if (wordPairs.length > CONSTANTS.MAX_WORDS) {
          console.warn(`(createWordWall) 單字數量 (${wordPairs.length}) 超過上限 (${CONSTANTS.MAX_WORDS})，確保顯示手機版列表。`);
          this.setupMobileUI();
          Utils.prepareUI(true);
          this.renderMobileWordList();
          const themeSelectorCreateLimit = document.querySelector('.mobile-theme-selector');
          if (themeSelectorCreateLimit) themeSelectorCreateLimit.style.display = 'flex';
          
          const headerP = document.querySelector('.header p');
          if (headerP) {
              headerP.textContent = `單字數量過多 (${wordPairs.length}個)，無法生成應用字彙，已切換至列表模式。`;
          }
          const generateBtn = document.getElementById('generate-btn');
          if (generateBtn && window.getComputedStyle(generateBtn).display !== 'none') {
              generateBtn.disabled = true;
              generateBtn.style.cursor = 'not-allowed';
              generateBtn.style.opacity = '0.5';
          }

          return;
        }

        Utils.showLoading(true);
        try {
          let imageUrl = null;
          if (this.cachedWallImages && this.cachedWallImages[this.selectedTheme]) {
            imageUrl = this.cachedWallImages[this.selectedTheme];
          } else {
            imageUrl = await this.generateWallImageForTheme(this.selectedTheme, wordPairs, Utils.getUrlParam('label'));
            if (imageUrl) {
              this.cachedWallImages[this.selectedTheme] = imageUrl;
            }
          }
          
          // 確保 imageUrl 有效才顯示預覽
          if (imageUrl) {
              this.showWordWallPreview(imageUrl);
          } else {
              console.error("無法生成或獲取圖片，即使單字數量在限制內。可能 generateWallImageForTheme 返回了 null。");
              this.setupMobileUI();
              Utils.prepareUI(true);
              this.renderMobileWordList();
              const themeSelectorCreateFail = document.querySelector('.mobile-theme-selector');
              if (themeSelectorCreateFail) themeSelectorCreateFail.style.display = 'flex';
              
              const headerP = document.querySelector('.header p');
              if (headerP) {
                  headerP.textContent = `無法生成應用字彙圖片，已切換至列表模式。`;
              }
              const generateBtn = document.getElementById('generate-btn');
              if (generateBtn && window.getComputedStyle(generateBtn).display !== 'none') {
                  generateBtn.disabled = true;
                  generateBtn.style.cursor = 'not-allowed';
                  generateBtn.style.opacity = '0.5';
              }
              alert("抱歉，暫時無法生成應用字彙圖片，請嘗試選擇其他主題或稍後再試。");
          }
        } catch (error) {
          console.error('創建應用字彙失敗:', error);
          alert('創建應用字彙失敗: ' + error.message);
        }
        Utils.showLoading(false);
      }

      calculateHue(color) {
        const r = parseInt(color.slice(1, 3), 16) / 255;
        const g = parseInt(color.slice(3, 5), 16) / 255;
        const b = parseInt(color.slice(5, 7), 16) / 255;
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h;
        if (max === min) {
          h = 0;
        } else if (max === r) {
          h = 60 * ((g - b) / (max - min));
        } else if (max === g) {
          h = 60 * (2 + (b - r) / (max - min));
        } else {
          h = 60 * (4 + (r - g) / (max - min));
        }
        return h < 0 ? h + 360 : h;
      }

      // 清理快取的圖片 URL
      cleanupCachedImages() {
        Object.values(this.cachedWallImages).forEach(url => {
          URL.revokeObjectURL(url);
        });
        this.cachedWallImages = {};
      }
    }

    // 初始化
    new WordWall();
  </script>
</body>
</html> 