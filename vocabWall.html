<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­—å½™è¬é¡Œï½œVocabPuzzle</title>
    <!-- æ·»åŠ  Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- æ·»åŠ  Papa Parse ç”¨æ–¼è§£æ CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* è¨­å®š rem åŸºæº–å€¼ */
        html {
            font-size: 16px; /* 1rem = 16pxï¼Œæ‚¨å¯ä»¥èª¿æ•´æ­¤å€¼ */
        }
        
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif; /* Added Noto Sans TC for better Chinese character rendering */
            overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
            background-color: #f5f7fa;
            color: #1e293b; /* æ–‡å­—é¡è‰² */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* é¸å–æ•ˆæœ */
        ::selection {
            background-color: #7dd3fc;
            color: #0c4a6e;
        }

        .main-container {
            width: 100%;
            max-width: 1400px; /* å¢åŠ æœ€å¤§å¯¬åº¦ä»¥å®¹ç´è¬é¡Œç¶²æ ¼ */
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            margin: 0 auto;
        }

        .content-wrapper {
            padding: 24px 32px;
        }

        .grid-cell {
            width: 30px; /* Fixed width for cells */
            height: 30px; /* Fixed height for cells */
            display: flex;
            justify-content: center;
            align-items: center;
            border: none; /* ç§»é™¤æ‰€æœ‰é‚Šæ¡† */
            background-color: #f8fafc; /* æ·ºç°èƒŒæ™¯ */
            font-size: 1rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            font-weight: 600;
            position: relative;
            color: #1e293b; /* ç¢ºä¿æ–‡å­—é¡è‰² */
            z-index: 1; /* ç¢ºä¿æ–‡å­—åœ¨ä¸Šå±¤ */
        }
        .grid-cell::after {
            content: '';
            position: absolute;
            inset: 1px;
            background-color: white;
            transition: all 0.2s ease;
            z-index: -1; /* èƒŒæ™¯åœ¨æ–‡å­—ä¸‹æ–¹ */
        }
        .grid-cell:hover::after {
            background-color: #f1f5f9;
        }
        .grid-cell.selected {
            background-color: #60a5fa; /* Tailwind blue-400 */
            color: white;
            z-index: 2;
        }
        
        .grid-cell.selected::after {
            background-color: transparent;
        }
        
        .grid-cell.first-click {
            background-color: #f59e0b; /* Tailwind amber-500 */
            color: white;
            animation: pulse 1s infinite;
            z-index: 2;
        }
        
        .grid-cell.first-click::after {
            background-color: transparent;
        }
        
        .grid-cell.potential {
            background-color: #fef3c7; /* Tailwind amber-100 */
        }
        
        .grid-cell.potential::after {
            background-color: #fbbf24; /* Tailwind amber-400 */
        }
        
        .grid-cell.found {
            background-color: #34d399; /* Tailwind green-400 */
            color: white;
            z-index: 2;
        }
        
        .grid-cell.found::after {
            background-color: transparent;
        }
        .word-list-item.found {
            text-decoration: line-through;
            color: #9ca3af; /* Tailwind gray-400 */
        }
        .word-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            text-align: center;
        }
        .word-item.found {
            text-decoration: line-through;
            background-color: #f0fdf4; /* Tailwind green-50 */
            border-color: #34d399; /* Tailwind green-400 */
        }
        .word-english {
            font-weight: bold;
            color: #1e293b; /* Tailwind slate-800 */
            font-size: 0.875rem;
            margin-bottom: 2px;
        }
        .word-chinese {
            font-size: 0.75rem;
            color: #64748b; /* Tailwind slate-500 */
            line-height: 1.2;
        }
        /* Custom scrollbar for word list if it overflows */
        .word-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .word-list-container::-webkit-scrollbar-track {
            background: #f1f5f9; /* Tailwind slate-100 */
            border-radius: 10px;
        }
        .word-list-container::-webkit-scrollbar-thumb {
            background: #94a3b8; /* Tailwind slate-400 */
            border-radius: 10px;
        }
        .word-list-container::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* Tailwind slate-500 */
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            #puzzleGrid {
                max-height: 60vh;
            }
            
            .word-list-container {
                max-height: 40vh;
            }
        }
        
        @media (max-width: 640px) {
            .grid-cell {
                font-size: 0.75rem;
                font-weight: 600;
            }
            
            .word-list-container {
                max-height: 35vh;
            }
            
            .word-item {
                padding: 6px 8px;
            }
            
            .word-english {
                font-size: 0.75rem;
            }
            
            .word-chinese {
                font-size: 0.625rem;
            }
            
            #wordList {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .grid-cell {
                font-size: 0.75rem;
                font-weight: 600;
            }
            
            .word-list-container {
                max-height: 35vh;
            }
            
            .word-item {
                padding: 6px 8px;
            }
            
            .word-english {
                font-size: 0.75rem;
            }
            
            .word-chinese {
                font-size: 0.625rem;
            }
            
            /* å°è¢å¹•ä¸‹å¼·åˆ¶ä½¿ç”¨2åˆ— */
            #wordList {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* å¤§è¢å¹•å„ªåŒ– */
        @media (min-width: 1024px) {
            .word-item {
                padding: 10px 14px;
            }
            
            .word-english {
                font-size: 1rem;
            }
            
            .word-chinese {
                font-size: 0.875rem;
            }
            
            .grid-cell {
                font-size: 1.125rem;
                font-weight: 700;
            }
        }

        /* éŸ¿æ‡‰å¼ç¶²æ ¼å–®å…ƒæ ¼å„ªåŒ– */
        @media (max-width: 640px) {
            .grid-cell {
                font-size: 0.75rem;
                font-weight: 600;
            }
            
            .word-list-container {
                max-height: 35vh;
            }
        }

        /* å¤§è¢å¹•ç¶²æ ¼å„ªåŒ– */
        @media (min-width: 1024px) {
            .grid-cell {
                font-size: 1.125rem;
                font-weight: 700;
            }
        }

        .grid-cell.found::after {
            background-color: transparent;
        }

        .grid-cell.hint {
            background-color: #8b5cf6; /* Tailwind violet-500 */
            color: white;
            animation: hintPulse 2s infinite;
            z-index: 3;
        }
        
        .grid-cell.hint::after {
            background-color: transparent;
        }

        @keyframes hintPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .hint-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(139, 92, 246, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
            pointer-events: none;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, -60%); }
            20%, 80% { opacity: 1; transform: translate(-50%, -50%); }
        }

        .word-list-item.found {
            text-decoration: line-through;
            color: #9ca3af; /* Tailwind gray-400 */
        }

        /* Toggle èªªæ˜å€åŸŸæ¨£å¼ */
        .help-toggle-btn {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }

        .help-toggle-btn .icon {
            transition: transform 0.3s ease;
        }

        .help-toggle-btn.expanded .icon {
            transform: rotate(180deg);
        }

        .help-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            opacity: 0;
        }

        .help-content.expanded {
            max-height: 1000px;
            opacity: 1;
            transition: max-height 0.5s ease-in, opacity 0.3s ease-in;
            overflow: visible;
        }
        
        /* éŠæˆ²èªªæ˜éŸ¿æ‡‰å¼ä½ˆå±€å„ªåŒ– */
        .help-section {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-top: 16px;
            padding: 20px !important;
        }
        
        .help-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        
        @media (min-width: 768px) {
            .help-grid {
                grid-template-columns: 1fr 1fr;
                gap: 32px;
            }
        }
        
        @media (min-width: 1024px) {
            .help-section {
                padding: 24px;
            }
            
            .help-grid {
                gap: 40px;
            }
        }
        
        /* éŠæˆ²èªªæ˜å…§å®¹æ¨£å¼å„ªåŒ– */
        .help-section h2 {
            margin-bottom: 20px;
            font-size: 1.125rem;
        }
        
        .help-section h3 {
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .help-section p, .help-section li {
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .help-section ol, .help-section ul {
            margin-bottom: 16px;
        }
        
        .help-section .example-box {
            margin-top: 16px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .help-section .info-box {
            margin-top: 16px;
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }
        
        @media (max-width: 640px) {
            .help-section {
                padding: 16px;
                margin-top: 12px;
            }
            
            .help-section h2 {
                font-size: 1rem;
                margin-bottom: 16px;
            }
            
            .help-section h3 {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }
            
            .help-section p, .help-section li {
                font-size: 0.85rem;
                line-height: 1.5;
            }
            
            .help-grid {
                gap: 20px;
            }
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .content-wrapper {
                padding: 16px 20px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .content-wrapper {
                padding: 12px 16px;
            }
            
            .grid-cell {
                width: 25px;
                height: 25px;
                font-size: 0.65rem;
            }
        }

        /* è¶…å°è¢å¹•å„ªåŒ– */
        @media (max-width: 360px) {
            body {
                padding: 2px;
            }
            
            .content-wrapper {
                padding: 8px 12px;
            }
            
            .grid-cell {
                width: 22px;
                height: 22px;
                font-size: 0.6rem;
                font-weight: 500;
            }
            
            .word-item {
                padding: 4px 6px;
            }
            
            .word-english {
                font-size: 0.65rem;
            }
            
            .word-chinese {
                font-size: 0.55rem;
            }
        }

        /* æ¥µå°è¢å¹•å„ªåŒ– */
        @media (max-width: 320px) {
            .grid-cell {
                width: 20px;
                height: 20px;
                font-size: 0.55rem;
            }
            
            .main-container {
                border-radius: 8px;
            }
            
            .content-wrapper {
                padding: 6px 10px;
            }
        }

        /* å½ˆå‡ºå¼è¦–çª—æ¨£å¼ */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 460px;
            padding: 25px;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .popup-overlay.active .popup {
            transform: translateY(0);
        }

        .popup h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .popup .buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .popup .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .popup .btn:active {
            transform: scale(0.97);
        }

        .popup .keep-btn {
            background-color: #f2f5fc;
            color: #4a6cd6;
            border: 2px solid #4a6cd6;
        }

        .popup .keep-btn:hover {
            background-color: #e0e6f5;
        }

        /* éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ„æ¨£å¼ */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .sound-toggle.muted {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .sound-toggle.muted:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* éŸ³æ•ˆå‹•ç•« */
        @keyframes soundWave {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .sound-toggle.playing {
            animation: soundWave 0.3s ease-in-out;
        }

        /* éŸ¿æ‡‰å¼éŸ³æ•ˆæŒ‰éˆ• */
        @media (max-width: 768px) {
            .sound-toggle {
                top: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .sound-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }
        }

        /* éŸ³æ•ˆå‹•ç•«ï¼ˆå…±ç”¨ï¼‰ */
        @keyframes soundWave {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ•æ¨£å¼ - æ–°è¨­è¨ˆ */
        .sound-toggle-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .sound-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .sound-toggle-btn.muted {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .sound-toggle-btn.muted:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .sound-toggle-btn.muted .sound-text {
            content: "é—œé–‰";
        }

        /* éŸ³æ•ˆæŒ‰éˆ•å‹•ç•« */
        .sound-toggle-btn.playing {
            animation: soundWave 0.3s ease-in-out;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 640px) {
            .sound-toggle-btn {
                padding: 10px 18px;
                font-size: 0.8rem;
            }
            
            .sound-toggle-btn .sound-text {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .sound-toggle-btn {
                padding: 8px 16px;
                font-size: 0.75rem;
            }
        }

        /* æ›¿æ› Tailwind CSS çš„å·¥å…·é¡åˆ¥ */
        
        /* ä½ˆå±€ */
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .items-end { align-items: flex-end; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .space-x-1 > :not([hidden]) ~ :not([hidden]) { margin-left: 0.25rem; }
        .space-y-1 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.25rem; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-6 { gap: 1.5rem; }
        
        /* Grid ç³»çµ± */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        
        @media (min-width: 768px) {
            .md\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        
        @media (min-width: 1024px) {
            .lg\\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            .lg\\:max-h-60 { max-height: 15rem; }
        }
        
        @media (min-width: 1280px) {
            .xl\\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        }
        
        /* å¯¬åº¦å’Œé«˜åº¦ */
        .w-4 { width: 1rem; }
        .w-6 { width: 1.5rem; }
        .w-8 { width: 2rem; }
        .w-full { width: 100%; }
        .h-4 { height: 1rem; }
        .h-6 { height: 1.5rem; }
        .h-8 { height: 2rem; }
        .max-h-48 { max-height: 12rem; }
        
        /* å…§å¤–é‚Šè· */
        .p-1 { padding: 0.25rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-1 { padding-left: 0.25rem; padding-right: 0.25rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        
        .m-0 { margin: 0; }
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mr-3 { margin-right: 0.75rem; }
        .ml-1 { margin-left: 0.25rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        
        /* æ–‡å­— */
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        
        @media (min-width: 640px) {
            .sm\\:text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        }
        
        @media (min-width: 640px) {
            .sm\\:text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
            .sm\\:text-base { font-size: 1rem; line-height: 1.5rem; }
        }
        
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .text-center { text-align: center; }
        
        /* é¡è‰² */
        .text-white { color: rgb(255 255 255); }
        .text-sky-500 { color: rgb(14 165 233); }
        .text-sky-600 { color: rgb(2 132 199); }
        .text-sky-700 { color: rgb(3 105 161); }
        .text-sky-800 { color: rgb(7 89 133); }
        .text-slate-500 { color: rgb(100 116 139); }
        .text-slate-600 { color: rgb(71 85 105); }
        .text-slate-700 { color: rgb(51 65 85); }
        .text-amber-600 { color: rgb(217 119 6); }
        .text-green-600 { color: rgb(22 163 74); }
        .text-blue-600 { color: rgb(37 99 235); }
        .text-blue-700 { color: rgb(29 78 216); }
        .text-purple-700 { color: rgb(126 34 206); }
        
        /* èƒŒæ™¯é¡è‰² */
        .bg-white { background-color: rgb(255 255 255); }
        .bg-sky-50 { background-color: rgb(240 249 255); }
        .bg-sky-500 { background-color: rgb(14 165 233); }
        .bg-sky-600 { background-color: rgb(2 132 199); }
        .bg-slate-50 { background-color: rgb(248 250 252); }
        .bg-amber-100 { background-color: rgb(254 243 199); }
        .bg-amber-400 { background-color: rgb(251 191 36); }
        .bg-green-100 { background-color: rgb(220 252 231); }
        .bg-green-400 { background-color: rgb(74 222 128) !important; }
        .bg-green-50 { background-color: rgb(240 253 244); }
        .bg-yellow-100 { background-color: rgb(254 249 195); }
        .bg-sky-200 { background-color: rgb(186 230 253); }
        .bg-blue-50 { background-color: rgb(239 246 255); }
        .bg-purple-100 { background-color: rgb(243 232 255); }
        .bg-slate-100 { background-color: rgb(241 245 249); }
        
        /* é‚Šæ¡† */
        .border { border-width: 1px; border-style: solid; }
        .border-2 { border-width: 2px; border-style: solid; }
        .border-sky-200 { border-color: rgb(186 230 253); }
        .border-slate-200 { border-color: rgb(226 232 240); }
        .border-blue-200 { border-color: rgb(191 219 254); }
        .border-yellow-400 { border-color: rgb(250 204 21); }
        
        /* åœ“è§’ */
        .rounded { border-radius: 0.25rem; }
        .rounded-md { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        
        /* é™°å½± */
        .shadow-inner { box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05); }
        
        /* å…¶ä»–å·¥å…·é¡åˆ¥ */
        .hidden { display: none; }
        .inline-flex { display: inline-flex; }
        .overflow-y-auto { overflow-y: auto; }
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        
        /* æ‡¸åœæ•ˆæœ */
        .hover\\:bg-sky-600:hover { background-color: rgb(2 132 199); }

        .text-purple-700 { color: rgb(126 34 206); }
        
        /* èƒŒæ™¯é¡è‰² */
        .bg-slate-100 { background-color: rgb(241 245 249); }

        .text-purple-700 { color: rgb(126 34 206); }
        .text-red-600 { color: rgb(220 38 38); }
        
        /* èƒŒæ™¯é¡è‰² */
        .bg-slate-100 { background-color: rgb(241 245 249); }

        /* æ‡¸åœæ•ˆæœ */
        .hover\\:bg-sky-600:hover { background-color: rgb(2 132 199); }

        /* å…¶ä»–å·¥å…·é¡åˆ¥ */
        .hidden { display: none; }
        .inline-flex { display: inline-flex; }
        .overflow-y-auto { overflow-y: auto; }
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        
        /* Code æ¨™ç±¤æ¨£å¼ */
        code {
            background-color: rgb(241 245 249); /* bg-slate-100 */
            padding: 0.125rem 0.25rem; /* px-1 */
            border-radius: 0.25rem; /* rounded */
            font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.875em;
        }
        
        /* æ‡¸åœæ•ˆæœ */
        .hover\\:bg-sky-600:hover { background-color: rgb(2 132 199); }

        .text-red-600 { color: rgb(220 38 38); }
        
        /* èƒŒæ™¯é¡è‰² */
        .bg-green-50 { background-color: rgb(240 253 244); }
        
        /* æ‡¸åœæ•ˆæœ */
        .hover\\:bg-sky-600:hover { background-color: rgb(2 132 199); }

        /* æ‡¸åœæ•ˆæœ */
        .hover\\:bg-sky-600:hover { background-color: rgb(2 132 199); }
        
        /* æŒ‰éˆ•æ¨£å¼å„ªåŒ– */
        #regenerateBtn {
            border: none !important;
            outline: none;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
        }
        
        #regenerateBtn:hover {
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
            transform: translateY(-1px);
        }
        
        #regenerateBtn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        #regenerateBtn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }
        
        #regenerateBtn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }
        
        /* å„ªåŒ–çš„å–®å­—åˆ—è¡¨ä½ˆå±€ */
        .word-list-flex {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: flex-start;
            padding: 6px;
        }
        
        .word-list-flex .word-item {
            flex: 0 0 auto;
            min-width: 120px;
            max-width: 180px;
            padding: 6px 10px;
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        .word-list-flex .word-english {
            font-size: 0.85rem;
            margin-bottom: 1px;
        }
        
        .word-list-flex .word-chinese {
            font-size: 0.7rem;
            line-height: 1.2;
        }
        
        /* éŸ¿æ‡‰å¼å„ªåŒ– */
        @media (min-width: 768px) {
            .word-list-flex .word-item {
                min-width: 140px;
                max-width: 200px;
                padding: 8px 12px;
                font-size: 0.875rem;
            }
            
            .word-list-flex .word-english {
                font-size: 0.9rem;
            }
            
            .word-list-flex .word-chinese {
                font-size: 0.75rem;
            }
        }
        
        @media (min-width: 1024px) {
            .word-list-flex .word-item {
                min-width: 150px;
                max-width: 220px;
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            
            .word-list-flex .word-english {
                font-size: 1rem;
            }
            
            .word-list-flex .word-chinese {
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 640px) {
            .word-list-flex {
                gap: 4px;
            }
            
            .word-list-flex .word-item {
                min-width: 100px;
                max-width: 140px;
                padding: 5px 8px;
                font-size: 0.75rem;
            }
            
            .word-list-flex .word-english {
                font-size: 0.8rem;
            }
            
            .word-list-flex .word-chinese {
                font-size: 0.65rem;
            }
        }
        
        @media (max-width: 480px) {
            .word-list-flex .word-item {
                min-width: 90px;
                max-width: 120px;
                padding: 4px 6px;
                font-size: 0.7rem;
            }
            
            .word-list-flex .word-english {
                font-size: 0.75rem;
            }
            
            .word-list-flex .word-chinese {
                font-size: 0.6rem;
            }
        }

        @media (max-width: 480px) {
            .word-list-flex .word-item {
                min-width: 90px;
                max-width: 120px;
                padding: 4px 6px;
                font-size: 0.7rem;
            }
            
            .word-list-flex .word-english {
                font-size: 0.75rem;
            }
            
            .word-list-flex .word-chinese {
                font-size: 0.6rem;
            }
        }
        
        /* éŠæˆ²èªªæ˜ç©ºé–“å„ªåŒ– */
        @media (max-width: 768px) {
            .help-section {
                padding: 14px !important;
            }
        }
        
        @media (max-width: 640px) {
            .help-section {
                padding: 10px !important;
                margin-top: 10px;
            }
            
            .help-section h2 {
                font-size: 0.95rem !important;
                margin-bottom: 14px !important;
            }
            
            .help-section h3 {
                font-size: 0.85rem !important;
                margin-bottom: 6px !important;
            }
            
            .help-section p, .help-section li {
                font-size: 0.8rem !important;
                line-height: 1.4 !important;
                margin-bottom: 4px !important;
            }
        }
        
        @media (max-width: 480px) {
            .help-section {
                padding: 8px !important;
                margin-top: 8px;
            }
            
            .help-section h2 {
                font-size: 0.9rem !important;
                margin-bottom: 12px !important;
            }
            
            .help-section h3 {
                font-size: 0.8rem !important;
                margin-bottom: 4px !important;
            }
            
            .help-section p, .help-section li {
                font-size: 0.75rem !important;
                line-height: 1.3 !important;
                margin-bottom: 3px !important;
            }
            
            .help-grid {
                gap: 16px !important;
            }
        }

        /* ç¢ºä¿ç¶ è‰²CATæ¼”ç¤ºæ­£ç¢ºé¡¯ç¤º */
        .help-section .example-box .bg-green-400 {
            background-color: rgb(74 222 128) !important;
            color: white !important;
            width: 2rem !important;
            height: 2rem !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 0.25rem !important;
            font-weight: 700 !important;
            font-size: 0.875rem !important;
        }
        
        /* ç¢ºä¿å…¶ä»–æ¼”ç¤ºæ¨£å¼ä¹Ÿæ­£ç¢º */
        .help-section .example-box .bg-amber-400 {
            background-color: rgb(251 191 36) !important;
            color: white !important;
        }
        
        .help-section .example-box .bg-yellow-100 {
            background-color: rgb(254 249 195) !important;
        }
        
        .help-section .example-box .border-yellow-400 {
            border-color: rgb(250 204 21) !important;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="content-wrapper">
            <header class="mb-6 text-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-sky-600"><i class="fas fa-th mr-2 text-sky-600"></i>å­—å½™è¬é¡Œ</h1>
            </header>

            <!-- å¯æ”¶åˆçš„éŠæˆ²èªªæ˜ -->
            <div class="mb-6">
                <div class="flex flex-wrap gap-3 justify-center items-center">
                    <button id="helpToggleBtn" class="help-toggle-btn">
                        <i class="fas fa-question-circle mr-2"></i>
                        <span>éŠæˆ²èªªæ˜</span>
                        <svg class="icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <!-- éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ• -->
                    <button id="soundToggle" class="sound-toggle-btn" title="éŸ³æ•ˆæ§åˆ¶">
                        <i class="fas fa-volume-up mr-2"></i>
                        <span class="sound-text">é–‹å•Ÿ</span>
                        <i class="fas fa-music ml-1"></i>
                    </button>
                </div>
                
                <div id="helpContent" class="help-content">
                    <div class="help-section">
                        <!-- ç°¡åŒ–æ¨™é¡Œå€ -->
                        <div class="text-center mb-6">
                            <h2 class="text-sky-800 text-lg font-bold">åœ¨ç¶²æ ¼ä¸­æ‰¾å‡ºæ‰€æœ‰éš±è—çš„è‹±æ–‡å–®å­—ï¼</h2>
                        </div>
                        
                        <!-- æ ¸å¿ƒæ“ä½œèªªæ˜ -->
                        <div class="help-grid">
                            <div>
                                <h3 class="text-sky-700 flex items-center mb-3">
                                    <span class="w-6 h-6 bg-sky-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-2">1</span>
                                    é»æ“Šèµ·å§‹å­—æ¯
                                </h3>
                                <div class="example-box text-center">
                                    <p class="text-xs text-slate-500 mb-2">é»æ“Šå–®å­—çš„ç¬¬ä¸€å€‹å­—æ¯</p>
                                    <div class="inline-flex space-x-1">
                                        <div class="w-8 h-8 bg-amber-400 text-white text-sm flex items-center justify-center rounded font-bold shadow-md">C</div>
                                        <div class="w-8 h-8 bg-slate-100 text-slate-400 text-sm flex items-center justify-center rounded">A</div>
                                        <div class="w-8 h-8 bg-slate-100 text-slate-400 text-sm flex items-center justify-center rounded">T</div>
                                    </div>
                                </div>
                                
                                <h3 class="text-sky-700 flex items-center mb-3 mt-4">
                                    <span class="w-6 h-6 bg-sky-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-2">2</span>
                                    é»æ“ŠçµæŸå­—æ¯
                                </h3>
                                <div class="example-box text-center">
                                    <p class="text-xs text-slate-500 mb-2">å†é»æ“Šå–®å­—çš„æœ€å¾Œä¸€å€‹å­—æ¯</p>
                                    <div class="inline-flex space-x-1">
                                        <div class="w-8 h-8 bg-amber-400 text-white text-sm flex items-center justify-center rounded font-bold">C</div>
                                        <div class="w-8 h-8 bg-yellow-100 border-yellow-400 border text-sm flex items-center justify-center rounded">A</div>
                                        <div class="w-8 h-8 bg-yellow-100 border-yellow-400 border-2 text-sm flex items-center justify-center rounded font-bold shadow-md">T</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-sky-700 flex items-center mb-3 mt-4">
                                    <span class="w-6 h-6 bg-sky-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-2">3</span>
                                    å®Œæˆï¼
                                </h3>
                                <div class="example-box text-center">
                                    <p class="text-xs text-slate-500 mb-2">æ‰¾åˆ°çš„å–®å­—æœƒè®Šç¶ è‰²</p>
                                    <div class="inline-flex space-x-1 mb-3">
                                        <div class="w-8 h-8 bg-green-400 text-white text-sm flex items-center justify-center rounded font-bold">C</div>
                                        <div class="w-8 h-8 bg-green-400 text-white text-sm flex items-center justify-center rounded font-bold">A</div>
                                        <div class="w-8 h-8 bg-green-400 text-white text-sm flex items-center justify-center rounded font-bold">T</div>
                                    </div>
                                </div>
                                
                                <div class="info-box">
                                    <h4 class="text-sky-700 font-semibold mb-2 flex items-center">
                                        <i class="fas fa-lightbulb mr-2"></i>å°æç¤º
                                    </h4>
                                    <ul class="text-xs text-slate-600 space-y-1">
                                        <li>å–®å­—å¯èƒ½æ˜¯ â¡ï¸ â¬‡ï¸ â†—ï¸ â†™ï¸ ä»»ä½•æ­£å‘æˆ–åå‘æ’åˆ—</li>
                                        <li>å¡ä½äº†ï¼Ÿç­‰15ç§’æœƒè‡ªå‹•æç¤º ğŸ’¡</li>
                                        <li>é»éŒ¯äº†ï¼Ÿå†é»ä¸€æ¬¡é‡æ–°é¸æ“‡</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <div class="space-y-6 mb-6">
                <!-- è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                <div id="loadingIndicator" class="text-center py-8">
                    <div class="inline-flex items-center px-6 py-3 rounded-lg bg-sky-50 border border-sky-200">
                        <i class="fas fa-spinner fa-spin mr-3 text-sky-500"></i>
                        <span class="text-sky-700 font-medium">æ­£åœ¨è¼‰å…¥å–®å­—è³‡æ–™...</span>
                    </div>
                </div>

                <!-- å–®å­—åˆ—è¡¨ -->
                <div class="w-full">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-slate-700 flex items-center">
                            <i class="fas fa-list-ul mr-2 text-sky-600"></i>å¾…å°‹æ‰¾çš„å–®å­—:
                        </h2>
                        <div class="flex items-center gap-3">
                            <div class="text-sm text-slate-500 flex items-center">
                                <i class="fas fa-th mr-2"></i>
                                <span id="gridSizeDisplay">ç¶²æ ¼å¤§å°: è‡ªå‹•èª¿æ•´ä¸­...</span>
                            </div>
                            <button id="regenerateBtn" class="hidden px-3 py-1 text-xs bg-sky-500 text-white rounded-md hover:bg-sky-600 transition-colors flex items-center gap-1">
                                <i class="fas fa-sync-alt"></i>
                                <span>é‡æ–°ç”Ÿæˆ</span>
                            </button>
                        </div>
                    </div>
                    <div id="wordListContainer" class="word-list-container bg-slate-50 p-2 rounded-lg shadow-inner overflow-y-auto max-h-48 lg:max-h-60">
                        <div id="wordList" class="word-list-flex">
                        </div>
                    </div>
                </div>

                <!-- è¬é¡Œç¶²æ ¼ -->
                <div class="w-full">
                    <h2 class="text-xl font-semibold text-slate-700 mb-3 text-center flex items-center justify-center">
                        è¬é¡Œç¶²æ ¼
                    </h2>
                    <div class="flex justify-center">
                        <div id="puzzleGrid" class="grid rounded-lg shadow-inner bg-white border-2 border-slate-200" style="display: grid; aspect-ratio: 1 / 1; touch-action: none; max-width: min(600px, 80vh); width: 100%; gap: 0;">
                        </div>
                    </div>
                </div>
            </div>

            <div id="messageArea" class="text-center text-green-600 font-semibold mt-4 h-6"></div>
        </div>
    </div>

    <script>
        // ğŸµ éŸ³æ•ˆç³»çµ±
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.soundEnabled = true;
                this.sounds = {};
                this.init();
            }

            init() {
                // åˆå§‹åŒ– Web Audio Context
                try {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext();
                } catch (e) {
                    console.warn('Web Audio API ä¸æ”¯æ´');
                    this.soundEnabled = false;
                    return;
                }

                // é ç”ŸæˆéŸ³æ•ˆ
                this.generateSounds();
                
                // è¨­ç½®éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ•
                this.setupSoundToggle();
                
                // å¾ localStorage è®€å–ç”¨æˆ¶åå¥½
                const savedSetting = localStorage.getItem('vocabWall_soundEnabled');
                if (savedSetting !== null) {
                    this.soundEnabled = savedSetting === 'true';
                    this.updateToggleButton();
                }
            }

            generateSounds() {
                // ğŸ‰ æ‰¾åˆ°å–®å­—çš„éŸ³æ•ˆ (æ„‰æ‚…çš„éˆ´éºè²)
                this.sounds.wordFound = () => {
                    this.playTone(800, 0.1, 'sine');
                    setTimeout(() => this.playTone(1000, 0.1, 'sine'), 100);
                    setTimeout(() => this.playTone(1200, 0.2, 'sine'), 200);
                };

                // ğŸ† éŠæˆ²å®Œæˆçš„éŸ³æ•ˆ (å‹åˆ©éŸ³æ¨‚)
                this.sounds.gameComplete = () => {
                    const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
                    notes.forEach((frequency, index) => {
                        setTimeout(() => {
                            this.playTone(frequency, 0.3, 'sine');
                        }, index * 150);
                    });
                };

                // ğŸ”˜ é»æ“ŠéŸ³æ•ˆ (è¼•æŸ”çš„é»æ“Šè²)
                this.sounds.click = () => {
                    this.playTone(400, 0.05, 'sine');
                };

                // ğŸ¯ é¸æ“‡èµ·å§‹å­—æ¯çš„éŸ³æ•ˆ
                this.sounds.selectStart = () => {
                    this.playTone(600, 0.1, 'triangle');
                };

                // âŒ éŒ¯èª¤é¸æ“‡çš„éŸ³æ•ˆ
                this.sounds.error = () => {
                    this.playTone(200, 0.2, 'sawtooth');
                };

                // ğŸ’¡ æç¤ºéŸ³æ•ˆ
                this.sounds.hint = () => {
                    this.playTone(300, 0.1, 'sine');
                    setTimeout(() => this.playTone(350, 0.1, 'sine'), 100);
                    setTimeout(() => this.playTone(400, 0.1, 'sine'), 200);
                };

                // ğŸ”„ é‡æ–°ç”ŸæˆéŸ³æ•ˆ
                this.sounds.regenerate = () => {
                    this.playTone(450, 0.1, 'triangle');
                    setTimeout(() => this.playTone(350, 0.1, 'triangle'), 100);
                };
            }

            playTone(frequency, duration, type = 'sine', volume = 0.1) {
                if (!this.soundEnabled || !this.audioContext) return;

                try {
                    // æ¢å¾© AudioContextï¼ˆå¦‚æœéœ€è¦ï¼‰
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }

                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);

                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = type;

                    // éŸ³é‡åŒ…çµ¡
                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.warn('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e);
                }
            }

            setupSoundToggle() {
                const toggleBtn = document.getElementById('soundToggle');
                if (!toggleBtn) return;

                toggleBtn.addEventListener('click', () => {
                    this.toggleSound();
                    // æ’­æ”¾é»æ“ŠéŸ³æ•ˆï¼ˆå¦‚æœéŸ³æ•ˆæ˜¯é–‹å•Ÿçš„ï¼‰
                    setTimeout(() => this.sounds.click(), 50);
                });
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                localStorage.setItem('vocabWall_soundEnabled', this.soundEnabled.toString());
                this.updateToggleButton();
            }

            updateToggleButton() {
                const toggleBtn = document.getElementById('soundToggle');
                if (!toggleBtn) return;
                
                const icon = toggleBtn.querySelector('i');
                const soundText = toggleBtn.querySelector('.sound-text');
                
                if (this.soundEnabled) {
                    toggleBtn.classList.remove('muted');
                    if (icon) icon.className = 'fas fa-volume-up mr-2';
                    if (soundText) soundText.textContent = 'é–‹å•Ÿ';
                    toggleBtn.title = 'é—œé–‰éŸ³æ•ˆ';
                } else {
                    toggleBtn.classList.add('muted');
                    if (icon) icon.className = 'fas fa-volume-mute mr-2';
                    if (soundText) soundText.textContent = 'é—œé–‰';
                    toggleBtn.title = 'é–‹å•ŸéŸ³æ•ˆ';
                }
            }

            // æ’­æ”¾éŸ³æ•ˆçš„ä¾¿æ·æ–¹æ³•
            play(soundName) {
                if (this.sounds[soundName] && this.soundEnabled) {
                    this.sounds[soundName]();
                    
                    // æ·»åŠ è¦–è¦ºåé¥‹
                    const toggleBtn = document.getElementById('soundToggle');
                    if (toggleBtn && this.soundEnabled) {
                        toggleBtn.classList.add('playing');
                        setTimeout(() => {
                            toggleBtn.classList.remove('playing');
                        }, 300);
                    }
                }
            }
        }

        // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
        const soundSystem = new SoundSystem();

        // --- DOM Elements ---
        const puzzleGrid = document.getElementById('puzzleGrid');
        const wordListEl = document.getElementById('wordList');
        const messageArea = document.getElementById('messageArea');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const gridSizeDisplay = document.getElementById('gridSizeDisplay');

        // --- Global State ---
        let currentGrid = [];
        let wordsToFind = [];
        let foundWords = new Set();
        let gridSize = 15; // Default grid size
        
        // State for click mode
        let firstClick = null;

        // æç¤ºç³»çµ±è®Šæ•¸
        let inactivityTimer = null;
        let lastActivityTime = Date.now();
        let hintTimeout = 15000; // 15ç§’å¾Œé¡¯ç¤ºæç¤º
        let currentHint = null;
        let wordPositions = new Map(); // å„²å­˜æ¯å€‹å–®å­—åœ¨ç¶²æ ¼ä¸­çš„ä½ç½®

        // --- Utility Functions ---
        const getRandomLetter = () => {
            // åˆ†æå·²æ”¾ç½®å–®å­—çš„å¤§å°å¯«æ¯”ä¾‹
            let uppercaseCount = 0;
            let lowercaseCount = 0;
            
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    const char = currentGrid[r][c];
                    if (char && char !== '') {
                        if (char >= 'A' && char <= 'Z') uppercaseCount++;
                        else if (char >= 'a' && char <= 'z') lowercaseCount++;
                    }
                }
            }
            
            // å¦‚æœæ²’æœ‰å·²æ”¾ç½®çš„å­—æ¯ï¼Œé»˜èªä½¿ç”¨å¤§å°å¯«æ··åˆ
            if (uppercaseCount === 0 && lowercaseCount === 0) {
                const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
                return alphabet[Math.floor(Math.random() * alphabet.length)];
            }
            
            // æ ¹æ“šæ¯”ä¾‹æ±ºå®šç”Ÿæˆå¤§å¯«é‚„æ˜¯å°å¯«
            const total = uppercaseCount + lowercaseCount;
            const uppercaseRatio = uppercaseCount / total;
            
            if (Math.random() < uppercaseRatio) {
                const uppercaseAlphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                return uppercaseAlphabet[Math.floor(Math.random() * uppercaseAlphabet.length)];
            } else {
                const lowercaseAlphabet = "abcdefghijklmnopqrstuvwxyz";
                return lowercaseAlphabet[Math.floor(Math.random() * lowercaseAlphabet.length)];
            }
        };

        // ç²å– URL åƒæ•¸å‡½æ•¸
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // å¾ Google Sheet è¼‰å…¥è³‡æ–™
        async function loadSheetData() {
            const label = getQueryParam("label") || "";
            if (!label) {
                throw new Error("è«‹åœ¨URLä¸­æŒ‡å®šlabelåƒæ•¸ (ä¾‹å¦‚: ?label=toeic)");
            }

            const spreadsheetId = "1wSHAL3piJGEJ8EnoyK_W9kkvL42GQYId35UEhMzHTZY"; 
            const gid = "0"; 
            const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;

            try {
                const response = await fetch(spreadsheetUrl);
                if (!response.ok) throw new Error("ç„¡æ³•è¼‰å…¥è©¦ç®—è¡¨è³‡æ–™");
                const csvText = await response.text();
                if (!csvText.trim()) throw new Error("è©¦ç®—è¡¨å…§å®¹ç‚ºç©º");

                // è§£æ CSV
                const { data } = Papa.parse(csvText, { header: false });
                if (!data || data.length === 0) throw new Error("è§£æå¾Œçš„è³‡æ–™ç‚ºç©º");

                // å–è¡¨é ­
                const header = data.shift();
                if (!header) throw new Error("ç„¡æ³•æå–è¡¨é ­ï¼Œè³‡æ–™æ ¼å¼å¯èƒ½æœ‰èª¤");

                // éæ¿¾è³‡æ–™ï¼šåªä¿ç•™ç¬¬ä¸€æ¬„ (Label) ç¬¦åˆçš„
                const filteredData = data.filter(row => row[0] && row[0].toLowerCase() === label.toLowerCase());
                if (filteredData.length === 0) {
                    throw new Error(`æ‰¾ä¸åˆ°æ¨™ç±¤ç‚º "${label}" çš„å–®å­—è³‡æ–™`);
                }

                // å»é™¤æ¯è¡Œçš„ç¬¬ä¸€æ¬„ (Label)
                const processedData = filteredData.map(row => row.slice(1));

                // è½‰æ›æˆæˆ‘å€‘çš„è©å½™æ ¼å¼
                const vocabularyData = processedData.map(row => {
                    return {
                        word: (row[0] || "").trim(),
                        phonetic: (row[1] || "").trim(),
                        meaning: (row[2] || "").trim(),
                        example: (row[3] || "").trim(),
                        translation: (row[4] || "").trim(),
                        videoRelated: (row[5] || "").trim(),
                        markStart: (row[6] || "").trim(),
                        markEnd: (row[7] || "").trim()
                    };
                });

                // éæ¿¾æ‰ç©ºç™½çš„è³‡æ–™
                const validVocabularyData = vocabularyData.filter(word => 
                    word.word && word.meaning // è‡³å°‘è¦æœ‰å–®å­—å’Œæ„æ€
                );

                // é™åˆ¶æœ€å¤š30å€‹å–®å­—ï¼Œå¦‚æœè¶…éå‰‡éš¨æ©Ÿé¸æ“‡
                let finalVocabularyData = validVocabularyData;
                if (validVocabularyData.length > 30) {
                    finalVocabularyData = shuffleArray([...validVocabularyData]).slice(0, 30);
                }

                // æ’åºè©å½™ï¼ˆä¾ç…§å–®å­—å­—æ¯é †åºï¼‰
                finalVocabularyData.sort((a, b) => a.word.toLowerCase().localeCompare(b.word.toLowerCase()));
                
                return finalVocabularyData;
            } catch (error) {
                console.error("è¼‰å…¥è³‡æ–™å¤±æ•—:", error);
                throw error;
            }
        }

        // æ ¹æ“šè¢å¹•å°ºå¯¸ç²å–æ¨è–¦çš„æœ€å¤§å–®å­—æ•¸é‡
        function getRecommendedMaxWords() {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const isMobile = screenWidth <= 768;
            const isSmallMobile = screenWidth <= 480;
            
            if (isSmallMobile) {
                return 8; // è¶…å°è¢å¹•ï¼šæœ€å¤š8å€‹å–®å­—
            } else if (isMobile) {
                return 12; // æ‰‹æ©Ÿï¼šæœ€å¤š12å€‹å–®å­—
            } else if (screenWidth <= 1024) {
                return 18; // å¹³æ¿ï¼šæœ€å¤š18å€‹å–®å­—
            } else {
                return 25; // æ¡Œé¢ï¼šæœ€å¤š25å€‹å–®å­—
            }
        }

        // æ ¹æ“šè¢å¹•å°ºå¯¸å’Œå–®å­—æ•¸é‡æ™ºèƒ½è¨ˆç®—ç¶²æ ¼å¤§å°
        function calculateOptimalGridSize(wordCount) {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const isMobile = screenWidth <= 768;
            const isSmallMobile = screenWidth <= 480;
            
            // åŸºç¤ç¶²æ ¼å¤§å°è¨ˆç®—
            let baseGridSize;
            if (wordCount <= 5) baseGridSize = 8;
            else if (wordCount <= 8) baseGridSize = 10;
            else if (wordCount <= 12) baseGridSize = 12;
            else if (wordCount <= 15) baseGridSize = 14;
            else if (wordCount <= 18) baseGridSize = 16;
            else if (wordCount <= 22) baseGridSize = 18;
            else baseGridSize = 20;
            
            // æ ¹æ“šè¢å¹•å°ºå¯¸èª¿æ•´
            if (isSmallMobile) {
                return Math.min(baseGridSize, 12); // è¶…å°è¢å¹•é™åˆ¶æœ€å¤§12x12
            } else if (isMobile) {
                return Math.min(baseGridSize, 15); // æ‰‹æ©Ÿé™åˆ¶æœ€å¤§15x15
            } else {
                return baseGridSize;
            }
        }

        // é¡¯ç¤ºé›£åº¦é¸æ“‡å°è©±æ¡†
        function showDifficultySelection(vocabularyData) {
            const maxWords = getRecommendedMaxWords();
            const totalWords = vocabularyData.length;
            
            // å¦‚æœå–®å­—æ•¸é‡åœ¨æ¨è–¦ç¯„åœå…§ï¼Œç›´æ¥é–‹å§‹éŠæˆ²
            if (totalWords <= maxWords) {
                generatePuzzle(vocabularyData);
                return;
            }
            
            // å‰µå»ºé›£åº¦é¸æ“‡ç•Œé¢
            const difficultyOverlay = document.createElement('div');
            difficultyOverlay.className = 'popup-overlay active';
            difficultyOverlay.innerHTML = `
                <div class="popup">
                    <h3><i class="fas fa-cog mr-2"></i>é¸æ“‡éŠæˆ²é›£åº¦</h3>
                    <div style="margin-bottom: 20px; text-align: center; color: #666;">
                        <i class="fas fa-info-circle mr-2"></i>
                        åµæ¸¬åˆ°æ‚¨çš„è¢å¹•è¼ƒå°ï¼Œå»ºè­°èª¿æ•´å–®å­—æ•¸é‡ä»¥ç²å¾—æœ€ä½³éŠæˆ²é«”é©—
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button class="difficulty-btn easy-btn" data-count="${Math.min(8, totalWords)}">
                                <i class="fas fa-leaf mr-2"></i>
                                <div>
                                    <div style="font-weight: bold;">ç°¡å–®æ¨¡å¼</div>
                                    <div style="font-size: 0.8em; opacity: 0.7;">${Math.min(8, totalWords)} å€‹å–®å­—</div>
                                </div>
                            </button>
                            <button class="difficulty-btn medium-btn" data-count="${Math.min(maxWords, totalWords)}">
                                <i class="fas fa-star mr-2"></i>
                                <div>
                                    <div style="font-weight: bold;">æ¨è–¦æ¨¡å¼</div>
                                    <div style="font-size: 0.8em; opacity: 0.7;">${Math.min(maxWords, totalWords)} å€‹å–®å­—ï¼ˆå»ºè­°ï¼‰</div>
                                </div>
                            </button>
                            <button class="difficulty-btn hard-btn" data-count="${totalWords}">
                                <i class="fas fa-fire mr-2"></i>
                                <div>
                                    <div style="font-weight: bold;">æŒ‘æˆ°æ¨¡å¼</div>
                                    <div style="font-size: 0.8em; opacity: 0.7;">${totalWords} å€‹å–®å­—ï¼ˆå…¨éƒ¨ï¼‰</div>
                                </div>
                            </button>
                        </div>
                    </div>
                    <div class="buttons">
                        <button class="btn keep-btn" id="auto-select-btn">
                            <i class="fas fa-magic mr-2"></i>è‡ªå‹•é¸æ“‡
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(difficultyOverlay);
            
            // æ·»åŠ é›£åº¦æŒ‰éˆ•æ¨£å¼
            const style = document.createElement('style');
            style.textContent = `
                .difficulty-btn {
                    width: 100%;
                    padding: 15px;
                    border: 2px solid #e2e8f0;
                    border-radius: 8px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    text-align: left;
                }
                .difficulty-btn:hover {
                    border-color: #60a5fa;
                    background: #f8fafc;
                    transform: translateY(-1px);
                }
                .easy-btn { border-color: #10b981; }
                .easy-btn:hover { border-color: #059669; background: #f0fdf4; }
                .medium-btn { border-color: #f59e0b; }
                .medium-btn:hover { border-color: #d97706; background: #fffbeb; }
                .hard-btn { border-color: #ef4444; }
                .hard-btn:hover { border-color: #dc2626; background: #fef2f2; }
            `;
            document.head.appendChild(style);
            
            // äº‹ä»¶ç›£è½
            difficultyOverlay.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // ğŸµ æ’­æ”¾é»æ“ŠéŸ³æ•ˆ
                    soundSystem.play('click');
                    const wordCount = parseInt(btn.dataset.count);
                    const selectedWords = shuffleArray([...vocabularyData]).slice(0, wordCount);
                    difficultyOverlay.remove();
                    style.remove();
                    generatePuzzle(selectedWords);
                });
            });
            
            // è‡ªå‹•é¸æ“‡æŒ‰éˆ•
            difficultyOverlay.querySelector('#auto-select-btn').addEventListener('click', () => {
                // ğŸµ æ’­æ”¾é»æ“ŠéŸ³æ•ˆ
                soundSystem.play('click');
                const selectedWords = shuffleArray([...vocabularyData]).slice(0, maxWords);
                difficultyOverlay.remove();
                style.remove();
                generatePuzzle(selectedWords);
            });
        }

        // --- Puzzle Generation Logic ---
        function generatePuzzle(vocabularyData) {
            if (!vocabularyData || vocabularyData.length === 0) {
                showMessage("æ²’æœ‰å–®å­—è³‡æ–™å¯ä»¥ç”¢ç”Ÿè¬é¡Œã€‚", true);
                return;
            }

            // ä½¿ç”¨è¼‰å…¥çš„å–®å­—è³‡æ–™
            const targetWordCount = vocabularyData.length;
            const targetWords = vocabularyData.map(item => item.word);
            
            // æ™ºèƒ½é‡è©¦æ©Ÿåˆ¶ï¼šå˜—è©¦å¤šç¨®ç­–ç•¥ç¢ºä¿æ”¾å…¥æ‰€æœ‰å–®å­—
            let placedWords = [];
            let currentAttempt = 0;
            const maxAttempts = 5;
            
            while (placedWords.length < targetWordCount && currentAttempt < maxAttempts) {
                currentAttempt++;
                
                // æ ¹æ“šå˜—è©¦æ¬¡æ•¸èª¿æ•´ç­–ç•¥
                let adjustedGridSize;
                if (currentAttempt === 1) {
                    // ç¬¬ä¸€æ¬¡ï¼šä½¿ç”¨è¨ˆç®—çš„ç¶²æ ¼å¤§å°
                    adjustedGridSize = calculateOptimalGridSize(targetWordCount);
                } else {
                    // å¾ŒçºŒå˜—è©¦ï¼šé€æ¼¸å¢åŠ ç¶²æ ¼å¤§å°
                    adjustedGridSize = calculateOptimalGridSize(targetWordCount) + (currentAttempt - 1) * 2;
                    
                    // ç¢ºä¿ä¸æœƒè¶…éåˆç†ç¯„åœ
                    const maxReasonableSize = Math.min(25, Math.sqrt(targetWordCount * 8));
                    adjustedGridSize = Math.min(adjustedGridSize, maxReasonableSize);
                }
                
                // è¨­ç½®ç¶²æ ¼
                gridSize = adjustedGridSize;
                currentGrid = Array(gridSize).fill(null).map(() => Array(gridSize).fill(''));
                foundWords.clear();
                wordPositions.clear();
                
                // å˜—è©¦æ”¾ç½®å–®å­—
                placedWords = placeWordsWithRetry(currentGrid, targetWords, currentAttempt);
                
                // å¦‚æœæˆåŠŸæ”¾å…¥æ‰€æœ‰å–®å­—ï¼Œè·³å‡ºè¿´åœˆ
                if (placedWords.length === targetWordCount) {
                    break;
                }
                
                // å¦‚æœæ”¾å…¥çš„å–®å­—æ•¸é‡æ¥è¿‘ç›®æ¨™ï¼ˆ90%ä»¥ä¸Šï¼‰ï¼Œä¹Ÿæ¥å—
                if (placedWords.length >= Math.ceil(targetWordCount * 0.9)) {
                    break;
                }
            }
            
            // æ›´æ–°æœ€çµ‚çµæœ
            wordsToFind = placedWords;
            document.documentElement.style.setProperty('--grid-size', gridSize);
            
            // æ›´æ–°ç¶²æ ¼å¤§å°é¡¯ç¤º
            const successRate = Math.round((placedWords.length / targetWordCount) * 100);
            gridSizeDisplay.textContent = `ç¶²æ ¼å¤§å°: ${gridSize}Ã—${gridSize} (${placedWords.length}/${targetWordCount}å€‹å–®å­—, ${successRate}%)`;

            messageArea.textContent = '';
            clearClickSelection();

            // é¡¯ç¤ºçµæœè¨Šæ¯
            if (placedWords.length === targetWordCount) {
                showMessage("è¬é¡Œå·²å®Œç¾ç”¢ç”Ÿï¼æ‰€æœ‰å–®å­—éƒ½å·²æ”¾å…¥ç¶²æ ¼ã€‚");
            } else {
                showMessage(`è¬é¡Œå·²ç”¢ç”Ÿï¼æˆåŠŸæ”¾å…¥ ${placedWords.length}/${targetWordCount} å€‹å–®å­—ã€‚`);
            }

            fillEmptyCells(currentGrid);
            renderGrid(currentGrid);
            
            // åªæ¸²æŸ“æˆåŠŸæ”¾å…¥çš„å–®å­—
            const successfulVocabulary = vocabularyData.filter(item => 
                placedWords.includes(item.word)
            );
            renderWordList(successfulVocabulary);
            
            // ğŸ” ä¸€è‡´æ€§é©—è­‰æ©Ÿåˆ¶
            validatePuzzleConsistency(placedWords, successfulVocabulary);
            
            // é¡¯ç¤ºé‡æ–°ç”ŸæˆæŒ‰éˆ•ï¼ˆå¦‚æœæ²’æœ‰æ”¾å…¥æ‰€æœ‰å–®å­—ï¼‰
            const regenerateBtn = document.getElementById('regenerateBtn');
            if (placedWords.length < targetWordCount) {
                regenerateBtn.classList.remove('hidden');
                // æ›´æ–°æŒ‰éˆ•äº‹ä»¶ï¼ˆç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼‰
                const newRegenerateBtn = regenerateBtn.cloneNode(true);
                regenerateBtn.parentNode.replaceChild(newRegenerateBtn, regenerateBtn);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
                newRegenerateBtn.addEventListener('click', () => {
                    // ğŸµ æ’­æ”¾é‡æ–°ç”ŸæˆéŸ³æ•ˆ
                    soundSystem.play('regenerate');
                    generatePuzzle(vocabularyData);
                });
            } else {
                regenerateBtn.classList.add('hidden');
            }
        }

        // ğŸ” å®Œæ•´çš„ä¸€è‡´æ€§é©—è­‰å‡½æ•¸
        function validatePuzzleConsistency(placedWords, successfulVocabulary) {
            console.group('ğŸ” è¬é¡Œä¸€è‡´æ€§é©—è­‰');
            
            // 1. æª¢æŸ¥ wordsToFind èˆ‡ placedWords æ˜¯å¦ä¸€è‡´
            const wordsToFindSet = new Set(wordsToFind);
            const placedWordsSet = new Set(placedWords);
            
            console.log('ğŸ“Š åŸºæœ¬çµ±è¨ˆ:');
            console.log(`   wordsToFind æ•¸é‡: ${wordsToFind.length}`);
            console.log(`   placedWords æ•¸é‡: ${placedWords.length}`);
            console.log(`   successfulVocabulary æ•¸é‡: ${successfulVocabulary.length}`);
            
            // 2. æª¢æŸ¥å¾…å°‹æ‰¾æ¸…å–®æ˜¯å¦èˆ‡ç¶²æ ¼å…§å–®å­—ä¸€è‡´
            const isWordsToFindConsistent = wordsToFind.length === placedWords.length && 
                wordsToFind.every(word => placedWordsSet.has(word));
            
            console.log(`âœ… wordsToFind èˆ‡ placedWords ä¸€è‡´æ€§: ${isWordsToFindConsistent ? 'é€šé' : 'âŒ å¤±æ•—'}`);
            
            if (!isWordsToFindConsistent) {
                const onlyInWordsToFind = wordsToFind.filter(word => !placedWordsSet.has(word));
                const onlyInPlacedWords = placedWords.filter(word => !wordsToFindSet.has(word));
                
                if (onlyInWordsToFind.length > 0) {
                    console.warn('âš ï¸ å­˜åœ¨æ–¼ wordsToFind ä½†ä¸åœ¨ placedWords:', onlyInWordsToFind);
                }
                if (onlyInPlacedWords.length > 0) {
                    console.warn('âš ï¸ å­˜åœ¨æ–¼ placedWords ä½†ä¸åœ¨ wordsToFind:', onlyInPlacedWords);
                }
            }
            
            // 3. æª¢æŸ¥å–®å­—åˆ—è¡¨æ˜¯å¦èˆ‡ç¶²æ ¼å…§å–®å­—ä¸€è‡´
            const vocabularyWords = successfulVocabulary.map(item => item.word);
            const vocabularyWordsSet = new Set(vocabularyWords);
            
            const isVocabularyConsistent = vocabularyWords.length === placedWords.length &&
                vocabularyWords.every(word => placedWordsSet.has(word));
                
            console.log(`âœ… successfulVocabulary èˆ‡ placedWords ä¸€è‡´æ€§: ${isVocabularyConsistent ? 'é€šé' : 'âŒ å¤±æ•—'}`);
            
            if (!isVocabularyConsistent) {
                const onlyInVocabulary = vocabularyWords.filter(word => !placedWordsSet.has(word));
                const onlyInPlaced = placedWords.filter(word => !vocabularyWordsSet.has(word));
                
                if (onlyInVocabulary.length > 0) {
                    console.warn('âš ï¸ å­˜åœ¨æ–¼ vocabulary ä½†ä¸åœ¨ placedWords:', onlyInVocabulary);
                }
                if (onlyInPlaced.length > 0) {
                    console.warn('âš ï¸ å­˜åœ¨æ–¼ placedWords ä½†ä¸åœ¨ vocabulary:', onlyInPlaced);
                }
            }
            
            // 4. æª¢æŸ¥ç¶²æ ¼ä¸­å¯¦éš›åŒ…å«çš„å–®å­—
            const gridWords = extractWordsFromGrid();
            const gridWordsSet = new Set(gridWords);
            
            console.log(`ğŸ“ ç¶²æ ¼ä¸­å¯¦éš›æ‰¾åˆ°çš„å–®å­—æ•¸é‡: ${gridWords.length}`);
            console.log(`ğŸ“ ç¶²æ ¼ä¸­çš„å–®å­—: [${gridWords.join(', ')}]`);
            
            const isGridConsistent = gridWords.length === placedWords.length &&
                gridWords.every(word => placedWordsSet.has(word));
                
            console.log(`âœ… ç¶²æ ¼å¯¦éš›å…§å®¹èˆ‡ placedWords ä¸€è‡´æ€§: ${isGridConsistent ? 'é€šé' : 'âŒ å¤±æ•—'}`);
            
            if (!isGridConsistent) {
                const onlyInGrid = gridWords.filter(word => !placedWordsSet.has(word));
                const onlyInPlaced = placedWords.filter(word => !gridWordsSet.has(word));
                
                if (onlyInGrid.length > 0) {
                    console.warn('âš ï¸ å­˜åœ¨æ–¼ç¶²æ ¼ä½†ä¸åœ¨ placedWords:', onlyInGrid);
                }
                if (onlyInPlaced.length > 0) {
                    console.warn('âš ï¸ å­˜åœ¨æ–¼ placedWords ä½†ä¸åœ¨ç¶²æ ¼:', onlyInPlaced);
                }
            }
            
            // 5. ç¸½çµ
            const overallConsistency = isWordsToFindConsistent && isVocabularyConsistent && isGridConsistent;
            
            if (overallConsistency) {
                console.log('ğŸ‰ å®Œæ•´ä¸€è‡´æ€§é©—è­‰é€šéï¼æ‰€æœ‰æ•¸æ“šçµæ§‹ä¿æŒåŒæ­¥ã€‚');
            } else {
                console.error('âŒ ç™¼ç¾ä¸€è‡´æ€§å•é¡Œï¼éœ€è¦ä¿®å¾©æ•¸æ“šåŒæ­¥ã€‚');
                
                // è‡ªå‹•ä¿®å¾©æ©Ÿåˆ¶
                console.log('ğŸ”§ å˜—è©¦è‡ªå‹•ä¿®å¾©...');
                fixConsistencyIssues(placedWords, successfulVocabulary);
            }
            
            console.groupEnd();
        }

        // ğŸ”§ è‡ªå‹•ä¿®å¾©ä¸€è‡´æ€§å•é¡Œ
        function fixConsistencyIssues(placedWords, successfulVocabulary) {
            // ç¢ºä¿ wordsToFind èˆ‡å¯¦éš›æ”¾ç½®çš„å–®å­—ä¸€è‡´
            wordsToFind = [...placedWords];
            
            // é‡æ–°æ¸²æŸ“å–®å­—åˆ—è¡¨ï¼Œç¢ºä¿åªé¡¯ç¤ºå¯¦éš›æ”¾ç½®çš„å–®å­—
            const correctedVocabulary = successfulVocabulary.filter(item => 
                placedWords.includes(item.word)
            );
            
            if (correctedVocabulary.length !== successfulVocabulary.length) {
                console.log('ğŸ”§ é‡æ–°æ¸²æŸ“å–®å­—åˆ—è¡¨ä»¥ç¢ºä¿ä¸€è‡´æ€§');
                renderWordList(correctedVocabulary);
            }
            
            console.log('âœ… è‡ªå‹•ä¿®å¾©å®Œæˆ');
        }

        // ğŸ“ å¾ç¶²æ ¼ä¸­æå–å¯¦éš›å­˜åœ¨çš„å–®å­—
        function extractWordsFromGrid() {
            const foundWords = [];
            
            // å¾ wordPositions ä¸­æå–ï¼ˆé€™æ˜¯æœ€å¯é çš„ä¾†æºï¼‰
            for (const [word, position] of wordPositions.entries()) {
                foundWords.push(word);
            }
            
            return foundWords.sort(); // æ’åºä»¥ä¾¿æ¯”è¼ƒ
        }

        // æ”¹é€²çš„å–®å­—æ”¾ç½®å‡½æ•¸ï¼ŒåŒ…å«é‡è©¦é‚è¼¯
        function placeWordsWithRetry(grid, words, attemptNumber) {
            const directions = [
                { dr: 0, dc: 1 },  // Horizontal (R)
                { dr: 1, dc: 0 },  // Vertical (D)
                { dr: 1, dc: 1 },  // Diagonal (DR)
                { dr: 1, dc: -1 }, // Diagonal (DL)
                { dr: 0, dc: -1 }, // Horizontal (L)
                { dr: -1, dc: 0 }, // Vertical (U)
                { dr: -1, dc: -1}, // Diagonal (UL)
                { dr: -1, dc: 1 }  // Diagonal (UR)
            ];
            
            // æ ¹æ“šå˜—è©¦æ¬¡æ•¸èª¿æ•´ç­–ç•¥
            let maxAttemptsPerWord = 100;
            let sortStrategy = 'length'; // 'length', 'random', 'difficulty'
            
            if (attemptNumber > 1) {
                maxAttemptsPerWord = 150 + (attemptNumber - 1) * 50; // å¢åŠ å–®å­—å˜—è©¦æ¬¡æ•¸
            }
            
            if (attemptNumber > 3) {
                sortStrategy = 'random'; // æ”¹è®Šæ’åºç­–ç•¥
            }
            
            const successfullyPlacedWords = [];

            // æ ¹æ“šç­–ç•¥æ’åºå–®å­—
            let sortedWords;
            switch (sortStrategy) {
                case 'random':
                    sortedWords = shuffleArray([...words]);
                    break;
                case 'difficulty':
                    // å…ˆæ”¾çŸ­å–®å­—ï¼Œå†æ”¾é•·å–®å­—
                    sortedWords = [...words].sort((a, b) => a.length - b.length);
                    break;
                default: // 'length'
                    // å…ˆæ”¾é•·å–®å­—ï¼Œå†æ”¾çŸ­å–®å­—ï¼ˆåŸæœ¬çš„ç­–ç•¥ï¼‰
                    sortedWords = [...words].sort((a, b) => b.length - a.length);
            }

            for (const word of sortedWords) {
                let placed = false;
                
                for (let attempt = 0; attempt < maxAttemptsPerWord; attempt++) {
                    // æ ¹æ“šå˜—è©¦æ¬¡æ•¸èª¿æ•´æ–¹å‘é¸æ“‡
                    let availableDirections = [...directions];
                    if (attemptNumber <= 2 && attempt < 50) {
                        // å‰å¹¾æ¬¡å˜—è©¦å„ªå…ˆä½¿ç”¨ç°¡å–®æ–¹å‘
                        availableDirections = directions.slice(0, 4);
                    }
                    
                    const dir = availableDirections[Math.floor(Math.random() * availableDirections.length)];
                    const startRow = Math.floor(Math.random() * gridSize);
                    const startCol = Math.floor(Math.random() * gridSize);

                    if (canPlaceWord(grid, word, startRow, startCol, dir)) {
                        // è¨˜éŒ„å–®å­—ä½ç½®
                        const positions = [];
                        for (let i = 0; i < word.length; i++) {
                            const row = startRow + i * dir.dr;
                            const col = startCol + i * dir.dc;
                            grid[row][col] = word[i];
                            positions.push({ row, col });
                        }
                        
                        // å„²å­˜å–®å­—çš„å®Œæ•´ä½ç½®è³‡è¨Š
                        wordPositions.set(word, {
                            positions: positions,
                            startPos: { row: startRow, col: startCol },
                            endPos: { row: startRow + (word.length - 1) * dir.dr, col: startCol + (word.length - 1) * dir.dc },
                            direction: dir
                        });
                        
                        successfullyPlacedWords.push(word);
                        placed = true;
                        break;
                    }
                }
                
                if (!placed) {
                    console.warn(`å˜—è©¦ ${attemptNumber}: ç„¡æ³•æ”¾ç½®å–®å­— "${word}"`);
                }
            }
            
            return successfullyPlacedWords;
        }

        function placeWords(grid, words) {
            const directions = [
                { dr: 0, dc: 1 },  // Horizontal (R)
                { dr: 1, dc: 0 },  // Vertical (D)
                { dr: 1, dc: 1 },  // Diagonal (DR)
                { dr: 1, dc: -1 }, // Diagonal (DL)
                // To make it harder, you can add reverse directions
                { dr: 0, dc: -1 }, // Horizontal (L) - Harder
                { dr: -1, dc: 0 }, // Vertical (U) - Harder
                { dr: -1, dc: -1}, // Diagonal (UL) - Harder
                { dr: -1, dc: 1 }  // Diagonal (UR) - Harder
            ];
            const successfullyPlacedWords = [];

            // æ¸…ç©ºå–®å­—ä½ç½®è¨˜éŒ„
            wordPositions.clear();

            // Sort words by length, longest first, to improve placement chances
            const sortedWords = [...words].sort((a, b) => b.length - a.length);

            for (const word of sortedWords) {
                let placed = false;
                for (let attempt = 0; attempt < 100; attempt++) { // Max 100 attempts per word
                    const dir = directions[Math.floor(Math.random() * directions.length)];
                    const startRow = Math.floor(Math.random() * gridSize);
                    const startCol = Math.floor(Math.random() * gridSize);

                    if (canPlaceWord(grid, word, startRow, startCol, dir)) {
                        // è¨˜éŒ„å–®å­—ä½ç½®
                        const positions = [];
                        for (let i = 0; i < word.length; i++) {
                            const row = startRow + i * dir.dr;
                            const col = startCol + i * dir.dc;
                            grid[row][col] = word[i];
                            positions.push({ row, col });
                        }
                        
                        // å„²å­˜å–®å­—çš„å®Œæ•´ä½ç½®è³‡è¨Š
                        wordPositions.set(word, {
                            positions: positions,
                            startPos: { row: startRow, col: startCol },
                            endPos: { row: startRow + (word.length - 1) * dir.dr, col: startCol + (word.length - 1) * dir.dc },
                            direction: dir
                        });
                        
                        successfullyPlacedWords.push(word);
                        placed = true;
                        break;
                    }
                }
                // If you want to inform which words couldn't be placed:
                // if (!placed) console.warn(`Could not place word: ${word}`);
            }
            return successfullyPlacedWords;
        }

        function canPlaceWord(grid, word, r, c, dir) {
            for (let i = 0; i < word.length; i++) {
                const newRow = r + i * dir.dr;
                const newCol = c + i * dir.dc;

                if (newRow < 0 || newRow >= gridSize || newCol < 0 || newCol >= gridSize) {
                    return false; // Out of bounds
                }
                if (grid[newRow][newCol] !== '' && grid[newRow][newCol] !== word[i]) {
                    return false; // Cell occupied by a different letter
                }
            }
            return true;
        }

        function fillEmptyCells(grid) {
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    if (grid[r][c] === '') {
                        grid[r][c] = getRandomLetter();
                    }
                }
            }
        }

        // --- Rendering Logic ---
        function renderGrid(grid) {
            puzzleGrid.innerHTML = '';
            puzzleGrid.style.gridTemplateColumns = `repeat(${gridSize}, minmax(0, 1fr))`;
            puzzleGrid.style.gridTemplateRows = `repeat(${gridSize}, minmax(0, 1fr))`;


            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell'); // éŸ¿æ‡‰å¼æ–‡å­—å¤§å°ç”± CSS æ§åˆ¶
                    cell.textContent = grid[r][c];
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    puzzleGrid.appendChild(cell);
                }
            }
        }

        function renderWordList(vocabularyData) {
            wordListEl.innerHTML = '';
            vocabularyData.forEach(wordData => {
                const wordItem = document.createElement('div');
                wordItem.classList.add('word-item');
                wordItem.id = `word-${wordData.word}`;
                
                const wordContent = document.createElement('div');
                wordContent.innerHTML = `
                    <div class="word-english">${wordData.word}</div>
                    <div class="word-chinese">${wordData.meaning}</div>
                `;
                
                wordItem.appendChild(wordContent);
                wordListEl.appendChild(wordItem);
            });
        }
        
        function showMessage(msg, isError = false) {
            let iconHTML = '';
            if (!isError) {
                if (msg.includes('æ­å–œ')) {
                    iconHTML = '<i class="fas fa-trophy mr-2"></i>';
                } else if (msg.includes('æ‰¾åˆ°äº†')) {
                    iconHTML = '<i class="fas fa-check-circle mr-2"></i>';
                } else {
                    iconHTML = '<i class="fas fa-info-circle mr-2"></i>';
                }
            } else {
                iconHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>';
            }
            
            messageArea.innerHTML = iconHTML + msg;
            messageArea.className = `text-center font-semibold mt-4 h-6 ${isError ? 'text-red-600' : 'text-green-600'}`;
            if (!isError) {
                setTimeout(() => {
                    if (messageArea.innerHTML === iconHTML + msg) messageArea.innerHTML = '';
                }, 3000);
            }
        }

        // --- Interaction Logic ---
        function handleCellClick(event) {
            const cell = event.target.closest('.grid-cell');
            if (!cell || wordsToFind.length === 0) return;

            // è§¸ç™¼ç”¨æˆ¶æ´»å‹•
            onUserActivity();

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            if (!firstClick) {
                // First click - select starting cell
                firstClick = { cell, row, col };
                cell.classList.add('first-click');
                showPotentialConnections(row, col);
                showMessage("é¸æ“‡çµæŸå­—æ¯", false);
                
                // ğŸµ æ’­æ”¾é¸æ“‡èµ·å§‹å­—æ¯éŸ³æ•ˆ
                soundSystem.play('selectStart');
            } else {
                // Second click - try to form a word
                const wordPath = getLinePath(firstClick.row, firstClick.col, row, col);
                if (wordPath.length > 1) {
                    checkSelectedWord(wordPath);
                    // ğŸµ æ’­æ”¾é»æ“ŠéŸ³æ•ˆ
                    soundSystem.play('click');
                } else {
                    // ğŸµ æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆç„¡æ•ˆé¸æ“‡ï¼‰
                    soundSystem.play('error');
                }
                clearClickSelection();
            }
        }

        function getLinePath(startRow, startCol, endRow, endCol) {
            const path = [];
            const dr = endRow - startRow;
            const dc = endCol - startCol;
            
            // Check if it's a valid straight line (horizontal, vertical, or diagonal)
            if (dr === 0 || dc === 0 || Math.abs(dr) === Math.abs(dc)) {
                const steps = Math.max(Math.abs(dr), Math.abs(dc));
                const stepR = steps === 0 ? 0 : dr / steps;
                const stepC = steps === 0 ? 0 : dc / steps;
                
                for (let i = 0; i <= steps; i++) {
                    path.push({
                        row: startRow + Math.round(i * stepR),
                        col: startCol + Math.round(i * stepC)
                    });
                }
            }
            return path;
        }

        function getCellAt(row, col) {
            return puzzleGrid.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        }

        function showPotentialConnections(startRow, startCol) {
            // Highlight potential ending positions for all words
            const directions = [
                { dr: 0, dc: 1 }, { dr: 0, dc: -1 },   // Horizontal
                { dr: 1, dc: 0 }, { dr: -1, dc: 0 },   // Vertical  
                { dr: 1, dc: 1 }, { dr: -1, dc: -1 },  // Diagonal
                { dr: 1, dc: -1 }, { dr: -1, dc: 1 }   // Diagonal
            ];

            wordsToFind.forEach(word => {
                if (foundWords.has(word)) return;
                
                directions.forEach(dir => {
                    const endRow = startRow + (word.length - 1) * dir.dr;
                    const endCol = startCol + (word.length - 1) * dir.dc;
                    
                    if (endRow >= 0 && endRow < gridSize && endCol >= 0 && endCol < gridSize) {
                        const endCell = getCellAt(endRow, endCol);
                        if (endCell) {
                            endCell.classList.add('potential');
                        }
                    }
                });
            });
        }

        function clearClickSelection() {
            if (firstClick) {
                firstClick.cell.classList.remove('first-click');
                firstClick = null;
            }
            // Clear potential highlights
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('potential', 'selected');
            });
        }

        function checkSelectedWord(wordPath) {
            if (wordPath.length < 2) return; // Need at least 2 letters

            // Reconstruct word from path
            let selectedWord = wordPath.map(pos => currentGrid[pos.row][pos.col]).join('');
            let reversedSelectedWord = selectedWord.split('').reverse().join('');

            wordsToFind.forEach(wordToFind => {
                if (!foundWords.has(wordToFind) && (selectedWord === wordToFind || reversedSelectedWord === wordToFind)) {
                    foundWords.add(wordToFind);
                    document.getElementById(`word-${wordToFind}`).classList.add('found');
                    
                    // Mark cells as part of a found word
                    wordPath.forEach(pos => {
                        const cell = getCellAt(pos.row, pos.col);
                        if (cell) cell.classList.add('found');
                    });
                    
                    // ğŸµ æ’­æ”¾æ‰¾åˆ°å–®å­—çš„éŸ³æ•ˆ
                    soundSystem.play('wordFound');
                    
                    if (foundWords.size === wordsToFind.length) {
                        // ğŸ† æ’­æ”¾éŠæˆ²å®ŒæˆéŸ³æ•ˆ
                        setTimeout(() => soundSystem.play('gameComplete'), 300);
                        showMessage("æ­å–œï¼æ‚¨æ‰¾åˆ°äº†æ‰€æœ‰å–®å­—ï¼", false);
                    } else {
                        showMessage(`æ‰¾åˆ°äº†: ${wordToFind}!`, false);
                    }
                }
            });
        }

        // æ´—ç‰Œé™£åˆ—ï¼ˆFisher-Yates æ¼”ç®—æ³•ï¼‰
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- æç¤ºç³»çµ± ---
        function resetInactivityTimer() {
            lastActivityTime = Date.now();
            clearTimeout(inactivityTimer);
            
            inactivityTimer = setTimeout(() => {
                showHint();
            }, hintTimeout);
        }

        function showHint() {
            // æ‰¾åˆ°é‚„æ²’æ‰¾åˆ°çš„å–®å­—
            const unfoundWords = wordsToFind.filter(word => !foundWords.has(word));
            
            if (unfoundWords.length === 0) return; // æ‰€æœ‰å–®å­—éƒ½æ‰¾åˆ°äº†
            
            // éš¨æ©Ÿé¸æ“‡ä¸€å€‹æœªæ‰¾åˆ°çš„å–®å­—
            const randomWord = unfoundWords[Math.floor(Math.random() * unfoundWords.length)];
            const wordInfo = wordPositions.get(randomWord);
            
            if (!wordInfo) return;
            
            // æ¸…é™¤ä¹‹å‰çš„æç¤º
            clearHint();
            
            // ğŸµ æ’­æ”¾æç¤ºéŸ³æ•ˆ
            soundSystem.play('hint');
            
            // é«˜äº®èµ·å§‹ä½ç½®
            const startCell = getCellAt(wordInfo.startPos.row, wordInfo.startPos.col);
            if (startCell) {
                startCell.classList.add('hint');
                currentHint = { cell: startCell, word: randomWord };
                
                // é¡¯ç¤ºæç¤ºè¨Šæ¯
                showHintMessage(`æç¤ºï¼šè©¦è©¦å¾é€™è£¡é–‹å§‹å°‹æ‰¾ "${randomWord}"!`);
                
                // åœ¨å–®å­—åˆ—è¡¨ä¸­é«˜äº®å°æ‡‰çš„å–®å­—
                const wordItem = document.getElementById(`word-${randomWord}`);
                if (wordItem) {
                    wordItem.style.backgroundColor = '#e0e7ff';
                    wordItem.style.borderColor = '#8b5cf6';
                    setTimeout(() => {
                        if (wordItem && !foundWords.has(randomWord)) {
                            wordItem.style.backgroundColor = '';
                            wordItem.style.borderColor = '';
                        }
                    }, 5000);
                }
            }
        }

        function clearHint() {
            if (currentHint) {
                currentHint.cell.classList.remove('hint');
                currentHint = null;
            }
        }

        function showHintMessage(message) {
            const hintDiv = document.createElement('div');
            hintDiv.className = 'hint-message';
            hintDiv.innerHTML = `<i class="fas fa-lightbulb mr-2"></i>${message.replace('ğŸ’¡ ', '')}`;
            document.body.appendChild(hintDiv);
            
            setTimeout(() => {
                if (hintDiv.parentNode) {
                    hintDiv.parentNode.removeChild(hintDiv);
                }
            }, 3000);
        }

        function onUserActivity() {
            clearHint();
            resetInactivityTimer();
        }

        // --- Event Listeners ---
        // Click interaction for word selection
        puzzleGrid.addEventListener('click', handleCellClick);

        // ç›£è½å„ç¨®ç”¨æˆ¶æ´»å‹•ä»¥é‡ç½®æç¤ºè¨ˆæ™‚å™¨
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keydown', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        puzzleGrid.addEventListener('mouseover', resetInactivityTimer);

        // --- Initialize Application ---
        async function initializeApp() {
            try {
                // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
                loadingIndicator.style.display = 'block';
                messageArea.textContent = '';

                // å¾ Google Sheet è¼‰å…¥è³‡æ–™
                const vocabularyData = await loadSheetData();
                
                // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
                loadingIndicator.style.display = 'none';
                
                // é¡¯ç¤ºé›£åº¦é¸æ“‡æˆ–ç›´æ¥é–‹å§‹éŠæˆ²
                showDifficultySelection(vocabularyData);
                
                // å•Ÿå‹•æç¤ºç³»çµ±
                resetInactivityTimer();
                
            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±æ•—:", error);
                loadingIndicator.style.display = 'none';
                showMessage(error.message, true);
                
                // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯å’Œèªªæ˜
                messageArea.innerHTML = `
                    <div class="text-red-600 mb-2 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>${error.message}
                    </div>
                    <div class="text-slate-500 text-sm flex items-center justify-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        è«‹ç¢ºèªURLåŒ…å«æ­£ç¢ºçš„labelåƒæ•¸ï¼Œä¾‹å¦‚ï¼š<br>
                        <code class="bg-slate-100 px-1 rounded">?label=toeic</code>
                    </div>
                `;
            }
        }

        // è™•ç†çª—å£å¤§å°è®ŠåŒ–
        function handleWindowResize() {
            // å¦‚æœéŠæˆ²æ­£åœ¨é€²è¡Œä¸­ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦èª¿æ•´
            if (wordsToFind.length > 0) {
                const maxWords = getRecommendedMaxWords();
                const currentWords = wordsToFind.length;
                
                // å¦‚æœç•¶å‰å–®å­—æ•¸é‡è¶…éæ¨è–¦æ•¸é‡å¤ªå¤šï¼Œæç¤ºç”¨æˆ¶
                if (currentWords > maxWords * 1.5) {
                    const shouldRestart = confirm(
                        `åµæ¸¬åˆ°è¢å¹•å°ºå¯¸è®ŠåŒ–ã€‚ç•¶å‰éŠæˆ²æœ‰ ${currentWords} å€‹å–®å­—ï¼Œ` +
                        `å»ºè­°åœ¨æ­¤è¢å¹•å°ºå¯¸ä¸‹ä½¿ç”¨ ${maxWords} å€‹å–®å­—ä»¥ç²å¾—æ›´å¥½é«”é©—ã€‚\n\n` +
                        `æ˜¯å¦è¦é‡æ–°é–‹å§‹ä¸¦èª¿æ•´å–®å­—æ•¸é‡ï¼Ÿ`
                    );
                    
                    if (shouldRestart) {
                        location.reload(); // é‡æ–°è¼‰å…¥é é¢
                    }
                }
            }
        }

        // ç›£è½çª—å£å¤§å°è®ŠåŒ–
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleWindowResize, 500); // é˜²æŠ–è™•ç†
        });

        // --- Toggle åŠŸèƒ½ ---
        function initializeHelpToggle() {
            const helpToggleBtn = document.getElementById('helpToggleBtn');
            const helpContent = document.getElementById('helpContent');
            
            helpToggleBtn.addEventListener('click', function() {
                // ğŸµ æ’­æ”¾é»æ“ŠéŸ³æ•ˆ
                soundSystem.play('click');
                
                const isExpanded = helpContent.classList.contains('expanded');
                
                if (isExpanded) {
                    // æ”¶åˆèªªæ˜
                    helpContent.classList.remove('expanded');
                    helpToggleBtn.classList.remove('expanded');
                } else {
                    // å±•é–‹èªªæ˜
                    helpContent.classList.add('expanded');
                    helpToggleBtn.classList.add('expanded');
                }
            });
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeApp);
        document.addEventListener('DOMContentLoaded', initializeHelpToggle);
    </script>
</body>
</html>