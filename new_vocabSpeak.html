<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—ç™¼éŸ³ç·´ç¿’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .feedback { 
            min-height: 60px; /* Adjusted min-height for feedback area */
            transition: all 0.3s ease-in-out;
        }
        #recognitionResult {
            min-height: 3em;
        }
        /* Custom focus rings for better visibility */
        input:focus, button:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Tailwind's blue-500 equivalent */
        }
        /* Styling for word list buttons */
        .word-button {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .word-button:hover {
            transform: translateY(-1px);
        }
        .word-button:active {
            transform: translateY(0px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-100 to-indigo-100 flex flex-col items-center justify-center min-h-screen p-4 text-gray-800">
    <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-500">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-500 to-indigo-600">
                ç™¼éŸ³ç·´ç¿’åŠ©æ‰‹
            </h1>
            <p class="text-sm text-gray-500 mt-1">ç·´ç¿’æ‚¨çš„è‹±æ–‡å–®å­—ç™¼éŸ³</p>
        </header>

        <div class="mb-5">
            <label for="targetWord" class="block text-sm font-medium text-gray-700 mb-1">ç›®æ¨™å–®å­—:</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="targetWord" value="medal" class="flex-grow mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-base p-2.5">
                <button id="playTargetWord" title="æ’­æ”¾ç›®æ¨™å–®å­—" class="p-2.5 bg-sky-500 text-white rounded-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" /></svg>
                </button>
            </div>
        </div>

        <div class="space-y-3 mb-5">
            <button id="startRecognition" class="w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors flex items-center justify-center text-base">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 0 1-3-3V4.5a3 3 0 1 1 6 0v8.25a3 3 0 0 1-3 3Z" /></svg>
                é–‹å§‹ç™¼éŸ³
            </button>
            <button id="stopRecognition" class="w-full bg-red-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors hidden flex items-center justify-center text-base">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-9a2.25 2.25 0 0 1-2.25-2.25v-9Z" /></svg>
                åœæ­¢ç™¼éŸ³
            </button>
        </div>

        <div class="mt-5 p-4 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-lg font-medium text-gray-700 mb-1">è¾¨è­˜çµæœ:</h2>
            <p id="recognitionResult" class="text-gray-600 p-2 border border-gray-200 rounded-md bg-white"></p>
        </div>

        <div class="mt-4">
            <h2 class="text-lg font-medium text-gray-700 mb-1">å›é¥‹:</h2>
            <div id="feedback" class="feedback p-3 rounded-md text-base border border-transparent"></div>
        </div>

        <div id="wordListContainer" class="mt-6 pt-4 border-t border-gray-200">
             <h3 class="text-base font-semibold text-gray-700 mb-3">è©¦è©¦çœ‹é€™äº›å–®å­—:</h3>
             <div id="wordListButtons" class="flex flex-wrap gap-2">
                <!-- Example words will be populated by JS -->
             </div>
        </div>
    </div>

    <footer class="text-center mt-8 mb-4 text-xs text-gray-500">
        <p>ä½¿ç”¨ Azure Speech API | å–®å­—èªéŸ³è¾¨è­˜ä»æœ‰èª¤å·®ï¼Œè­˜åˆ¥çµæœåƒ…ä¾›å­¸ç¿’åƒè€ƒ</p>
    </footer>

    <script>
        // ====== Azure Speech API åƒæ•¸ ======
        const AZURE_SPEECH_KEY = "F3FER7g0BSWfiZTFWOXtW1tezbx9vnTgPE5MbeW1NVezZX4yKDFoJQQJ99BDACYeBjFXJ3w3AAAYACOGAQO2"; // TODO: è«‹å¡«å…¥ä½ çš„ Azure Speech Key
        const AZURE_SPEECH_REGION = "eastus"; // TODO: è«‹å¡«å…¥ä½ çš„ Azure Region
        // ===================================
        document.addEventListener('DOMContentLoaded', () => {
            const targetWordInput = document.getElementById('targetWord');
            const playTargetWordButton = document.getElementById('playTargetWord');
            const startRecognitionButton = document.getElementById('startRecognition');
            const stopRecognitionButton = document.getElementById('stopRecognition');
            const recognitionResultP = document.getElementById('recognitionResult');
            const feedbackDiv = document.getElementById('feedback');
            const wordListButtonsDiv = document.getElementById('wordListButtons');

            // æ–°å¢å€’æ•¸èˆ‡å‹•ç•«å€å¡Š
            let countdownInterval = null;
            let mediaRecorder = null;
            let audioChunks = [];
            let isRecording = false;
            let azureRecognizer = null;
            let isRecognizing = false;
            let countdownDiv = null;

            let currentTargetWord = targetWordInput.value.trim().toLowerCase();

            // æ–°å¢å€’æ•¸UI
            function showCountdown(seconds) {
                if (!countdownDiv) {
                    countdownDiv = document.createElement('div');
                    countdownDiv.id = 'countdownDiv';
                    countdownDiv.className = 'flex flex-col items-center justify-center my-4';
                    startRecognitionButton.parentElement.insertBefore(countdownDiv, startRecognitionButton);
                }
                if (typeof seconds === 'string') {
                    countdownDiv.innerHTML = `<div class='text-2xl font-bold text-sky-600 animate-pulse'>${seconds}</div><div class='text-sm text-gray-500 mt-1'>è«‹æº–å‚™å¥½ç™¼éŸ³...</div>`;
                } else {
                    countdownDiv.innerHTML = `<div class='text-3xl font-bold text-sky-600 animate-pulse'>${seconds}</div><div class='text-sm text-gray-500 mt-1'>è«‹åœ¨å€’æ•¸å…§ç™¼éŸ³...</div>`;
                }
                countdownDiv.style.display = '';
            }
            function updateCountdown(seconds) {
                if (countdownDiv) {
                    if (typeof seconds === 'string') {
                        countdownDiv.innerHTML = `<div class='text-2xl font-bold text-sky-600 animate-pulse'>${seconds}</div><div class='text-sm text-gray-500 mt-1'>è«‹æº–å‚™å¥½ç™¼éŸ³...</div>`;
                    } else {
                        countdownDiv.innerHTML = `<div class='text-3xl font-bold text-sky-600 animate-pulse'>${seconds}</div><div class='text-sm text-gray-500 mt-1'>è«‹åœ¨å€’æ•¸å…§ç™¼éŸ³...</div>`;
                    }
                }
            }
            function hideCountdown() {
                if (countdownDiv) countdownDiv.style.display = 'none';
            }

            targetWordInput.addEventListener('input', () => {
                currentTargetWord = targetWordInput.value.trim().toLowerCase();
                feedbackDiv.innerHTML = '';
                feedbackDiv.className = 'feedback p-3 rounded-md text-base border border-transparent';
                recognitionResultP.textContent = '';
            });

            // ä¿ç•™ TTS
            const speechSynthesis = window.speechSynthesis;
            if (!speechSynthesis) {
                const noTTSWarning = document.createElement('p');
                noTTSWarning.className = 'text-yellow-600 bg-yellow-100 border-yellow-500 border p-3 rounded-md mb-2';
                noTTSWarning.textContent = 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆï¼Œéƒ¨åˆ†æ’­æ”¾åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚';
                targetWordInput.parentElement.parentElement.insertBefore(noTTSWarning, targetWordInput.parentElement);
                if(playTargetWordButton) playTargetWordButton.disabled = true;
                if(playTargetWordButton) playTargetWordButton.classList.add('opacity-50', 'cursor-not-allowed');
            }

            // Expanded and categorized confusing pairs
            const confusingPairs = {
                "medal": ["meadow", "metal", "middle", "meddle"],
                "meadow": ["medal"],
                "affect": ["effect"],
                "effect": ["affect"],
                "desert": ["dessert"], // desert (n. /ËˆdÉ›zÉ™rt/), desert (v. /dÉªËˆzÉœËrt/)
                "dessert": ["desert"], // /dÉªËˆzÉœËrt/
                "accept": ["except", "expect"],
                "except": ["accept", "expect"],
                "advice": ["advise"], // /É™dËˆvaÉªs/ (n.)
                "advise": ["advice"], // /É™dËˆvaÉªz/ (v.)
                "weather": ["whether", "wether"],
                "whether": ["weather", "wether"],
                "lead": ["led"],      // lead (v. /liËd/), lead (n. /lÉ›d/)
                "led": ["lead"],      // /lÉ›d/
                "read": ["red"],      // read (pres. /riËd/), read (past /rÉ›d/)
                "red": ["read"],      // /rÉ›d/
                "live": ["leave"],    // live (v. /lÉªv/), live (adj. /laÉªv/)
                "leave": ["live"],    // /liËv/
                "lose": ["loose"],    // /luËz/
                "loose": ["lose"],    // /luËs/
                "principal": ["principle"],
                "principle": ["principal"],
                "quiet": ["quite", "quit"],
                "quite": ["quiet", "quit"],
                "then": ["than"],
                "than": ["then"],
                "their": ["there", "they're"],
                "there": ["their", "they're"],
                "they're": ["their", "there"],
                "to": ["too", "two"],
                "too": ["to", "two"],
                "two": ["to", "too"],
                "allowed": ["aloud"],
                "aloud": ["allowed"],
                "sell": ["cell"],
                "cell": ["sell"]
            };

            const exampleWords = [
                { word: "medal", tip: "çç‰Œ" }, { word: "meadow", tip: "è‰åœ°" },
                { word: "affect", tip: "å½±éŸ¿ (v)" }, { word: "effect", tip: "æ•ˆæœ (n)" },
                { word: "desert", tip: "æ²™æ¼  (n)" }, { word: "dessert", tip: "ç”œé» (n)" },
                { word: "accept", tip: "æ¥å— (v)" }, { word: "except", tip: "é™¤äº† (prep)" },
                { word: "advice", tip: "å¿ å‘Š (n)" }, { word: "advise", tip: "å‹¸å‘Š (v)" },
                { word: "weather", tip: "å¤©æ°£ (n)" }, { word: "whether", tip: "æ˜¯å¦ (conj)" },
                { word: "live", tip: "/lÉªv/ å±…ä½ (v)"}, { word: "live", tip: "/laÉªv/ ç¾å ´çš„ (adj)"},
                { word: "read", tip: "/riËd/ é–±è®€ (v ç¾åœ¨å¼)"}, { word: "read", tip: "/rÉ›d/ é–±è®€ (v éå»å¼)"},
                { word: "lead", tip: "/liËd/ å¼•å° (v)"}, { word: "lead", tip: "/lÉ›d/ é‰› (n)"},
                { word: "lose", tip: "/luËz/ å¤±å» (v)" }, { word: "loose", tip: "/luËs/ é¬†çš„ (adj)"},
                { word: "principal", tip: "æ ¡é•·ï¼›ä¸»è¦çš„" }, { word: "principle", tip: "åŸå‰‡ï¼›åŸç†" },
                { word: "quiet", tip: "å®‰éœçš„" }, { word: "quite", tip: "ç›¸ç•¶ï¼›é —" },
                { word: "allowed", tip: "å…è¨±" }, { word: "aloud", tip: "å¤§è²åœ°" },
            ];

            function populateExampleWords() {
                wordListButtonsDiv.innerHTML = ''; // Clear existing buttons
                exampleWords.forEach(item => {
                    const button = document.createElement('button');
                    button.textContent = `${item.word} (${item.tip})`;
                    button.className = 'word-button bg-gray-200 hover:bg-sky-200 text-gray-700 text-xs sm:text-sm py-1.5 px-3 rounded-full shadow-sm hover:shadow-md';
                    button.title = `ç·´ç¿’ç™¼éŸ³: ${item.word}`;
                    button.addEventListener('click', () => {
                        targetWordInput.value = item.word;
                        currentTargetWord = item.word.toLowerCase();
                        feedbackDiv.innerHTML = '';
                        feedbackDiv.className = 'feedback p-3 rounded-md text-base border border-transparent';
                        recognitionResultP.textContent = '';
                        if (speechSynthesis) speak(currentTargetWord);
                    });
                    wordListButtonsDiv.appendChild(button);
                });
            }
            
            function speak(text, lang = 'en-US', onEndCallback = null) {
                if (!speechSynthesis || !text) return;
                speechSynthesis.cancel(); // Cancel any previous speech

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = 0.85; // Slightly slower for clarity
                utterance.pitch = 1.0;

                // Very basic phonetic distinction attempt for known homographs - often TTS dependent
                if (text === "read" && currentTargetWord === "read") { // If user picked from examples that might be past-tense
                    // This is a heuristic. If the *input field* value is "read", we can't know which one.
                    // If exampleWords contains "read" (/rÉ›d/), we could try to hint the TTS, but standard API has no direct phonetic input.
                    // Some TTS engines might interpret "I read that book yesterday" correctly.
                }


                if (onEndCallback && typeof onEndCallback === 'function') {
                    utterance.onend = onEndCallback;
                }
                speechSynthesis.speak(utterance);
            }

            if (playTargetWordButton) {
                playTargetWordButton.addEventListener('click', () => {
                    currentTargetWord = targetWordInput.value.trim().toLowerCase();
                    if (currentTargetWord && speechSynthesis) {
                        speak(currentTargetWord);
                    } else if (!currentTargetWord) {
                        feedbackDiv.innerHTML = '<p class="text-yellow-600 bg-yellow-100 border-yellow-500 border p-2 rounded-md">è«‹å…ˆè¼¸å…¥ç›®æ¨™å–®å­—ã€‚</p>';
                        feedbackDiv.className = 'feedback p-3 rounded-md text-base border-yellow-500 bg-yellow-100';
                    }
                });
            }

            // === éŒ„éŸ³èˆ‡å€’æ•¸ ===
            function startRecordingWithCountdown() {
                if (!AZURE_SPEECH_KEY || !AZURE_SPEECH_REGION) {
                    feedbackDiv.innerHTML = '<p class="text-red-600 bg-red-100 border-red-500 border p-2 rounded-md">è«‹å…ˆè¨­å®š Azure Speech Key èˆ‡ Regionï¼</p>';
                    feedbackDiv.className = 'feedback p-3 rounded-md text-base border-red-500 bg-red-100';
                    return;
                }
                if (!navigator.mediaDevices || !window.MediaRecorder) {
                    feedbackDiv.innerHTML = '<p class="text-red-600 bg-red-100 border-red-500 border p-2 rounded-md">æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³åŠŸèƒ½ï¼Œè«‹æ”¹ç”¨ Chromeã€Edgeã€Firefox æˆ–æ–°ç‰ˆ Safariã€‚</p>';
                    feedbackDiv.className = 'feedback p-3 rounded-md text-base border-red-500 bg-red-100';
                    return;
                }
                if (isRecording) return;
                const oldReplayDiv = document.getElementById('replayAudioDiv');
                if (oldReplayDiv && oldReplayDiv.parentElement) {
                    oldReplayDiv.parentElement.removeChild(oldReplayDiv);
                }
                isRecording = true;
                audioChunks = [];
                recognitionResultP.textContent = 'ğŸ¤ æ­£åœ¨éŒ„éŸ³...';
                feedbackDiv.innerHTML = '';
                feedbackDiv.className = 'feedback p-3 rounded-md text-base border border-transparent';
                startRecognitionButton.classList.add('hidden');
                stopRecognitionButton.classList.remove('hidden');
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = e => {
                        if (e.data.size > 0) audioChunks.push(e.data);
                    };
                    mediaRecorder.onstop = () => {
                        stream.getTracks().forEach(track => track.stop());
                        hideCountdown();
                        isRecording = false;
                        startRecognitionButton.classList.remove('hidden');
                        stopRecognitionButton.classList.add('hidden');
                        if (audioChunks.length > 0) {
                            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                            processAudioBlob(audioBlob);
                        } else {
                            recognitionResultP.textContent = 'æ²’æœ‰éŒ„åˆ°è²éŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚';
                        }
                    };
                    mediaRecorder.start();
                    let countdownStep = 0;
                    showCountdown('è«‹æº–å‚™');
                    countdownInterval = setInterval(() => {
                        countdownStep++;
                        if (countdownStep === 1) {
                            updateCountdown(3);
                        } else if (countdownStep === 2) {
                            updateCountdown(2);
                        } else if (countdownStep === 3) {
                            updateCountdown(1);
                        } else if (countdownStep === 4) {
                            clearInterval(countdownInterval);
                            if (mediaRecorder && mediaRecorder.state === 'recording') {
                                mediaRecorder.stop();
                            }
                        }
                    }, 1000);
                }).catch(err => {
                    isRecording = false;
                    hideCountdown();
                    startRecognitionButton.classList.remove('hidden');
                    stopRecognitionButton.classList.add('hidden');
                    recognitionResultP.textContent = '';
                    feedbackDiv.innerHTML = `<p class='text-red-700'>éº¥å…‹é¢¨å•Ÿå‹•å¤±æ•—ï¼š${err}</p>`;
                    feedbackDiv.className = 'feedback p-3 rounded-md text-base border-red-500 bg-red-100';
                });
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                if (countdownInterval) clearInterval(countdownInterval);
                hideCountdown();
                isRecording = false;
                startRecognitionButton.classList.remove('hidden');
                stopRecognitionButton.classList.add('hidden');
            }

            // WAV ç·¨ç¢¼
            function encodeWAV(audioBuffer) {
                const numChannels = audioBuffer.numberOfChannels;
                const sampleRate = audioBuffer.sampleRate;
                const format = 1; // PCM
                const bitDepth = 16;
                let samples;
                if (numChannels === 2) {
                    // è½‰ç‚º interleaved
                    const l = audioBuffer.getChannelData(0);
                    const r = audioBuffer.getChannelData(1);
                    samples = new Float32Array(l.length * 2);
                    for (let i = 0; i < l.length; i++) {
                        samples[i * 2] = l[i];
                        samples[i * 2 + 1] = r[i];
                    }
                } else {
                    samples = audioBuffer.getChannelData(0);
                }
                const buffer = new ArrayBuffer(44 + samples.length * 2);
                const view = new DataView(buffer);
                // RIFF identifier 'RIFF'
                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + samples.length * 2, true);
                writeString(view, 8, 'WAVE');
                // fmt chunk
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true); // chunk size
                view.setUint16(20, format, true); // PCM
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * numChannels * bitDepth / 8, true);
                view.setUint16(32, numChannels * bitDepth / 8, true);
                view.setUint16(34, bitDepth, true);
                // data chunk
                writeString(view, 36, 'data');
                view.setUint32(40, samples.length * 2, true);
                // PCM samples
                floatTo16BitPCM(view, 44, samples);
                return new Blob([view], { type: 'audio/wav' });
            }
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            function floatTo16BitPCM(view, offset, input) {
                for (let i = 0; i < input.length; i++, offset += 2) {
                    let s = Math.max(-1, Math.min(1, input[i]));
                    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                }
            }

            // å°‡éŒ„éŸ³ blob è½‰ç‚º wav ä¸¦é€ Azure
            function processAudioBlob(blob) {
                console.log('[DEBUG] audioBlob:', blob);
                console.log('[DEBUG] audioBlob type:', blob.type, 'size:', blob.size);
                const reader = new FileReader();
                reader.onload = function() {
                    const arrayBuffer = reader.result;
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    audioContext.decodeAudioData(arrayBuffer).then(audioBuffer => {
                        console.log('[DEBUG] audioBuffer:', audioBuffer);
                        const wavBlob = encodeWAV(audioBuffer);
                        console.log('[DEBUG] wavBlob:', wavBlob);
                        console.log('[DEBUG] wavBlob type:', wavBlob.type, 'size:', wavBlob.size);
                        wavBlob.arrayBuffer().then(buffer => {
                            const header = new Uint8Array(buffer.slice(0, 44));
                            console.log('[DEBUG] WAV header:', header);
                            // æª¢æŸ¥ RIFF/WAVE æ¨™é ­
                            const riff = String.fromCharCode.apply(null, header.slice(0,4));
                            const wave = String.fromCharCode.apply(null, header.slice(8,12));
                            if (riff !== 'RIFF' || wave !== 'WAVE') {
                                feedbackDiv.innerHTML = `<p class='text-red-700'>WAV æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼ˆç¼ºå°‘ RIFF/WAVE æ¨™é ­ï¼‰ï¼Œè«‹æª¢æŸ¥éŒ„éŸ³æµç¨‹ã€‚</p>`;
                                feedbackDiv.className = 'feedback p-3 rounded-md text-base border-red-500 bg-red-100';
                                return;
                            }
                            if (wavBlob.size < 1000) {
                                feedbackDiv.innerHTML = `<p class='text-red-700'>WAV æª”æ¡ˆå¤ªå°ï¼Œå¯èƒ½æ²’æœ‰éŒ„åˆ°è²éŸ³ã€‚</p>`;
                                feedbackDiv.className = 'feedback p-3 rounded-md text-base border-red-500 bg-red-100';
                                return;
                            }
                            // é¡¯ç¤ºéŒ„éŸ³é‡æ’­æ’­æ”¾å™¨
                            showReplayAudio(wavBlob);
                            sendToAzure(wavBlob);
                        });
                    }).catch(err => {
                        recognitionResultP.textContent = '';
                        feedbackDiv.innerHTML = `<p class='text-red-700'>éŸ³è¨Šè§£ç¢¼å¤±æ•—ï¼š${err}</p>`;
                        feedbackDiv.className = 'feedback p-3 rounded-md text-base border-red-500 bg-red-100';
                    });
                };
                reader.readAsArrayBuffer(blob);
            }

            // é¡¯ç¤ºéŒ„éŸ³é‡æ’­æ’­æ”¾å™¨
            function showReplayAudio(wavBlob) {
                let replayDiv = document.getElementById('replayAudioDiv');
                if (!replayDiv) {
                    replayDiv = document.createElement('div');
                    replayDiv.id = 'replayAudioDiv';
                    replayDiv.className = 'my-4 flex flex-col items-center';
                    recognitionResultP.parentElement.insertBefore(replayDiv, recognitionResultP.nextSibling);
                }
                // æ¸…ç©ºå…§å®¹ï¼Œåƒ…ä¿ç•™æœ€æ–°ä¸€æ¬¡
                replayDiv.innerHTML = '';
                const label = document.createElement('div');
                label.className = 'text-sm text-gray-600 mb-1';
                label.textContent = 'ğŸ”Š ä½ å‰›å‰›çš„éŒ„éŸ³ï¼š';
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = URL.createObjectURL(wavBlob);
                audio.style.width = '100%';
                replayDiv.appendChild(label);
                replayDiv.appendChild(audio);
            }

            // Azure Speech è¾¨è­˜
            function sendToAzure(wavBlob) {
                isRecognizing = true;
                recognitionResultP.textContent = 'â³ èªéŸ³è¾¨è­˜ä¸­...';
                try {
                    const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(AZURE_SPEECH_KEY, AZURE_SPEECH_REGION);
                    speechConfig.speechRecognitionLanguage = 'en-US';
                    speechConfig.outputFormat = SpeechSDK.OutputFormat.Detailed;
                    // å°‡ Blob åŒ…è£æˆ File
                    const wavFile = new File([wavBlob], 'record.wav', { type: 'audio/wav' });
                    const audioConfig = SpeechSDK.AudioConfig.fromWavFileInput(wavFile);
                    azureRecognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
                    azureRecognizer.recognizeOnceAsync(result => {
                        isRecognizing = false;
                        // å–å¾—å®Œæ•´ JSON çµæœä¸¦è¼¸å‡º
                        try {
                            const jsonResult = result.properties.getProperty(SpeechSDK.PropertyId.SpeechServiceResponse_JsonResult);
                            if (jsonResult) {
                                console.log('[Azure Speech JSON å›å‚³]', JSON.parse(jsonResult));
                            }
                        } catch (e) {
                            console.warn('ç„¡æ³•è§£æ Azure Speech JSON çµæœ', e);
                        }
                        if (result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                            const recognizedText = result.text.trim().toLowerCase().replace(/\.$/, '');
                            let nBestList = undefined;
                            try {
                                const jsonResult = result.properties.getProperty(SpeechSDK.PropertyId.SpeechServiceResponse_JsonResult);
                                if (jsonResult) {
                                    const parsed = JSON.parse(jsonResult);
                                    if (parsed.NBest) nBestList = parsed.NBest;
                                }
                            } catch (e) {}
                            recognitionResultP.textContent = `ä½ èªªçš„æ˜¯: "${recognizedText}"`;
                            handleRecognitionResult(recognizedText, nBestList);
                        } else if (result.reason === SpeechSDK.ResultReason.NoMatch) {
                            recognitionResultP.textContent = 'æ²’æœ‰è½åˆ°è²éŸ³ï¼Œæˆ–è¾¨è­˜å¤±æ•—ã€‚';
                        } else {
                            recognitionResultP.textContent = 'è¾¨è­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚';
                        }
                        azureRecognizer.close();
                        azureRecognizer = null;
                    }, err => {
                        isRecognizing = false;
                        recognitionResultP.textContent = '';
                        feedbackDiv.innerHTML = `<p class='text-red-700'>Azure Speech API éŒ¯èª¤ï¼š${err}</p>`;
                        feedbackDiv.className = 'feedback p-3 rounded-md text-base border-red-500 bg-red-100';
                        if (azureRecognizer) azureRecognizer.close();
                        azureRecognizer = null;
                    });
                } catch (error) {
                    isRecognizing = false;
                    recognitionResultP.textContent = '';
                    feedbackDiv.innerHTML = `<p class='text-red-700'>ç„¡æ³•å•Ÿå‹• Azure Speech SDKï¼š${error}</p>`;
                    feedbackDiv.className = 'feedback p-3 rounded-md text-base border-red-500 bg-red-100';
                    if (azureRecognizer) azureRecognizer.close();
                    azureRecognizer = null;
                }
            }

            function handleRecognitionResult(recognizedText, nBestList) {
                // nBestList: NBest é™£åˆ—ï¼Œè‹¥æœ‰
                const target = currentTargetWord;
                let isCorrect = false;
                let nbestHasTarget = false;
                let nbestHtml = '';
                if (recognizedText === target) {
                    isCorrect = true;
                } else if (Array.isArray(nBestList)) {
                    // æª¢æŸ¥ NBest å…§æ˜¯å¦æœ‰ç›®æ¨™å–®å­—
                    nbestHasTarget = nBestList.some((item, idx) => idx > 0 && item.Lexical && item.Lexical.toLowerCase() === target);
                    // ç”¢ç”Ÿ NBest æ¸…å–®
                    nbestHtml = `<div class='mt-2'><div class='font-semibold text-gray-700 mb-1'>å€™é¸è¾¨è­˜ï¼š</div><ul class='list-disc pl-5'>`;
                    nBestList.forEach((item, idx) => {
                        if (item.Lexical && item.Lexical.trim() !== '') {
                            nbestHtml += `<li>${item.Lexical} <span class='text-xs text-gray-500'>(ä¿¡å¿ƒåº¦: ${(item.Confidence*100).toFixed(2)}%)</span></li>`;
                        }
                    });
                    nbestHtml += '</ul></div>';
                }
                // UI é¡¯ç¤º
                if (isCorrect) {
                    feedbackDiv.innerHTML = `<p class="text-green-700 font-semibold">å¤ªæ£’äº†ï¼ç™¼éŸ³æ­£ç¢ºï¼ <span class="text-2xl">âœ…</span></p>`;
                    feedbackDiv.className = 'feedback p-3 rounded-md text-base border-green-500 bg-green-100';
                } else if (nbestHasTarget) {
                    feedbackDiv.innerHTML = `${nbestHtml}<p class="text-green-700 font-semibold mt-2">å¤ªæ£’äº†ï¼ç™¼éŸ³æ­£ç¢ºï¼ï¼ˆåœ¨å€™é¸ä¸­ï¼‰<span class="text-2xl">âœ…</span></p>`;
                    feedbackDiv.className = 'feedback p-3 rounded-md text-base border-green-500 bg-green-100';
                } else {
                    feedbackDiv.innerHTML = `${nbestHtml}<p class="text-red-700 font-semibold mt-2">ç™¼éŸ³ä¸æ­£ç¢º <span class="text-2xl">âŒ</span></p>`;
                    feedbackDiv.className = 'feedback p-3 rounded-md text-base border-red-500 bg-red-100';
                }
            }

            // ç¶å®šæŒ‰éˆ•
            startRecognitionButton.addEventListener('click', startRecordingWithCountdown);
            stopRecognitionButton.addEventListener('click', stopRecording);

            populateExampleWords();
            if (targetWordInput.value) { // Initialize currentTargetWord from input field
                currentTargetWord = targetWordInput.value.trim().toLowerCase();
            }
        });
    </script>
</body>
</html> 